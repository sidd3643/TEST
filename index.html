<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intimate Sparks: Complete Secured Vault</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <!-- Lucide Icons & PeerJS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- NEW: Crypto-JS for client-side encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- GLOBAL STYLES --- */
        :root {
            --bg-color: #1a0505;
            --bg-grad: #3f0e0e;
            --accent-color: #9f1239;
            --dark-accent-color: #881337;
            --glass-rgb: 50, 5, 5;
            --text-color: #fce7f3;
            --card-front-1: #1a0505;
            --card-front-2: #3f0e0e;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; transition: background-color 0.8s ease, color 0.5s ease; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .fancy-font { font-family: 'Playfair Display', serif; }
        .script-font { font-family: 'Dancing Script', cursive; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, var(--bg-grad) 0%, var(--bg-color) 100%); z-index: -5; transition: background 0.8s ease; }
        .glass-panel { 
            background: rgba(var(--glass-rgb), 0.95); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.12); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6); 
            border-radius: 1.5rem; 
            transition: all 0.3s ease; 
        }
        .input-glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: white; outline: none; transition: all 0.2s; }
        .input-glass:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .btn-gradient { background: linear-gradient(135deg, var(--accent-color) 0%, var(--dark-accent-color) 100%); box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--accent-rgb), 0.5); }
        .game-card { transition: all 0.4s ease; cursor: pointer; position: relative; overflow: hidden; }
        .game-card:hover { transform: translateY(-5px) scale(1.02); border-color: var(--accent-color); background: rgba(255, 255, 255, 0.1); }
        
        /* MOVIE PICKER STYLES (UPDATED FOR CLEANER MOBILE UI) */
        .genre-btn { 
            text-align: left; 
            padding: 12px 16px; /* Reduced padding for mobile density */
            border-radius: 10px; 
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.05); 
            background: rgba(0,0,0,0.2); 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 14px; /* Smaller font */
        }
        .genre-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(3px); }
        .genre-btn.active { 
            background: linear-gradient(90deg, rgba(190, 24, 93, 0.2) 0%, transparent 100%); 
            border-left: 4px solid var(--accent-color); 
            border-color: rgba(190, 24, 93, 0.5); 
            font-weight: bold; 
            padding-left: 20px; 
        }
        .movie-result-card { animation: fadeInUp 0.6s ease-out forwards; }
        .filter-panel-group {
             max-height: 200px; /* Constrained height for better stacking on mobile */
             overflow-y: auto;
             padding-right: 8px;
        }

        /* COUPONS */
        .coupon-card { background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0V0zm10 17l-7-7 7-7 7 7-7 7z' fill='%23ffffff' fill-opacity='0.05'/%3E%3C/svg%3E"); border: 2px dashed rgba(255,255,255,0.3); position: relative; transition: all 0.3s ease; }
        .coupon-card.locked { opacity: 1; }
        .coupon-card.won { border: 2px solid #4ade80; background: rgba(74, 222, 128, 0.15); filter: grayscale(0); opacity: 1; }
        .coupon-hole { width: 20px; height: 20px; background: var(--bg-color); border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); }
        .target-badge { font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.05em; text-transform: uppercase; }
        .target-her { background: #be185d; color: white; }
        .target-him { background: #1e40af; color: white; }
        .target-both { background: #7e22ce; color: white; }

        /* MYSTERY CARD DICE (FIXED) */
        .mystery-dice-box { width: 80px; height: 80px; background: #ffffff; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: #1a1a1a; box-shadow: 0 10px 25px rgba(0,0,0,0.5), inset 0 -5px 10px rgba(0,0,0,0.1); border: 2px solid #e11d48; cursor: pointer; transition: transform 0.2s; z-index: 50; }
        .mystery-dice-box:active { transform: scale(0.95); }
        .mystery-dice-rolling { animation: mysteryShake 0.5s infinite; }
        @keyframes mysteryShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }

        /* MONOPOLY DICE (3D) */
        .scene { width: 60px; height: 60px; perspective: 400px; display: inline-block; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-30px); transition: transform 1s; }
        .cube.show-1 { transform: translateZ(-30px) rotateY(0deg); }
        .cube.show-2 { transform: translateZ(-30px) rotateY(-90deg); }
        .cube.show-3 { transform: translateZ(-30px) rotateY(-180deg); }
        .cube.show-4 { transform: translateZ(-30px) rotateY(90deg); }
        .cube.show-5 { transform: translateZ(-30px) rotateX(-90deg); }
        .cube.show-6 { transform: translateZ(-30px) rotateX(90deg); }
        .cube__face { position: absolute; width: 60px; height: 60px; border: 2px solid #be185d; line-height: 60px; font-size: 20px; font-weight: bold; color: #be185d; text-align: center; background: white; border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .cube__face--1 { transform: rotateY(0deg) translateZ(30px); }
        .cube__face--2 { transform: rotateY(90deg) translateZ(30px); }
        .cube__face--3 { transform: rotateY(180deg) translateZ(30px); }
        .cube__face--4 { transform: rotateY(-90deg) translateZ(30px); }
        .cube__face--5 { transform: rotateX(90deg) translateZ(30px); }
        .cube__face--6 { transform: rotateX(-90deg) translateZ(30px); }

        /* BOARD */
        .board-container { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(5, 1fr); 
            gap: 4px; 
            width: 100%; 
            max-width: 400px; 
            aspect-ratio: 1; 
            margin: 0 auto; 
            background: #1a0505; 
            border: 4px solid #be185d; 
            border-radius: 8px; 
            padding: 4px; 
            position: relative; 
        }
        .board-tile { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 8px; position: relative; font-weight: bold; color: #ffdde7; transition: all 0.3s; }
        .board-tile.active-land { background: rgba(190, 24, 93, 0.4); border-color: #fff; transform: scale(0.95); }
        .board-center { grid-column: 2 / 5; grid-row: 2 / 5; background: radial-gradient(circle, #2c020f 0%, #000000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed #be185d; box-shadow: inset 0 0 20px #be185d; padding: 10px; text-align: center; }
        .tile-corner { background: rgba(190, 24, 93, 0.2); border-color: #be185d; }
        .token { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; position: absolute; z-index: 20; box-shadow: 0 0 5px black; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27); }
        .token-him { background: #3b82f6; top: 2px; left: 2px; }
        .token-her { background: #be185d; bottom: 2px; right: 2px; }
        .pulsing-heart { animation: heartbeat 1.5s infinite; filter: drop-shadow(0 0 10px #be185d); }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.2); } 30% { transform: scale(1); } 45% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* CONTRACT */
        .contract-paper { background-color: #fff0f5; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23eecfd8' fill-opacity='0.2'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z'/%3E%3C/g%3E%3C/svg%3E"); color: #4a0404; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform: rotate(-1deg); }
        .lipstick-stamp { position: absolute; top: 20px; right: 20px; width: 100px; height: 60px; transform: rotate(-15deg); opacity: 0.9; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2)); animation: stampAnim 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards; }
        @keyframes stampAnim { from { transform: scale(1.5) rotate(-15deg); opacity: 0; } to { transform: scale(1) rotate(-15deg); opacity: 0.9; } }

        /* GENERAL */
        .screen { 
            display: none; 
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
            min-height: 80vh; 
            justify-content: center; 
            opacity: 0; 
            transition: opacity 0.4s ease-in-out; 
            padding-top: 2rem; 
            padding-bottom: 2rem;
        }
        .screen.active { display: flex; opacity: 1; }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }
        .ai-loader { border: 4px solid rgba(255, 255, 255, 0.1); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Music Panel */
        #music-panel { position: fixed; top: 70px; right: 20px; width: 300px; z-index: 60; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); }
        #music-panel.active { transform: translateX(0); }
        .music-track { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); transition: background 0.2s; cursor: pointer; }
        .music-track.playing { background: rgba(var(--accent-rgb), 0.1); border-left: 3px solid var(--accent-color); }
        .equalizer-bar { width: 3px; background: var(--accent-color); animation: equalize 1s infinite; }
        .music-track.playing .eq-1 { height: 10px; animation-delay: 0.1s; }
        .music-track.playing .eq-2 { height: 15px; animation-delay: 0.2s; }
        .music-track.playing .eq-3 { height: 8px; animation-delay: 0.3s; }
        @keyframes equalize { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
        
        /* RPS & Flip Card */
        .rps-btn { transition: transform 0.2s; position: relative; overflow: hidden; }
        .rps-btn:active { transform: scale(0.9); }
        .hand-shake { animation: shakeHand 1.5s ease-in-out infinite; }
        .winner-glow { box-shadow: 0 0 30px #4ade80; border-color: #4ade80; animation: pulseWin 1s infinite; }
        .flip-card { background-color: transparent; height: 550px; perspective: 1000px; cursor: pointer; opacity: 0; transform: scale(0.8); transition: all 0.5s ease; display: none; }
        .flip-card.visible { display: block; opacity: 1; transform: scale(1); }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.27); transform-style: preserve-3d; box-shadow: 0 10px 20px rgba(0,0,0,0.4); border-radius: 1rem; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.15); overflow: hidden; }
        .flip-card-front { background: linear-gradient(135deg, var(--card-front-1) 0%, var(--card-front-2) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .flip-card-back { background: rgba(var(--glass-rgb), 0.98); transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 1.5rem; border: 2px solid var(--accent-color); }

        /* SECURITY MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; padding: 1rem; }
        .modal-overlay.active { opacity: 1; display: flex; }

        /* NEW MEMORY GAME CSS (MERGED) */
        .memory-board { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-gap: 8px; 
            width: 100%; 
            max-width: 450px; 
            aspect-ratio: 1; 
            margin: 0 auto; 
            padding: 12px; 
            background: rgba(var(--glass-rgb), 0.3); 
            border-radius: 1.5rem; 
            border: 2px solid rgba(255, 255, 255, 0.1); 
        }
        .memory-card { height: 100%; min-height: 80px; perspective: 1000px; } 
        
        /* 3D Flip Logic */
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .memory-card.flipped .card-inner { transform: rotateY(180deg); }
        
        .memory-card.matched .card-inner { transform: rotateY(180deg); opacity: 0.5; cursor: default; }

        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .card-front { background: linear-gradient(145deg, #a855f7 0%, #d946ef 100%); transform: rotateY(0deg); }
        .card-back { background: linear-gradient(145deg, #1f0516 0%, #3f0e0e 100%); transform: rotateY(180deg); border: 2px solid #e11d48; }
        
        .memory-card:not(.matched):not(.flipped):hover .card-inner { transform: scale(1.05); }
        
        .memory-card.turn-locked { opacity: 0.7; cursor: not-allowed !important; }

        /* LICENSING SCREEN SPECIFIC STYLES */
        .licensing-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: radial-gradient(circle at 50% 50%, #2c020f 0%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        .licensing-card {
            background: rgba(var(--glass-rgb), 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid var(--accent-color);
            box-shadow: 0 10px 50px rgba(var(--glass-rgb), 1.5);
            max-width: 400px;
            width: 90%;
            padding: 2rem;
            border-radius: 1.5rem;
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="bg-overlay"></div>
    <div id="bg-decoration"></div>

    <!-- NEW: LICENSING SCREEN - This will cover the entire app if not licensed -->
    <div id="licensing-screen" class="licensing-screen hidden">
        <div class="licensing-card">
            <i data-lucide="key-round" class="w-12 h-12 text-yellow-400 mx-auto mb-4"></i>
            <h1 class="text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 fancy-font">App Locked</h1>
            <p class="text-sm opacity-70 mb-6">Apne App ki Unique Passkey (License Key) Enter karein.</p>

            <input type="text" id="passkey-input" placeholder="Passkey (E.g., XXXX-XXXX-XXXX)" class="w-full p-4 rounded-xl input-glass font-bold text-center mb-4 tracking-widest text-lg uppercase">
            
            <button onclick="window.verifyPasskey()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg tracking-wide shadow-xl bg-green-600/80 hover:bg-green-700/90" id="verify-button">UNLOCK APP</button>
            
            <p id="passkey-status" class="mt-4 text-xs font-bold text-red-400 hidden">Status: Invalid Key ya Already Used.</p>

            <div class="mt-6 text-[10px] opacity-40 text-left border-t border-white/10 pt-4">
                <p class="font-bold text-white/90 mb-1">Aapke liye Note:</p>
                <p>1. Yeh Passkey sirf iss device par chalegi.</p>
                <p>2. Server check karega ki key valid hai aur phir usse aapki Device ID se link kar dega.</p>
                <p>3. Asli security ke liye ek **proper backend** zaroori hai.</p>
            </div>
        </div>
    </div>
    
    <!-- CUSTOM FEEDBACK ELEMENT -->
    <div id="feedback-container" class="fixed top-0 left-1/2 transform -translate-x-1/2 z-[101] w-full max-w-sm"></div>

    <!-- API KEY MODAL (Mobile-optimized width: max-w-sm) -->
    <div id="api-key-modal" class="modal-overlay">
        <div class="glass-panel p-6 sm:p-8 w-full max-w-sm text-center transform scale-95 transition-transform duration-300">
            <div class="mb-4 sm:mb-6"><i data-lucide="key" class="w-10 h-10 text-yellow-400 mx-auto"></i></div>
            <h3 class="text-xl sm:text-2xl font-bold fancy-font mb-2 text-yellow-300">Unlock AI Features</h3>
            <p class="text-xs opacity-60 mb-4 sm:mb-6">This feature requires a free Gemini API Key. Your key is stored locally on this device.</p>
            
            <input type="text" id="api-input" placeholder="Enter Your Free Gemini API Key Here" class="w-full p-3 sm:p-4 rounded-xl input-glass font-bold text-center mb-4 tracking-tight text-sm">
            
            <button onclick="window.saveAPIKey()" class="btn-gradient w-full py-3 rounded-xl font-bold text-sm bg-yellow-600/80 hover:bg-yellow-700/90">SAVE KEY & CONTINUE</button>
            
            <div class="mt-4 text-[10px] opacity-70 text-left">
                <p class="font-bold text-white/90 mb-1">How to get a key?</p>
                <p>1. "Search 'Google AI Studio API Key and create one from there for free."</p>
                <p>2. Enter the key above. The key is only used for story/movie generation.</p>
            </div>
        </div>
    </div>

    <!-- SECURITY MODAL (Mobile-optimized width: max-w-sm) -->
    <div id="password-modal" class="modal-overlay">
        <div class="glass-panel p-6 sm:p-8 w-full max-w-sm text-center transform scale-95 transition-transform duration-300" id="password-modal-content">
            <div class="mb-4 sm:mb-6"><div class="w-14 h-14 bg-white/5 rounded-full flex items-center justify-center mx-auto border border-white/10"><i data-lucide="lock" class="w-7 h-7 text-white"></i></div></div>
            <h3 id="pwd-modal-title" class="text-xl sm:text-2xl font-bold fancy-font mb-2">Security Check</h3>
            <p id="pwd-modal-desc" class="text-xs opacity-60 mb-4 sm:mb-6">Enter password to proceed.</p>
            
            <input type="password" id="pwd-input" placeholder="Enter Password" class="w-full p-3 sm:p-4 rounded-xl input-glass font-bold text-center mb-4 tracking-widest text-lg">
            
            <!-- Change Password Fields (Hidden by default) -->
            <div id="pwd-change-fields" class="hidden space-y-3 sm:space-y-4 mb-4">
                 <input type="password" id="pwd-new" placeholder="New Password" class="w-full p-3 sm:p-4 rounded-xl input-glass font-bold text-center tracking-widest text-lg">
            </div>

            <div class="flex gap-3">
                <button id="pwd-action-btn" class="flex-1 btn-gradient py-3 rounded-xl font-bold text-sm">CONFIRM</button>
                <button onclick="window.closePasswordModal()" class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-sm font-bold border border-white/10">CANCEL</button>
            </div>
            
            <div id="pwd-forgot-link" class="mt-4 sm:mt-6 text-[10px] opacity-40 hover:opacity-100 cursor-pointer underline transition-opacity" onclick="window.handleForgotPass()">Forgot Password?</div>
        </div>
    </div>

    <!-- MULTIPLAYER MODAL / SCREEN (Mobile-optimized width: max-w-sm) -->
    <div id="multiplayer-modal" class="modal-overlay">
        <div class="glass-panel p-6 sm:p-8 w-full max-w-sm text-center transform scale-95 transition-transform duration-300">
            <h3 id="mp-title" class="text-2xl sm:text-3xl font-bold fancy-font mb-4 text-pink-300">Multiplayer Setup üíë</h3>
            
            <!-- Step 1: Name and Gender Selection -->
            <div id="mp-step-1" class="space-y-4 sm:space-y-6 text-left">
                <p class="text-sm opacity-60">"Connect directly. Play intimately"</p>
                <div>
                    <label class="text-xs font-bold uppercase tracking-wider ml-1 opacity-70">Your Name</label>
                    <input type="text" id="mp-player-name" placeholder="Name" class="w-full p-3 rounded-xl input-glass font-semibold" value="Player">
                </div>
                <div>
                    <label class="text-xs font-bold uppercase tracking-wider ml-1 opacity-70">Your Gender</label>
                    <select id="mp-player-gender" class="w-full p-3 rounded-xl input-glass font-semibold cursor-pointer">
                        <option value="Him">Him (Male ‚ôÇÔ∏è)</option>
                        <option value="Her">Her (Female ‚ôÄÔ∏è)</option>
                    </select>
                </div>
                <button onclick="window.showMultiplayerStep(2)" class="btn-gradient w-full py-3 rounded-xl font-bold text-lg tracking-wide">ADVANCE TO DESIRE</button>
            </div>

            <!-- Step 2: Host or Join -->
            <div id="mp-step-2" class="hidden space-y-4 sm:space-y-6">
                <p class="text-sm opacity-60" id="mp-welcome-msg">Welcome, Player! Now, choose your role: Dominant or Submissive.</p>
                <div class="flex flex-col gap-4">
                    <button onclick="window.hostGame()" class="flex-1 btn-gradient py-4 rounded-xl font-bold text-base bg-blue-600/50 hover:bg-blue-600/70">HOST GAME (DOMINANT)</button>
                    <button onclick="window.showMultiplayerStep(3)" class="flex-1 btn-gradient py-4 rounded-xl font-bold text-base bg-rose-600/50 hover:bg-rose-600/70">JOIN ROOM (SUBMIT)</button>
                </div>
                <button onclick="window.showMultiplayerStep(1)" class="w-full py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs font-bold mt-4">Retreat</button>
            </div>
            
            <!-- Step 3: Join Room Input -->
            <div id="mp-step-3" class="hidden space-y-4 sm:space-y-6 text-left">
                <p class="text-sm opacity-60">Enter the code to join the room</p>
                <input type="text" id="mp-join-code" placeholder="Partner's Room Code" class="w-full p-4 rounded-xl input-glass font-bold text-center tracking-widest text-lg uppercase">
                <button onclick="window.joinGame()" class="btn-gradient w-full py-3 rounded-xl font-bold text-lg">JOIN NOW</button>
                <button onclick="window.showMultiplayerStep(2)" class="w-full py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs font-bold mt-4">GO BACK</button>
            </div>

            <!-- Step 4: Connecting / Waiting -->
            <div id="mp-step-4" class="hidden space-y-4 sm:space-y-6">
                <div id="mp-loading" class="ai-loader mx-auto"></div>
                <h4 id="mp-status-heading" class="text-xl font-bold text-white fancy-font">Connection Status</h4>
                <p id="mp-status-desc" class="text-sm opacity-70">Waiting for partner...</p>
                <div id="mp-host-code-display" class="hidden flex flex-col items-center">
                    <p class="text-xs opacity-50 mb-2">Send your code to your partner</p>
                    <div class="flex items-center gap-2">
                        <span id="mp-peer-id" class="text-2xl font-black text-yellow-400">LOADING...</span>
                        <button onclick="window.copyToClipboard('mp-peer-id')" class="p-2 bg-yellow-400/20 rounded-full hover:bg-yellow-400/30 transition-colors"><i data-lucide="copy" class="w-4 h-4 text-yellow-400"></i></button>
                    </div>
                </div>
                <button onclick="window.closeMultiplayerModal()" class="w-full py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs font-bold mt-4">Cancel</button>
            </div>
            
            <!-- Step 5: Connected (Game Ready) -->
             <div id="mp-step-5" class="hidden space-y-4 sm:space-y-6">
                <i data-lucide="heart-handshake" class="w-16 h-16 text-green-400 mx-auto"></i>
                <h4 class="text-xl font-bold text-green-400 fancy-font">CONNECTION SUCCESSFUL!</h4>
                <p class="text-sm opacity-80">Coordinates locked. Destination: Pure pleasure.</p>
                <div class="bg-white/10 p-4 rounded-xl text-xs font-mono">
                    <p>Host: <span id="mp-host-info" class="text-blue-300"></span></p>
                    <p>Guest: <span id="mp-guest-info" class="text-rose-300"></span></p>
                </div>
                <button onclick="window.closeMultiplayerModal(true)" class="btn-gradient w-full py-3 rounded-xl font-bold text-lg">Start the Pleasure</button>
            </div>
        </div>
    </div>
    
    <header id="main-header" class="w-full max-w-5xl flex justify-between items-center py-4 z-50 fixed top-0 px-4 backdrop-blur-sm bg-black/20 transition-all duration-300 opacity-0 pointer-events-none">
        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80" onclick="window.showScreen('home')">
            <div class="p-2 bg-white/10 rounded-lg"><i data-lucide="layout-grid" class="w-5 h-5 text-white"></i></div>
            <span class="font-bold tracking-wider hidden md:block">HOME</span>
        </div>
        <div class="flex gap-3">
            <button onclick="window.toggleMusicPanel()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors relative"><i data-lucide="music" class="w-5 h-5 text-white"></i><span id="music-indicator" class="absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full hidden"></span></button>
            <button onclick="window.openMultiplayerModal()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors relative" id="mp-status-btn" title="Multiplayer Status"><i data-lucide="users" class="w-5 h-5 text-white" id="mp-status-icon"></i><span id="mp-connected-dot" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-black"></span></button>
            <button onclick="window.showScreen('setup')" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors"><i data-lucide="settings" class="w-5 h-5 text-white"></i></button>
        </div>
    </header>

    <div id="music-panel" class="glass-panel p-4">
        <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
            <h3 class="font-bold fancy-font">Mood Music üéµ</h3>
            <button onclick="window.toggleMusicPanel()" class="text-white/50 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        <div id="track-list" class="flex flex-col mb-4 overflow-y-auto max-h-[60vh] custom-scroll pr-2"></div>
        <div class="flex items-center gap-2 mt-2">
            <i data-lucide="volume-2" class="w-4 h-4 opacity-50"></i>
            <input type="range" min="0" max="1" step="0.1" value="0.5" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer" oninput="window.setVolume(this.value)">
        </div>
    </div>

    <div id="app" class="w-full max-w-5xl relative z-10 mt-16 pb-12">
        <!-- 1. SETUP -->
        <div id="screen-setup" class="screen active min-h-screen">
            <!-- Adjusted vertical padding for better mobile height fit -->
            <div class="glass-panel p-6 sm:p-8 md:p-12 w-full max-w-md text-center space-y-6 sm:space-y-8 fade-in-up">
                <div class="inline-block p-5 rounded-full bg-white/5 border border-white/10 mb-2 float">
                    <i data-lucide="infinity" class="w-16 h-16 text-white/90"></i>
                </div>
                <div>
                    <h1 class="text-4xl md:text-5xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-white/60">Intimate Sparks</h1>
                    <p class="text-xs uppercase tracking-[0.2em] opacity-60">The Ultimate Couple's Game</p>
                </div>
                <div class="space-y-4 text-left">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold uppercase tracking-wider ml-1 opacity-70">He is... ‚ôÇÔ∏è</label><input type="text" id="input-him" placeholder="Name" class="w-full p-3 rounded-xl input-glass font-semibold" value="Him"></div>
                        <div><label class="text-xs font-bold uppercase tracking-wider ml-1 opacity-70">She is... ‚ôÄÔ∏è</label><input type="text" id="input-her" placeholder="Name" class="w-full p-3 rounded-xl input-glass font-semibold" value="Her"></div>
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider ml-1 opacity-70">Vibe üé®</label>
                        <select id="theme-selector" onchange="window.applyTheme(this.value)" class="w-full p-4 rounded-xl input-glass font-semibold cursor-pointer">
                            <option value="red">üî• Passion Red</option><option value="maroon">ü©∏ Maroon Dark</option><option value="hotpink">üíñ Hot Pink</option><option value="purple">üîÆ Neon Purple</option><option value="blue">üåä Deep Blue</option><option value="emerald">üíö Emerald</option><option value="gold">üèÜ Gold</option><option value="black">‚ö´ Pure Black</option>
                        </select>
                    </div>
                </div>
                <button onclick="window.startGameSuite()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg tracking-wide shadow-xl">ENTER THE SUITE</button>
                <!-- Multiplayer Button Added Here -->
                <button onclick="window.openMultiplayerModal()" class="w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-sm font-bold mt-4 flex justify-center items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> START MULTIPLAYER</button>
            </div>
        </div>
           
        <!-- 2. HOME -->
        <div id="screen-home" class="screen">
            <div class="text-center mb-8 fade-in-up">
                <h2 class="text-3xl md:text-4xl font-bold fancy-font mb-2">Choose Adventure</h2>
                <p class="text-sm opacity-60" id="welcome-msg">Welcome</p>
            </div>
            <!-- Home Grid: Changed to sm:grid-cols-2 for better mobile density -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl fade-in-up" style="animation-delay: 0.1s">

    <div onclick="window.showScreen('tod'); window.initTOD();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20"><i data-lucide="zap" class="w-7 h-7 text-blue-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Truth/Dare</h3><p class="text-[10px] opacity-60">Classic Fun</p></div>
    </div>

    <div onclick="window.showScreen('cards'); window.initCards();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-rose-500/10 flex items-center justify-center border border-rose-500/20"><i data-lucide="layers" class="w-7 h-7 text-rose-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Mystery Cards</h3><p class="text-[10px] opacity-60">50+ Positions</p></div>
    </div>

    <div onclick="window.showScreen('movies'); window.initMovies();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-teal-500/10 flex items-center justify-center border border-teal-500/20"><i data-lucide="film" class="w-7 h-7 text-teal-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">AI Movie Date</h3><p class="text-[10px] opacity-60">Perfect Picks</p></div>
    </div>

    <div onclick="window.showScreen('story'); window.initStory();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20"><i data-lucide="feather" class="w-7 h-7 text-emerald-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">AI Fantasies</h3><p class="text-[10px] opacity-60">Roleplay Scripts</p></div>
    </div>

    <div onclick="window.showScreen('coupons');" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-amber-500/10 flex items-center justify-center border border-amber-500/20"><i data-lucide="ticket" class="w-7 h-7 text-amber-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Coupons</h3><p class="text-[10px] opacity-60">Win & Sign</p></div>
    </div>

    <div onclick="window.showScreen('nhie'); window.initNHIE();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-fuchsia-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-fuchsia-500/10 flex items-center justify-center border border-fuchsia-500/20"><i data-lucide="wine" class="w-7 h-7 text-fuchsia-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Never Have I Ever</h3><p class="text-[10px] opacity-60">Truths & Punishments</p></div>
    </div>

    <div onclick="window.showScreen('memory'); window.initMemory();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-purple-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-purple-500/10 flex items-center justify-center border border-purple-500/20"><i data-lucide="puzzle" class="w-7 h-7 text-purple-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Memory Match</h3><p class="text-[10px] opacity-60">Pure Seduction</p></div>
    </div>

    <div onclick="window.initMonopoly();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-purple-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-purple-500/10 flex items-center justify-center border border-purple-500/20"><i data-lucide="layout-dashboard" class="w-7 h-7 text-purple-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Monopoly</h3><p class="text-[10px] opacity-60">Dark Board Race</p></div>
    </div>

    <div onclick="window.showScreen('scratch'); window.initScratch();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-yellow-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-yellow-500/10 flex items-center justify-center border border-yellow-500/20"><i data-lucide="eraser" class="w-7 h-7 text-yellow-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Scratch Adventure</h3><p class="text-[10px] opacity-60">Reveal Positions</p></div>
    </div>

    <div onclick="window.showScreen('dice'); window.initSpiceDice();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-orange-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20"><i data-lucide="dices" class="w-7 h-7 text-orange-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Spice & Dice</h3><p class="text-[10px] opacity-60">Spin the Wheel</p></div>
    </div>

    <div onclick="window.showScreen('bomb');" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-red-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20"><i data-lucide="bomb" class="w-7 h-7 text-red-500"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Lust Bomb</h3><p class="text-[10px] opacity-60">Panic Mode</p></div>
    </div>

    <div onclick="window.showScreen('risk');" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-red-700/40 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-red-600/10 flex items-center justify-center border border-red-600/30"><i data-lucide="alert-octagon" class="w-7 h-7 text-red-500"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Risk It All</h3><p class="text-[10px] opacity-60">High Stakes</p></div>
    </div>

    <div onclick="window.initDistraction();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-cyan-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20"><i data-lucide="fingerprint" class="w-7 h-7 text-cyan-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Temptation</h3><p class="text-[10px] opacity-60">Endurance Test</p></div>
    </div>

    <div onclick="window.initSLSGame();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-pink-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-pink-500/10 flex items-center justify-center border border-pink-500/20"><i data-lucide="droplet" class="w-7 h-7 text-pink-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Squeeze Lick Suck</h3><p class="text-[10px] opacity-60">Sensory Trio</p></div>
    </div>

    <div onclick="window.initPandora();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-purple-600/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-purple-600/10 flex items-center justify-center border border-purple-500/20"><i data-lucide="box" class="w-7 h-7 text-purple-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Pandora's Box</h3><p class="text-[10px] opacity-60">Devil or Angel?</p></div>
    </div>

    <div onclick="window.initRoulette();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-slate-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-emerald-500/20 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="globe" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">ONLINE & IN-PERSON</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-slate-500/10 flex items-center justify-center border border-slate-500/20"><i data-lucide="crosshair" class="w-7 h-7 text-slate-300"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Russian Roulette</h3><p class="text-[10px] opacity-60">One Bullet</p></div>
    </div>

    <div onclick="window.initLipGame();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-teal-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-teal-500/10 flex items-center justify-center border border-teal-500/20"><i data-lucide="headphones" class="w-7 h-7 text-teal-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Lip Lust</h3><p class="text-[10px] opacity-60">Read My Lips</p></div>
    </div>

    <div onclick="window.showScreen('blindfold'); window.initBlindfold();" class="game-card glass-panel p-6 flex flex-col items-center gap-4 text-center group border-2 border-indigo-500/30 relative">
        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg border bg-orange-500/20 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.2)] backdrop-blur-md flex items-center gap-1.5 z-20">
            <i data-lucide="home" class="w-3 h-3"></i><span class="text-[9px] font-bold uppercase tracking-wider">IN-PERSON ONLY</span>
        </div>
        <div class="w-14 h-14 rounded-2xl bg-indigo-500/10 flex items-center justify-center border border-indigo-500/20"><i data-lucide="eye-off" class="w-7 h-7 text-indigo-400"></i></div>
        <div><h3 class="text-lg font-bold mb-1">Sensory Blindfold</h3><p class="text-[10px] opacity-60">Guess the Touch</p></div>
    </div>

</div>            <div class="mt-8 flex gap-4">
                <button onclick="window.showSavedStories()" class="text-sm opacity-60 hover:opacity-100 flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-white/5 transition-all"><i data-lucide="bookmark" class="w-4 h-4"></i> Saved Stories</button>
                <button onclick="window.showVault()" class="text-sm text-amber-400 hover:text-amber-300 flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-500/10 hover:bg-amber-500/20 transition-all border border-amber-500/20"><i data-lucide="lock" class="w-4 h-4"></i> Vault üîê</button>
            </div>
        </div>

        <!-- NEW MOVIE PICKER SCREEN (Redesigned for better flow and filters) -->
        <div id="screen-movies" class="screen">
            <!-- max-w-2xl on mobile/tablet, max-w-4xl on desktop -->
            <div class="w-full max-w-2xl lg:max-w-4xl glass-panel p-6 md:p-8 flex flex-col md:flex-row gap-6 md:gap-8 min-h-[550px] relative">
                <button onclick="window.goToHome()" class="absolute top-4 right-4 p-2 bg-white/10 rounded-full z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <!-- Left: Filter Menu (Stacked filters for improved mobile UI) -->
                <div class="w-full md:w-1/3 flex flex-col border-r-0 md:border-r border-white/10 pr-0 md:pr-6 h-full">
                    
                    <h3 class="text-xl font-bold fancy-font mb-4 text-teal-300 flex items-center gap-2"><i data-lucide="clapperboard" class="w-5 h-5"></i> Select Your Vibe</h3>

                    <!-- Filter Containers - Scrollable stack on all screens -->
                    <div class="flex flex-col gap-6 overflow-y-auto custom-scroll flex-grow pr-2">
                        
                        <!-- 1. Industry Filter (NEW) -->
                        <div>
                            <h4 class="text-sm font-bold uppercase tracking-widest text-white/70 mb-2">1. Industry/Origin</h4>
                            <div id="industry-list" class="flex flex-col gap-2 filter-panel-group">
                                <!-- Industry Buttons injected via JS -->
                            </div>
                        </div>
                        
                        <!-- 2. Language Filter (NEW) -->
                        <div>
                            <h4 class="text-sm font-bold uppercase tracking-widest text-white/70 mb-2">2. Language Focus</h4>
                            <div id="language-list" class="flex flex-col gap-2 filter-panel-group">
                                <!-- Language Buttons injected via JS -->
                            </div>
                        </div>

                        <!-- 3. Genre Filter (EXISTING) -->
                        <div>
                            <h4 class="text-sm font-bold uppercase tracking-widest text-white/70 mb-2">3. Genre/Mood</h4>
                            <div id="genre-list" class="flex flex-col gap-2 filter-panel-group">
                                <!-- Genre Buttons injected via JS -->
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Right: Result Area -->
                <div class="w-full md:w-2/3 flex flex-col justify-center items-center text-center relative h-full">
                    <div id="movie-intro" class="text-center opacity-70">
                        <i data-lucide="film" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <h4 class="text-lg font-bold">Pick Your Filters & Let AI Decide</h4>
                        <p class="text-xs mt-2">Choose at least one option from each category to get the best result!</p>
                    </div>

                    <div id="movie-loading" class="hidden flex-col items-center">
                        <div class="ai-loader mb-4"></div>
                        <p class="text-xs uppercase tracking-widest opacity-70">Searching Database...</p>
                    </div>

                    <div id="movie-result" class="hidden w-full text-left movie-result-card bg-black/20 p-6 rounded-2xl border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <span id="res-year" class="text-[10px] font-bold bg-white/10 px-2 py-1 rounded text-white/70">2024</span>
                            <span id="res-genre" class="text-[10px] uppercase tracking-widest text-teal-300 font-bold">ROMANCE</span>
                        </div>
                        <h2 id="res-title" class="text-3xl md:text-4xl font-black text-white fancy-font mb-4 leading-tight">Movie Title</h2>
                        <p id="res-desc" class="text-sm opacity-80 leading-relaxed mb-6 italic">Plot description goes here...</p>
                        
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                            <p class="text-[10px] font-bold uppercase text-teal-400 mb-1">‚ù§Ô∏è Why watch together?</p>
                            <p id="res-why" class="text-xs font-semibold text-white/90">Reason goes here.</p>
                        </div>
                        <button onclick="window.generateAIMovie()" class="mt-6 w-full py-3 rounded-xl bg-white/5 hover:bg-white/10 text-xs font-bold uppercase tracking-widest border border-white/10">Suggest Another</button>
                    </div>

                    <button onclick="window.generateAIMovie()" id="btn-suggest-movie" class="mt-8 btn-gradient px-8 py-3 rounded-xl font-bold text-sm shadow-lg flex items-center gap-2 hidden">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Suggest Movie
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. CARDS (Mobile-Optimized Width) -->
        <div id="screen-cards" class="screen">
            <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20"><i data-lucide="arrow-left" class="w-5 h-5 text-white"></i></button>
            <!-- Adjusted max-w-lg to max-w-md on mobile -->
            <div class="w-full max-w-md lg:max-w-lg flex flex-col items-center gap-8">
                <div class="text-center"><h2 class="text-3xl font-bold fancy-font">Roll the Dice üé≤</h2><p class="text-sm opacity-60 mt-2">Let fate decide your position</p></div>
                <!-- FIXED DICE CONTAINER -->
                <div class="flex justify-center items-center py-8">
                    <div id="mystery-dice-box" class="mystery-dice-box" onclick="window.rollDice()">
                        <span id="dice-val">?</span>
                    </div>
                </div>
                <div id="card-display-area" class="w-full relative h-[550px] flex items-center justify-center">
                    <div id="card-placeholder" class="text-white/30 font-bold text-xl">Waiting for roll...</div>
                    <div id="active-card" class="flip-card w-full max-w-sm">
                        <div class="flip-card-inner">
                            <div class="flip-card-front"><i data-lucide="gift" class="w-16 h-16 text-white/70 mb-4"></i><h3 class="text-3xl font-bold fancy-font tracking-widest">REVEAL</h3></div>
                            <div class="flip-card-back">
                                <div class="text-center mt-4"><div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center mx-auto mb-3 border border-white/20"><i id="card-icon" data-lucide="heart" class="w-8 h-8"></i></div><h3 id="card-title" class="text-2xl font-bold fancy-font leading-tight text-white mb-1">Title</h3><p id="card-tease" class="text-xs font-bold uppercase tracking-widest text-rose-300">Tease</p></div>
                                <div class="w-full bg-black/30 p-5 rounded-xl border border-white/10 my-4 overflow-y-auto custom-scroll" style="max-height: 250px;"><div id="card-method" class="text-sm md:text-base italic text-white/90 leading-relaxed text-left"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. TOD (No changes needed, already max-w-md) -->
        <div id="screen-tod" class="screen">
            <div class="w-full max-w-md glass-panel p-8 relative min-h-[400px] flex flex-col justify-between">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-10"><i data-lucide="arrow-left" class="w-5 h-5 text-white"></i></button>
                <div class="text-center pt-8">
                    <span id="tod-turn" class="text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-white/10">Player's Turn</span>
                    <h2 class="text-3xl font-bold fancy-font mt-4">Make a Choice</h2>
                </div>
                <div id="tod-choice-btns" class="space-y-3 mt-8">
                    <button onclick="window.todAction('Truth')" class="w-full p-4 rounded-xl border border-blue-500/30 bg-blue-500/10 hover:bg-blue-500/20 transition-all flex justify-between items-center group cursor-pointer"><span class="font-bold text-blue-200">TRUTH</span><i data-lucide="message-circle" class="w-5 h-5 text-blue-300"></i></button>
                    <button onclick="window.todAction('Dare')" class="w-full p-4 rounded-xl border border-rose-500/30 bg-rose-500/10 hover:bg-rose-500/20 transition-all flex justify-between items-center group cursor-pointer"><span class="font-bold text-rose-200">DARE</span><i data-lucide="flame" class="w-5 h-5 text-rose-300"></i></button>
                </div>
                <div id="tod-result" class="hidden flex-col items-center text-center mt-4 fade-in-up">
                    <div class="mb-4"><span id="tod-type-badge" class="text-[10px] font-bold px-2 py-1 rounded border">TRUTH</span></div>
                    <p id="tod-text" class="text-lg font-medium leading-relaxed mb-8">Loading...</p>
                    <button onclick="window.todNextTurn()" class="btn-gradient w-full py-3 rounded-lg font-bold text-sm">Next Turn</button>
                </div>
            </div>
        </div>

        <!-- 5. AI STORY (Mobile-Optimized Width) -->
        <div id="screen-story" class="screen">
            <!-- Adjusted max-w-lg to max-w-md -->
            <div id="story-step-1" class="w-full max-w-md glass-panel p-6 flex flex-col h-[600px] relative">
                <button onclick="window.goToHome()" class="absolute top-4 right-4 p-2 bg-white/10 rounded-full z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h2 class="text-2xl font-bold mb-4">Select Fantasy üé≠</h2>
                <div id="roles-list" class="overflow-y-auto custom-scroll flex-grow pr-2 space-y-2"></div>
            </div>
            <!-- Adjusted max-w-lg to max-w-md -->
            <div id="story-step-2" class="hidden w-full max-w-md glass-panel p-8 space-y-8">
                <div class="flex items-center gap-2 cursor-pointer opacity-70 hover:opacity-100" onclick="window.storyNav(1)"><i data-lucide="arrow-left" class="w-4 h-4"></i> <span class="text-xs uppercase font-bold">Back</span></div>
                <div>
                    <label class="block text-sm font-bold uppercase tracking-wider mb-4 opacity-80">Who Starts?</label>
                    <div class="grid grid-cols-2 gap-4"><button onclick="window.setStoryActor('Him')" class="story-actor-btn btn-option p-4 rounded-xl flex flex-col items-center"><span class="text-2xl mb-1">ü§µ</span> Him</button><button onclick="window.setStoryActor('Her')" class="story-actor-btn btn-option p-4 rounded-xl flex flex-col items-center"><span class="text-2xl mb-1">üíÉ</span> Her</button></div>
                </div>
                <div><label class="block text-sm font-bold uppercase tracking-wider mb-4 opacity-80">Resistance Level</label><input type="range" min="1" max="3" value="1" class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer" oninput="window.state.story.diff = parseInt(this.value)"><div class="flex justify-between text-[10px] uppercase mt-2 opacity-50 font-bold"><span>Hesitant</span><span>Hard</span><span>Forbidden</span></div></div>
                <button onclick="window.generateAIStory()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-xl flex justify-center items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5"></i> Generate with AI</button>
            </div>
            <!-- Adjusted max-w-2xl to max-w-lg -->
            <div id="story-step-3" class="hidden w-full max-w-lg glass-panel p-8 relative flex flex-col h-[70vh]">
                <div class="flex justify-between items-start mb-4 border-b border-white/10 pb-4">
                    <div><h3 id="story-role-title" class="text-xl font-bold text-white fancy-font">AI Scenario</h3></div>
                    <div class="flex gap-2"><button onclick="window.saveCurrentStory()" class="p-2 hover:bg-white/10 rounded-full" title="Save Story"><i data-lucide="bookmark" class="w-5 h-5"></i></button><button onclick="window.copyStory()" class="p-2 hover:bg-white/10 rounded-full" title="Copy Text"><i data-lucide="copy" class="w-5 h-5"></i></button><button onclick="window.storyNav(2)" class="p-2 hover:bg-white/10 rounded-full" title="Regenerate"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button></div>
                </div>
                <div id="ai-loading" class="hidden flex-col items-center justify-center h-full"><div class="ai-loader mb-4"></div><p>Dreaming...</p></div>
                <div id="story-content" class="overflow-y-auto custom-scroll pr-4 text-base md:text-lg leading-loose font-medium text-gray-200 story-text"></div>
            </div>
        </div>
        
        <!-- 5.5 STORY VIEWER MODAL (Mobile-Optimized Width) -->
        <div id="screen-view-story" class="screen">
            <!-- Adjusted max-w-2xl to max-w-lg on mobile -->
            <div class="w-full max-w-lg glass-panel p-8 relative flex flex-col h-[80vh]">
                <div class="flex justify-between items-start mb-4 border-b border-white/10 pb-4">
                    <div><h3 id="view-story-role" class="text-xl font-bold text-white fancy-font">Role Name</h3><p id="view-story-date" class="text-xs opacity-50 font-mono mt-1">Date</p></div>
                    <button onclick="window.showSavedStories()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div id="view-story-content" class="overflow-y-auto custom-scroll pr-4 text-base md:text-lg leading-loose font-medium text-gray-200 story-text flex-grow">Feature Disabled</div>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-end">
                     <button onclick="window.copySavedStory()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all text-sm font-bold border border-white/10"><i data-lucide="copy" class="w-4 h-4"></i> Copy Text</button>
                </div>
            </div>
        </div>

        <!-- 6. COUPONS (Mobile-Optimized Width) -->
        <div id="screen-coupons" class="screen">
            <!-- Adjusted max-w-3xl to max-w-xl on mobile -->
            <div id="coupon-list-view" class="w-full max-w-xl md:max-w-3xl glass-panel p-6 h-[80vh] flex flex-col">
                <div class="flex items-center gap-4 mb-6 flex-shrink-0">
                    <button onclick="window.goToHome()" class="p-2 bg-white/10 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <div><h2 class="text-2xl font-bold fancy-font">Win a Coupon üéüÔ∏è</h2><p class="text-xs opacity-60">Strategy Battle. Resets Daily.</p></div>
                </div>
                <div class="overflow-y-auto custom-scroll flex-grow pr-2">
                    <!-- Grid starts at 1 col, moves to 2 col on md screens (good responsiveness) -->
                    <div id="coupons-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4"></div>
                </div>
            </div>
            <!-- RPS ARENA (No changes needed, already max-w-md) -->
            <div id="rps-arena" class="hidden w-full max-w-md glass-panel p-8 text-center min-h-[400px] flex flex-col justify-center">
                <button onclick="window.closeRPS(false)" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h3 class="text-xl font-bold text-amber-300 mb-2">Battle Arena</h3>
                <p id="rps-status" class="text-sm opacity-80 mb-6 font-mono tracking-widest uppercase">Round 1</p>
                <div id="rps-selection-area">
                    <p class="text-lg font-bold mb-8 text-white" id="p1-name-display">Him's Turn</p>
                    <div class="flex justify-center gap-6">
                        <button onclick="window.playRPSMove('rock')" class="rps-btn bg-white/5 p-6 rounded-2xl border border-white/10 hover:border-blue-400"><i data-lucide="hexagon" class="w-12 h-12 text-gray-400 fill-gray-400/20"></i><span class="block text-xs mt-2 uppercase font-bold tracking-wider">Rock</span></button>
                        <button onclick="window.playRPSMove('paper')" class="rps-btn bg-white/5 p-6 rounded-2xl border border-white/10 hover:border-blue-400"><i data-lucide="file-text" class="w-12 h-12 text-white fill-white/20"></i><span class="block text-xs mt-2 uppercase font-bold tracking-wider">Paper</span></button>
                        <button onclick="window.playRPSMove('scissors')" class="rps-btn bg-white/5 p-6 rounded-2xl border border-white/10 hover:border-blue-400"><i data-lucide="scissors" class="w-12 h-12 text-red-400"></i><span class="block text-xs mt-2 uppercase font-bold tracking-wider">Scissors</span></button>
                    </div>
                </div>
                <div id="rps-countdown" class="hidden">
                    <div class="flex justify-center gap-12 text-6xl">
                        <div class="hand-shake"><i data-lucide="thumbs-up" class="w-24 h-24 text-blue-400 rotate-90"></i></div>
                        <div class="hand-shake" style="animation-delay:0.1s"><i data-lucide="thumbs-up" class="w-24 h-24 text-rose-400 rotate-90 scale-x-[-1]"></i></div>
                    </div>
                    <h2 id="countdown-text" class="text-4xl font-black mt-8 text-white">READY...</h2>
                </div>
                <div id="rps-result-area" class="hidden">
                    <div class="flex justify-center items-center gap-8 mb-6"><div id="res-icon-1" class="p-4 bg-blue-500/20 rounded-xl"></div><div class="text-xl font-bold opacity-50">VS</div><div id="res-icon-2" class="p-4 bg-rose-500/20 rounded-xl"></div></div>
                    <h2 id="rps-winner-text" class="text-3xl font-bold fancy-font mb-6 text-green-400">Him Wins!</h2>
                    <p id="rps-result-desc" class="text-sm opacity-70 mb-6">Coupon Unlocked!</p>
                    <button id="claim-btn" onclick="window.closeRPS(true)" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-lg">Confirm</button>
                    <button id="contract-btn" onclick="window.openContractSign(false)" class="hidden btn-gradient bg-gradient-to-r from-amber-600 to-yellow-600 w-full py-4 rounded-xl font-bold text-lg shadow-lg border border-yellow-400/50">Proceed to Sign Contract ‚úçÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- 10. NEVER HAVE I EVER (NHIE) - MERGED (Mobile-Optimized Width) -->
        <div id="screen-nhie" class="screen">
            <!-- Adjusted max-w-xl to max-w-md on mobile -->
            <div class="w-full max-w-md md:max-w-xl glass-panel p-8 relative min-h-[500px] flex flex-col justify-between">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-10"><i data-lucide="arrow-left" class="w-5 h-5 text-white"></i></button>
                <div id="nhie-game-area" class="text-center pt-8 fade-in-up">
                    <span class="text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-fuchsia-500/20 text-fuchsia-300">Statement #<span id="nhie-q-num">1</span></span>
                    <h2 class="text-3xl font-bold fancy-font mt-4 text-white" id="nhie-current-question">Game starts now...</h2>
                    <p class="text-sm opacity-60 mt-2 italic" id="nhie-turn-prompt">Him will read the statement.</p>

                    <div id="nhie-finger-score" class="flex justify-center gap-8 sm:gap-12 mt-10 mb-8">
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-black text-blue-300" id="nhie-him-score">5</span>
                            <span class="text-sm opacity-70" id="nhie-him-label">Him Fingers</span>
                            <button id="btn-him-down" onclick="window.NHIEFingerDown('Him')" class="mt-2 text-xs font-bold px-3 py-1 rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors" disabled>Him Did It</button>
                        </div>
                        <div class="text-5xl fancy-font text-white/50">VS</div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-black text-rose-300" id="nhie-her-score">5</span>
                            <span class="text-sm opacity-70" id="nhie-her-label">Her Fingers</span>
                            <button id="btn-her-down" onclick="window.NHIEFingerDown('Her')" class="mt-2 text-xs font-bold px-3 py-1 rounded bg-rose-500/20 text-rose-300 hover:bg-rose-500/30 transition-colors" disabled>Her Did It</button>
                        </div>
                    </div>
                    
                    <button id="btn-nhie-next" onclick="window.nextNHIEQuestion()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg tracking-wide bg-fuchsia-600/80 hover:bg-fuchsia-700/90">NEXT STATEMENT</button>
                </div>
                
                <div id="nhie-punishment-area" class="hidden text-center pt-8 fade-in-up">
                    <i data-lucide="hand-metal" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                    <h2 class="text-4xl font-black fancy-font text-red-400 mb-2">PUNISHMENT TIME!</h2>
                    <p class="text-lg font-bold opacity-80 mb-6" id="nhie-loser-name">Loser Name</p>
                    <p class="text-sm opacity-60 mb-8" id="nhie-winner-name">Winner decides the fate of Loser</p>
                    
                    <div id="nhie-punishment-list" class="space-y-4 max-h-60 overflow-y-auto custom-scroll p-2">
                        <!-- Punishments will be dynamically loaded here -->
                    </div>
                    
                    <button onclick="window.goToHome()" class="mt-8 w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-sm font-bold">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- 11. MEMORY MATCH GAME - MERGED (Mobile-Optimized Width) -->
        <div id="screen-memory" class="screen">
            <!-- Adjusted max-w-xl to max-w-md on mobile -->
            <div class="w-full max-w-md lg:max-w-xl glass-panel p-6 relative flex flex-col items-center justify-center min-h-[90vh]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-10"><i data-lucide="arrow-left" class="w-5 h-5 text-white"></i></button>
                
                <h2 class="text-3xl font-bold fancy-font text-purple-300 mb-4">Memory Match: Seduction</h2>
                <p class="text-xs font-mono opacity-70 mb-6" id="memory-turn-text">Turn: Him</p>
                
                <!-- SCORES -->
                <div class="flex justify-around w-full max-w-xs mb-6">
                    <div class="text-center">
                        <span class="text-2xl font-black text-blue-300" id="memory-him-score">0</span>
                        <p class="text-sm opacity-70" id="memory-him-name">Him Matches</p>
                    </div>
                    <div class="text-center">
                        <span class="text-2xl font-black text-rose-300" id="memory-her-score">0</span>
                        <p class="text-sm opacity-70" id="memory-her-name">Her Matches</p>
                    </div>
                </div>

                <!-- BOARD -->
                <!-- Board max-width is 450px in CSS, ensuring it fits well -->
                <div id="memory-board" class="memory-board">
                    <!-- Cards will be rendered here -->
                </div>

                <!-- PERSISTENT ACTION LOG -->
                <div id="memory-action-log" class="mt-6 w-full text-center p-3 rounded-lg border border-yellow-500/30 bg-yellow-900/20 min-h-[60px] flex items-center justify-center text-sm font-medium text-yellow-200">
                    Try to make a match! Pure Pleasure Rewards.
                </div>
            </div>
        </div>
        <!-- END MEMORY MATCH SCREEN -->

        <!-- 9. MONOPOLY GAME SCREEN (Mobile-Optimized Width) -->
        <div id="screen-monopoly" class="screen">
            <!-- Adjusted max-w-lg to max-w-md -->
            <div class="w-full max-w-md glass-panel p-4 relative flex flex-col items-center justify-center min-h-[90vh]">
                <div class="flex justify-between items-center w-full mb-4">
                    <button onclick="window.goToHome()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <div class="text-center">
                        <h3 class="font-bold fancy-font text-xl text-pink-300">Monopoly of Love</h3>
                        <p class="text-[10px] font-mono opacity-70" id="mono-turn-text">Turn: Him</p>
                    </div>
                    <button onclick="window.resetMonopoly()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                </div>
                <!-- Board max-width is 400px in CSS, ensuring it fits well -->
                <div id="monopoly-board" class="board-container">
                    <div class="board-center" id="board-center-area">
                        <i data-lucide="heart" class="w-8 h-8 text-pink-500 pulsing-heart fill-pink-600 mb-2"></i>
                        <h2 class="text-xs font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-300 fancy-font mb-1">ZONE OF DESIRE</h2>
                        <div id="mono-active-desc" class="text-[10px] font-bold text-white/90 leading-tight mt-1 px-1 border-t border-pink-500/30 pt-1">Roll to begin the seduction...</div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col items-center gap-4 w-full">
                    <div class="scene">
                        <div class="cube" id="dice-cube">
                            <div class="cube__face cube__face--1">1</div><div class="cube__face cube__face--2">2</div><div class="cube__face cube__face--3">3</div>
                            <div class="cube__face cube__face--4">4</div><div class="cube__face cube__face--5">5</div><div class="cube__face cube__face--6">6</div>
                        </div>
                    </div>
                    <button id="btn-roll-mono" onclick="window.rollMonopolyDice()" class="btn-gradient px-8 py-3 rounded-xl font-bold text-sm shadow-lg border border-white/20">ROLL DICE üé≤</button>
                    <p id="mono-msg" class="text-xs font-bold text-yellow-300 h-4">Roll to start...</p>
                </div>
            </div>
        </div>

        <!-- 7. CONTRACT SIGNING (Mobile-Optimized Width) -->
        <div id="screen-contract" class="screen">
            <!-- Adjusted max-w-lg to max-w-md on mobile -->
            <div class="contract-paper p-8 md:p-12 w-full max-w-md lg:max-w-lg shadow-2xl relative text-gray-900 mx-4" style="min-height: 500px;">
                <div class="lipstick-stamp hidden" id="contract-stamp">
                    <svg viewBox="0 0 100 60" fill="#be185d" xmlns="http://www.w3.org/2000/svg"><path d="M10,30 Q30,5 50,30 Q70,5 90,30 Q70,55 50,40 Q30,55 10,30 Z M20,30 Q50,60 80,30 Q50,45 20,30 Z" opacity="0.7"/><path d="M15,28 Q35,10 50,28 Q65,10 85,28 Q65,45 50,35 Q35,45 15,28 Z" fill="none" stroke="#9d174d" stroke-width="2"/></svg>
                </div>
                <div class="flex justify-between items-start border-b-2 border-pink-900/20 pb-4 mb-6">
                    <div><h2 class="text-3xl font-bold uppercase tracking-widest font-serif text-pink-900">Sweet Deal</h2><p class="text-xs italic font-serif opacity-70 mt-1 text-pink-800">Binding by desire, sealed with a kiss.</p></div>
                    <div class="text-right"><p class="text-[10px] uppercase tracking-wider text-pink-900/50">DATE</p><p id="contract-date" class="font-serif font-bold text-pink-900"></p></div>
                </div>
                <div class="font-serif text-lg leading-loose space-y-6 text-pink-950">
                    <p>I, <span id="contract-loser" class="font-bold border-b-2 border-dotted border-pink-400 px-2 text-pink-700">Name</span>, confess that I lost... fair and square.</p>
                    <p>My punishment is My pleasure. I promise to fulfill <span id="contract-winner" class="font-bold text-pink-700">Name</span>'s desire without complaint, hesitation, or clothes...If you want...</p>
                    <div class="bg-white/50 p-4 border border-pink-300 rounded-lg my-4 rotate-1 shadow-sm"><p class="text-xs uppercase font-bold text-pink-400 mb-1">The Demand:</p><p id="contract-title" class="text-xl font-bold font-serif text-center text-pink-800"></p></div>
                    <p class="text-sm italic opacity-70 mt-4 text-center">"Locked in the vault. No take-backs."</p>
                </div>
                <div class="mt-12 pt-6 border-t-2 border-pink-900/20 flex justify-between items-end">
                    <div class="text-center w-1/2"><div class="h-10 border-b border-pink-400 w-full mb-1 flex items-end justify-center"><span id="contract-sign-display" class="script-font text-3xl text-pink-600 transform -rotate-6"></span></div><p class="text-[10px] uppercase tracking-wider text-pink-400">Loser's Signature</p></div>
                </div>
                <button id="btn-sign-deal" onclick="window.signDeal()" class="mt-8 w-full py-4 bg-pink-900 text-white font-bold uppercase tracking-widest hover:bg-pink-800 transition-all shadow-lg text-sm rounded-lg">Seal with a Kiss üíã</button>
                <button id="btn-close-contract" onclick="window.showVault()" class="hidden mt-8 w-full py-4 bg-gray-800 text-white font-bold uppercase tracking-widest hover:bg-gray-900 transition-all shadow-lg text-sm rounded-lg">Close Contract</button>
            </div>
        </div>

        <!-- 8. VAULT (Mobile-Optimized Width) -->
        <div id="screen-vault" class="screen">
            <!-- Adjusted max-w-2xl to max-w-lg on mobile -->
            <div class="w-full max-w-lg glass-panel p-8 flex flex-col h-[85vh]">
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                    <h2 class="text-2xl font-bold fancy-font flex items-center gap-2">Contract Vault <i data-lucide="lock" class="w-5 h-5 text-amber-400"></i></h2>
                    <div class="flex gap-2">
                        <button onclick="window.openSecuritySettings()" class="p-2 hover:bg-white/10 rounded-full text-white/50 hover:text-white" title="Security Settings"><i data-lucide="shield-check" class="w-5 h-5"></i></button>
                        <button onclick="window.goToHome()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="window.filterVault('Him')" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20 text-xs font-bold uppercase tracking-widest text-blue-300">Him's Assets</button>
                    <button onclick="window.filterVault('Her')" class="p-3 rounded-lg bg-rose-500/10 border border-rose-500/30 hover:bg-rose-500/20 text-xs font-bold uppercase tracking-widest text-rose-300">Her's Assets</button>
                </div>
                <div id="vault-list" class="overflow-y-auto custom-scroll flex-grow space-y-4 pr-2"></div>
            </div>
        </div>

        <!-- SAVED (Mobile-Optimized Width) -->
        <div id="screen-saved" class="screen">
            <!-- Adjusted max-w-2xl to max-w-lg on mobile -->
            <div class="w-full max-w-lg glass-panel p-8 flex flex-col h-[80vh]">
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                    <h2 class="text-2xl font-bold fancy-font">Saved Stories</h2>
                    <button onclick="window.goToHome()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div id="saved-list" class="overflow-y-auto custom-scroll flex-grow space-y-4">
                     <p class='text-center opacity-50 mt-10'>Saved Stories feature is disabled in this version. Please start a new fantasy.</p>
                </div>
            </div>
        </div>

    </div>
<div id="screen-scratch" class="screen">
            <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[80vh]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                </button>
                
                <h2 class="text-3xl font-bold fancy-font text-yellow-400 mb-2">Hidden Desires üî•</h2>
                <p class="text-xs opacity-60 mb-6">Rub the screen to reveal your position...</p>

                <div class="relative w-full aspect-[3/4] max-h-[500px] rounded-2xl overflow-hidden shadow-2xl border-4 border-yellow-500/30">
                    
                    <div id="scratch-result-layer" class="absolute top-0 left-0 w-full h-full bg-black flex flex-col items-center justify-end pb-8 bg-cover bg-center transition-all duration-500">
                        <div class="bg-black/80 p-4 w-full backdrop-blur-sm border-t border-white/10">
                            <h3 id="scratch-title" class="text-2xl font-bold fancy-font text-yellow-300">Loading...</h3>
                            <p id="scratch-desc" class="text-sm text-white/90 leading-relaxed mt-1">...</p>
                        </div>
                    </div>

                    <canvas id="scratch-canvas" class="absolute top-0 left-0 w-full h-full cursor-crosshair touch-none"></canvas>
                    
                    <div id="scratch-hint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none animate-pulse">
                        <i data-lucide="hand" class="w-12 h-12 text-white/50"></i>
                    </div>
                </div>

                <button onclick="window.initScratch()" class="mt-8 btn-gradient px-8 py-3 rounded-xl font-bold text-sm shadow-lg border border-white/20">
                    NEW CARD üîÑ
                </button>
            </div>
        </div>
<div id="screen-dice" class="screen">
            <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                </button>

                <h2 class="text-3xl font-bold fancy-font text-orange-400 mb-2">Spice & Dice üé≤</h2>
                <p class="text-xs opacity-60 mb-8">Spin the wheels. Obey the command.</p>

                <div class="flex gap-4 w-full justify-center mb-8 relative">
                    
                    <div class="absolute top-1/2 left-0 w-full h-16 -translate-y-1/2 bg-white/5 border-y-2 border-orange-400/80 rounded-lg pointer-events-none z-20 shadow-[0_0_15px_rgba(251,146,60,0.3)]"></div>

                    <div class="wheel-container w-1/2 h-64 overflow-hidden relative bg-black/40 rounded-xl border border-white/10">
                        <div id="wheel-action" class="wheel-track transition-transform duration-[3000ms] ease-[cubic-bezier(0.1,0.9,0.2,1)]">
                            </div>
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-black via-black/80 to-transparent z-10 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black via-black/80 to-transparent z-10 pointer-events-none"></div>
                    </div>

                    <div class="wheel-container w-1/2 h-64 overflow-hidden relative bg-black/40 rounded-xl border border-white/10">
                        <div id="wheel-body" class="wheel-track transition-transform duration-[3500ms] ease-[cubic-bezier(0.1,0.9,0.2,1)]">
                            </div>
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-black via-black/80 to-transparent z-10 pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black via-black/80 to-transparent z-10 pointer-events-none"></div>
                    </div>
                </div>

                <div id="dice-result" class="h-16 flex items-center justify-center text-center w-full mb-6">
                    <p class="text-lg font-bold text-white opacity-0 transition-opacity duration-500">...</p>
                </div>

                <button onclick="window.spinSpiceDice()" id="btn-spin-dice" class="btn-gradient w-full py-4 rounded-xl font-bold text-xl shadow-lg border border-orange-500/30 flex justify-center items-center gap-3">
                    <i data-lucide="dices" class="w-6 h-6"></i> ROLL THE DICE
                </button>
            </div>
        </div>

        <div id="screen-bomb" class="screen">
            <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-red-900/30 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                </button>

                <h2 class="text-3xl font-black fancy-font text-red-500 mb-2 tracking-widest uppercase">PANIC MODE üí£</h2>
                <p class="text-xs text-red-300/70 mb-8 font-mono">PASS IT BEFORE IT EXPLODES!</p>

                <div class="relative w-48 h-48 flex items-center justify-center mb-8">
                    <div id="bomb-glow" class="absolute w-full h-full rounded-full bg-red-600/20 blur-xl opacity-0 transition-opacity duration-300"></div>
                    
                    <i data-lucide="bomb" id="bomb-icon" class="w-40 h-40 text-red-500 transition-transform duration-100"></i>
                    
                    <div id="bomb-timer-text" class="absolute text-white font-black text-4xl hidden">00</div>
                </div>

                <div id="bomb-task-area" class="w-full min-h-[100px] flex items-center justify-center text-center p-4 bg-red-950/40 rounded-xl border border-red-500/20 mb-6">
                    <p id="bomb-task-text" class="text-xl font-bold text-white">Press START to ignite...</p>
                </div>

                <button onclick="window.startBombGame()" id="btn-start-bomb" class="btn-gradient w-full py-4 rounded-xl font-bold text-xl shadow-lg bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-500 hover:to-rose-600 border border-red-400/30">
                    IGNITE FUSE üî•
                </button>

                <button onclick="window.passTheBomb()" id="btn-pass-bomb" class="hidden w-full py-4 rounded-xl font-bold text-xl bg-gray-800 hover:bg-gray-700 border border-white/20 text-white animate-pulse">
                    PASS THE BOMB! ‚è©
                </button>

                <div id="bomb-explosion" class="absolute inset-0 z-50 bg-red-600 flex flex-col items-center justify-center p-8 text-center hidden">
                    <h1 class="text-6xl font-black text-black mb-4 fancy-font">BOOM! üí•</h1>
                    <p class="text-white text-lg font-bold mb-6">YOU DIED (Kind of...)</p>
                    
                    <div class="bg-black/90 p-6 rounded-2xl border-4 border-yellow-400 w-full shadow-2xl">
                        <p class="text-xs text-yellow-400 uppercase tracking-widest mb-2">YOUR PUNISHMENT</p>
                        <p id="bomb-punishment-text" class="text-2xl font-bold text-white leading-tight">...</p>
                    </div>

                    <button onclick="window.resetBombGame()" class="mt-8 px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition-transform">
                        PLAY AGAIN üîÑ
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-blindfold" class="screen">
            <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-indigo-500/30 shadow-[0_0_50px_rgba(99,102,241,0.2)]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                </button>
<div id="blindfold-intro" class="text-center w-full">
                    <div class="w-24 h-24 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-indigo-400">
                        <i data-lucide="eye-off" class="w-12 h-12 text-indigo-300"></i>
                    </div>
                    <h2 class="text-3xl font-bold fancy-font text-indigo-300 mb-2">Sensory Play üôà</h2>
                    <p class="text-sm opacity-70 mb-8 px-4">
                        Pick who wears the blindfold first!<br>
                        Then guess the sensation.
                    </p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button onclick="window.startBlindfoldRound('Him')" class="py-4 rounded-xl font-bold text-lg bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 text-blue-200 transition-all">
                            HIM ‚ôÇÔ∏è
                        </button>
                        <button onclick="window.startBlindfoldRound('Her')" class="py-4 rounded-xl font-bold text-lg bg-pink-600/30 border border-pink-500/50 hover:bg-pink-600/50 text-pink-200 transition-all">
                            HER ‚ôÄÔ∏è
                        </button>
                    </div>
                    
                    <button onclick="window.startBlindfoldRound('Random')" class="btn-gradient w-full py-4 rounded-xl font-bold text-xl shadow-lg bg-gradient-to-r from-indigo-600 to-purple-700 hover:from-indigo-500 hover:to-purple-600 border border-indigo-400/30">
                        RANDOM TURN üé≤
                    </button>
                </div>

                <div id="blindfold-game" class="hidden flex-col items-center w-full text-center">
                    
                    <div class="mb-4 w-full bg-indigo-500/20 border border-indigo-400/50 p-3 rounded-xl animate-pulse">
                        <p class="text-[10px] uppercase tracking-widest text-indigo-200 mb-1">WHO WEARS THE BLINDFOLD?</p>
                        <h2 id="bf-turn-name" class="text-2xl font-black text-white fancy-font">...</h2>
                    </div>

                    <div class="mb-6">
                        <div class="text-5xl font-black text-indigo-400 tabular-nums" id="blindfold-timer">60</div>
                        <p class="text-[10px] uppercase tracking-widest opacity-50">Seconds Left</p>
                    </div>

                    <div class="bg-white/5 p-6 rounded-2xl border border-indigo-500/30 w-full mb-8 relative overflow-hidden text-left">
                        <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                        
                        <p class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1 font-bold">ACTION / TOOL:</p>
                        <h3 id="bf-tool" class="text-xl font-black text-white mb-4 leading-tight">Loading...</h3>
                        
                        <div class="h-px w-full bg-white/10 mb-4"></div>

                        <p class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1 font-bold">TARGET SPOT:</p>
                        <h3 id="bf-spot" class="text-xl font-black text-white leading-tight">Loading...</h3>
                    </div>

                    <button onclick="window.nextBlindfoldRound()" class="w-full py-4 rounded-xl font-bold text-lg bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-500/50 text-indigo-200 transition-all mb-2">
                        NEXT ROUND üîÑ
                    </button>
                    
                    <button onclick="window.stopBlindfoldGame()" class="text-xs opacity-50 hover:opacity-100 underline p-2">
                        End Game
                    </button>
                </div>

                <div id="bf-punishment-overlay" class="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 text-center hidden">
                    <div class="w-20 h-20 rounded-full bg-red-600/20 flex items-center justify-center mb-6 animate-bounce">
                        <i data-lucide="skull" class="w-10 h-10 text-red-500"></i>
                    </div>
                    
                    <h2 class="text-4xl font-black text-red-500 fancy-font mb-2">TIME'S UP! ‚ò†Ô∏è</h2>
                    <p class="text-xs text-red-300 uppercase tracking-widest mb-8">You failed to guess. Pay the price.</p>
                    
                    <div class="bg-red-900/20 p-6 rounded-2xl border border-red-500/50 w-full mb-8">
                        <p class="text-[10px] text-red-400 font-bold uppercase mb-2">YOUR PUNISHMENT:</p>
                        <h3 id="bf-punishment-text" class="text-lg font-bold text-white leading-relaxed">Loading...</h3>
                    </div>

                    <button onclick="window.closeBlindfoldPunishment()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg bg-white text-black hover:scale-105 transition-transform">
                        ACCEPT & CONTINUE ü©∏
                    </button>
                </div>
            </div>
        </div>
<div id="screen-risk" class="screen">
            <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-red-900/50 shadow-[0_0_60px_rgba(185,28,28,0.3)]">
                <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                </button>

                <div id="risk-intro" class="text-center w-full">
                    <div class="w-24 h-24 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-500 animate-pulse">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500"></i>
                    </div>
                    <h2 class="text-4xl font-black fancy-font text-red-500 mb-2">RISK IT ALL ‚ö†Ô∏è</h2>
                    <p class="text-sm opacity-70 mb-8 px-4">
                        Press to increase pleasure level.<br>
                        But beware... if it says <b>GAME OVER</b>, you lose clothes.<br>
                        <span class="text-xs text-red-400 font-bold block mt-2">HOW FAR WILL YOU GO?</span>
                    </p>
                    <button onclick="window.startRiskGame()" class="btn-gradient w-full py-4 rounded-xl font-bold text-xl shadow-lg bg-gradient-to-r from-red-700 to-orange-700 hover:from-red-600 hover:to-orange-600 border border-red-500/30">
                        START GAMBLING üé∞
                    </button>
                </div>

                <div id="risk-game" class="hidden flex-col items-center w-full text-center relative h-full justify-between py-4">
                    
                    <div class="w-full mb-4">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-white/50 mb-1">CURRENT RISK LEVEL</p>
                        <div class="flex items-center justify-center gap-2">
                            <span id="risk-level-display" class="text-4xl font-black text-white">1</span>
                            <span class="text-sm font-bold px-2 py-1 rounded bg-green-500/20 text-green-400 border border-green-500/50" id="risk-badge">SAFE</span>
                        </div>
                    </div>

                    <div class="flex-grow flex items-center justify-center w-full my-4">
                        <div class="bg-black/40 p-6 rounded-2xl border border-white/10 w-full backdrop-blur-sm">
                            <p class="text-xs text-white/40 uppercase tracking-widest mb-2">POTENTIAL REWARD:</p>
                            <h3 id="risk-current-task" class="text-2xl font-bold text-white leading-relaxed">A gentle kiss on the neck.</h3>
                        </div>
                    </div>

                    <div class="w-full space-y-4">
                        <button onclick="window.pressRedButton()" id="btn-risk-press" class="w-full h-24 rounded-2xl bg-gradient-to-b from-red-600 to-red-900 border-b-8 border-red-950 active:border-b-0 active:translate-y-2 transition-all shadow-[0_0_30px_rgba(220,38,38,0.4)] flex flex-col items-center justify-center group relative overflow-hidden">
                            <span class="text-2xl font-black text-white uppercase tracking-widest z-10 group-hover:scale-110 transition-transform">PRESS YOUR LUCK</span>
                            <span class="text-[10px] text-white/60 z-10 uppercase mt-1">Increase Level & Pleasure</span>
                            <div class="absolute inset-0 bg-red-500/0 group-hover:bg-red-500/20 transition-colors"></div>
                        </button>

                        <button onclick="window.bankRisk()" class="w-full py-4 rounded-xl font-bold text-lg bg-green-600/20 hover:bg-green-600/40 border border-green-500/50 text-green-300 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i> BANK (STOP & DO IT)
                        </button>
                    </div>
                </div>

                <div id="risk-bust-overlay" class="absolute inset-0 z-50 bg-red-950 flex flex-col items-center justify-center p-6 text-center hidden">
                    <i data-lucide="siren" class="w-20 h-20 text-red-500 mb-4 animate-bounce"></i>
                    <h2 class="text-5xl font-black text-red-500 fancy-font mb-2 glitch-text">BUSTED!</h2>
                    <p class="text-white text-lg font-bold mb-8">Greed killed the mood.</p>
                    
                    <div class="bg-black/50 p-6 rounded-xl border border-red-500 w-full mb-8">
                        <p class="text-xs text-red-400 font-bold uppercase mb-2">PENALTY:</p>
                        <h3 id="risk-penalty-text" class="text-xl font-bold text-white">Remove one piece of clothing immediately.</h3>
                    </div>
<div id="risk-banked-overlay" class="absolute inset-0 z-50 bg-green-950 flex flex-col items-center justify-center p-6 text-center hidden">
                    <div class="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center mb-6 animate-bounce">
                        <i data-lucide="check-circle" class="w-10 h-10 text-green-400"></i>
                    </div>
                    
                    <h2 class="text-4xl font-black text-green-400 fancy-font mb-2">BANKED! üí∞</h2>
                    <p class="text-white text-sm opacity-70 mb-6">Smart choice. You secured the pleasure.</p>
                    
                    <div class="bg-black/50 p-6 rounded-xl border border-green-500 w-full mb-8">
                        <p class="text-[10px] text-green-400 font-bold uppercase mb-2">YOUR REWARD:</p>
                        <h3 id="risk-banked-text" class="text-xl font-bold text-white leading-relaxed">...</h3>
                    </div>
                    
                    <p class="text-[10px] text-green-300/50 mb-6 uppercase tracking-widest">CONTRACT SEALED IN VAULT üîí</p>

                    <button onclick="window.closeRiskBanked()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition-transform">
                        CLAIM NOW üî•
                    </button>
                </div>

                    <button onclick="window.resetRiskGame()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200">TRY AGAIN üîÑ</button>
                </div>
            </div>
        </div>

     <div id="screen-distraction" class="screen">
    <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-cyan-500/30 shadow-[0_0_50px_rgba(34,211,238,0.2)]">
        <button onclick="window.goToHome(); window.stopDistractionGame();" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </button>

        <div id="distraction-intro" class="text-center w-full">
            <div class="w-24 h-24 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-cyan-500 animate-ping-slow">
                <i data-lucide="fingerprint" class="w-12 h-12 text-cyan-300"></i>
            </div>
            <h2 class="text-3xl font-black fancy-font text-cyan-400 mb-2">ENDURANCE TEST</h2>
            <p class="text-sm opacity-70 mb-8 px-4">
                Select the <b>Active Player</b>.<br>
                They must TAP the button non-stop for 90s.<br>
                The Partner must do whatever the screen says to distract them.<br>
                <span class="text-xs text-red-400 font-bold block mt-2">IF TAPPING STOPS = GAME OVER ‚ò†Ô∏è</span>
            </p>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window.startDistractionGame('Him')" class="py-4 rounded-xl font-bold text-lg bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 text-blue-200 transition-all">
                    HIM TAPS ‚ôÇÔ∏è<br><span class="text-[10px] opacity-60">(Her Distracts)</span>
                </button>
                <button onclick="window.startDistractionGame('Her')" class="py-4 rounded-xl font-bold text-lg bg-pink-600/30 border border-pink-500/50 hover:bg-pink-600/50 text-pink-200 transition-all">
                    HER TAPS ‚ôÄÔ∏è<br><span class="text-[10px] opacity-60">(Him Distracts)</span>
                </button>
            </div>
        </div>

        <div id="distraction-game" class="hidden flex-col items-center w-full text-center h-full justify-between">
            
            <div class="w-full mb-4">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-cyan-200 uppercase tracking-widest">SURVIVE TIME</span>
                    <span id="distract-timer" class="text-4xl font-black text-white tabular-nums">90</span>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div id="distract-progress" class="h-full bg-cyan-500 transition-all duration-1000 ease-linear w-full"></div>
                </div>
            </div>

            <div class="bg-red-900/20 p-6 rounded-2xl border border-red-500/50 w-full mb-6 backdrop-blur-md animate-pulse">
                <p class="text-[10px] text-red-300 uppercase tracking-widest mb-2 font-bold flex items-center justify-center gap-2">
                    <i data-lucide="flame" class="w-3 h-3"></i> PARTNER'S MISSION:
                </p>
                <h3 id="distract-task" class="text-xl font-bold text-white leading-relaxed">Loading distraction...</h3>
            </div>

            <button id="btn-tap-zone" class="w-48 h-48 rounded-full bg-gradient-to-br from-cyan-600 to-blue-700 border-4 border-cyan-400 shadow-[0_0_40px_rgba(34,211,238,0.5)] flex flex-col items-center justify-center active:scale-95 transition-transform touch-manipulation">
                <i data-lucide="fingerprint" class="w-20 h-20 text-white mb-2"></i>
                <span class="text-xs font-bold text-white uppercase tracking-widest">TAP FAST!</span>
            </button>
            
            <p class="text-[10px] text-white/40 mt-4 uppercase tracking-widest">Don't stop for even a second...</p>
        </div>

        <div id="distract-fail-overlay" class="absolute inset-0 z-50 bg-red-950/95 flex flex-col items-center justify-center p-6 text-center hidden">
            <i data-lucide="siren" class="w-20 h-20 text-red-500 mb-4 animate-bounce"></i>
            <h2 class="text-5xl font-black text-red-500 fancy-font mb-2">FAILED!</h2>
            <p class="text-white text-lg font-bold mb-8">You got distracted.</p>
            
            <div class="bg-black/50 p-6 rounded-xl border border-red-500 w-full mb-8">
                <p class="text-xs text-red-400 font-bold uppercase mb-2">PUNISHMENT:</p>
                <h3 id="distract-punishment" class="text-xl font-bold text-white leading-relaxed">...</h3>
            </div>

            <button onclick="window.initDistraction()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition-transform">
                TRY AGAIN üîÑ
            </button>
        </div>

        <div id="distract-win-overlay" class="absolute inset-0 z-50 bg-green-950/95 flex flex-col items-center justify-center p-6 text-center hidden">
            <i data-lucide="trophy" class="w-20 h-20 text-yellow-400 mb-4 animate-bounce"></i>
            <h2 class="text-4xl font-black text-green-400 fancy-font mb-2">SURVIVOR!</h2>
            <p class="text-white text-sm opacity-80 mb-6">You resisted the temptation (barely).</p>
            
            <div class="bg-black/50 p-6 rounded-xl border border-green-500 w-full mb-8">
                <p class="text-[10px] text-green-400 font-bold uppercase mb-2">YOUR REWARD:</p>
                <h3 id="distract-reward" class="text-xl font-bold text-white leading-relaxed">...</h3>
            </div>

            <button onclick="window.claimDistractReward()" class="btn-gradient px-8 py-3 rounded-xl font-bold text-lg shadow-lg">
                CLAIM REWARD üèÜ
            </button>
        </div>
    </div>
</div>

<div id="screen-sls" class="screen">
    <div class="w-full max-w-lg glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-pink-600/30 shadow-[0_0_60px_rgba(236,72,153,0.2)]">
        <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </button>

        <div id="sls-intro" class="text-center w-full">
            <div class="flex justify-between items-center mb-6 px-4">
                <div class="text-left">
                    <p class="text-[10px] uppercase text-pink-400 font-bold">CURRENT TURN</p>
                    <h2 id="sls-turn-text" class="text-2xl font-black text-white fancy-font">Him</h2>
                </div>
                <div class="w-16 h-16 bg-pink-500/20 rounded-full flex items-center justify-center border-2 border-pink-500 animate-pulse">
                    <span class="text-3xl">üé∞</span>
                </div>
            </div>

            <h2 class="text-3xl font-black fancy-font text-pink-400 mb-2">SENSORY TRIO</h2>
            <p class="text-sm opacity-80 mb-8 px-4">
                Spin the slots for a spicy combo.<br>
                <b>15% Chance for a JACKPOT.</b><br>
                Jackpots are personalized for the winner.
            </p>
            
            <button onclick="window.spinSLS()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-lg">SPIN NOW üé∞</button>
        </div>

        <div id="sls-result" class="hidden flex-col items-center w-full text-center">
            
            <div class="space-y-4 w-full mb-8">
                <div class="bg-black/40 border border-pink-500/30 p-4 rounded-xl relative overflow-hidden group transition-all duration-300" id="slot-box-1">
                    <p class="text-[10px] uppercase text-pink-400 font-bold mb-1">ACTION</p>
                    <h3 id="sls-action" class="text-3xl font-black text-white fancy-font">...</h3>
                </div>

                <div class="bg-black/40 border border-pink-500/30 p-4 rounded-xl relative overflow-hidden group transition-all duration-300" id="slot-box-2">
                    <p class="text-[10px] uppercase text-pink-400 font-bold mb-1">BODY PART</p>
                    <h3 id="sls-body" class="text-3xl font-black text-white fancy-font">...</h3>
                </div>

                <div class="bg-black/40 border border-pink-500/30 p-4 rounded-xl relative overflow-hidden group transition-all duration-300" id="slot-box-3">
                    <p class="text-[10px] uppercase text-pink-400 font-bold mb-1">DURATION / TWIST</p>
                    <h3 id="sls-time" class="text-2xl font-bold text-yellow-300">...</h3>
                </div>
            </div>

            <button onclick="window.resetSLS()" class="w-full py-4 rounded-xl bg-white/10 hover:bg-white/20 border border-white/10 font-bold text-lg">
                NEXT TURN üîÑ
            </button>
        </div>
    </div>
</div>

<div id="screen-pandora" class="screen">
    <div class="w-full max-w-lg glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-purple-600/30 shadow-[0_0_80px_rgba(147,51,234,0.15)] overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-transparent to-transparent pointer-events-none"></div>

        <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </button>

        <div id="pandora-intro" class="text-center w-full relative z-10">
            
            <div class="mb-6 flex justify-center items-center gap-3">
                <span class="text-xs font-bold uppercase tracking-widest text-white/50">CURRENT FATE:</span>
                <span id="pandora-turn-display" class="text-2xl font-black text-white fancy-font">...</span>
            </div>

            <div class="w-24 h-24 bg-purple-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-purple-500 shadow-[0_0_30px_#9333ea] animate-float">
                <i data-lucide="box" class="w-12 h-12 text-purple-300"></i>
            </div>
            <h2 class="text-4xl font-black fancy-font text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300 mb-2">PANDORA'S BOX</h2>
            <p class="text-sm opacity-70 mb-8 px-4 leading-relaxed font-medium">
                3 <span class="text-green-400 font-bold">Angels üòá</span> (Rewards)<br>
                3 <span class="text-red-400 font-bold">Devils üòà</span> (Punishments)<br>
                3 <span class="text-gray-400 font-bold">Empty ‚ùå</span> (Safe)<br><br>
                Open <b>3 Boxes</b> to seal your fate.
            </p>
            <button onclick="window.startPandora()" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-105 transition-transform border border-purple-400/30">
                UNLOCK FATE üóùÔ∏è
            </button>
        </div>

        <div id="pandora-game" class="hidden w-full flex-col items-center relative z-10">
            <div class="flex justify-between items-center w-full mb-6 px-4 py-3 bg-black/40 rounded-xl border border-white/10">
                <div class="flex gap-4">
                    <span class="text-green-400 font-bold text-sm flex items-center gap-1"><i data-lucide="halo" class="w-4 h-4"></i> <span id="score-angel-disp">0</span></span>
                    <span class="text-red-400 font-bold text-sm flex items-center gap-1"><i data-lucide="flame" class="w-4 h-4"></i> <span id="score-devil-disp">0</span></span>
                </div>
                <p class="text-xs font-bold text-purple-200 tracking-widest">OPENED: <span id="pandora-count" class="text-white text-lg">0</span>/3</p>
            </div>

            <div id="pandora-grid" class="grid grid-cols-3 gap-4 w-full aspect-square p-2">
                </div>
            
            <p id="pandora-msg" class="mt-6 text-xs font-bold text-purple-300/50 uppercase tracking-[0.2em] animate-pulse">Choose Wisely...</p>
        </div>

        <div id="pandora-result" class="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 text-center hidden opacity-0 transition-opacity duration-500">
            <div id="pandora-final-icon" class="mb-6 transform scale-0 transition-transform duration-500 delay-100"></div>
            
            <h2 id="pandora-final-title" class="text-4xl font-black text-white fancy-font mb-4 tracking-wide">...</h2>
            
            <div class="bg-white/5 p-1 rounded-2xl border border-white/10 w-full mb-8 backdrop-blur-md">
                <div class="bg-black/40 p-6 rounded-xl">
                    <p class="text-[10px] font-bold uppercase mb-3 opacity-50 tracking-widest">FATE SEALED FOR <span id="pandora-result-name">PLAYER</span></p>
                    <h3 id="pandora-final-desc" class="text-xl font-bold text-white leading-relaxed">...</h3>
                </div>
            </div>

            <button onclick="window.rotatePandoraTurn()" class="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition-colors shadow-lg">
                PASS TURN üîÑ
            </button>
        </div>
    </div>
</div>

<style>
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .animate-float { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
</style>

<div id="screen-lip" class="screen">
    <div class="w-full max-w-lg glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-teal-600/30 shadow-[0_0_60px_rgba(20,184,166,0.2)]">
        <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </button>

        <div id="lip-intro" class="text-center w-full">
            <div class="w-24 h-24 bg-teal-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-teal-500 animate-pulse">
                <span class="text-4xl">ü§´</span>
            </div>
            <h2 class="text-3xl font-black fancy-font text-teal-400 mb-2">LIP LUST CHALLENGE</h2>
            <p class="text-sm opacity-80 mb-8 px-4">
                1. One wears <b>Headphones</b> (Loud Music).<br>
                2. The other <b>Whispers</b> the phrase on screen.<br>
                3. Guess it correctly to Win.<br>
                <span class="text-red-400 font-bold block mt-2">WRONG GUESS = PUNISHMENT</span>
            </p>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window.startLipGame('Him')" class="py-4 rounded-xl font-bold text-lg bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 text-blue-200">
                    HIM GUESSES üéß
                </button>
                <button onclick="window.startLipGame('Her')" class="py-4 rounded-xl font-bold text-lg bg-pink-600/30 border border-pink-500/50 hover:bg-pink-600/50 text-pink-200">
                    HER GUESSES üéß
                </button>
            </div>
        </div>

        <div id="lip-game" class="hidden w-full flex-col items-center text-center">
            
            <p class="text-xs font-bold uppercase tracking-widest text-teal-200/50 mb-4">WHISPER THIS PHRASE:</p>

            <div class="w-full bg-black/40 border-2 border-teal-500/30 p-8 rounded-2xl mb-8 relative overflow-hidden group">
                <h2 id="lip-phrase" class="text-2xl md:text-3xl font-black text-white fancy-font leading-relaxed">...</h2>
            </div>

            <p class="text-sm opacity-60 mb-6 italic">Did they guess it right?</p>

            <div class="grid grid-cols-2 gap-4 w-full">
                <button onclick="window.lipResult(false)" class="py-4 rounded-xl bg-red-900/40 border border-red-500/50 text-red-300 font-bold hover:bg-red-900/60">
                    ‚ùå NOPE (Punish)
                </button>
                <button onclick="window.lipResult(true)" class="py-4 rounded-xl bg-green-900/40 border border-green-500/50 text-green-300 font-bold hover:bg-green-900/60">
                    ‚úÖ YES (Reward)
                </button>
            </div>
            
            <button onclick="window.nextLipPhrase()" class="mt-6 text-xs font-bold uppercase tracking-widest text-white/30 hover:text-white border-b border-transparent hover:border-white transition-all">Skip Phrase</button>
        </div>

        <div id="lip-overlay" class="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 text-center hidden">
            <div id="lip-icon-area" class="mb-4"></div>
            <h2 id="lip-title" class="text-4xl font-black text-white fancy-font mb-4">...</h2>
            
            <div class="bg-white/10 p-6 rounded-xl border border-white/20 w-full mb-8">
                <p class="text-[10px] font-bold uppercase mb-2 opacity-70" id="lip-type-label">TASK:</p>
                <h3 id="lip-desc" class="text-xl font-bold text-white leading-relaxed">...</h3>
            </div>

            <button onclick="window.initLipGame()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition-transform">
                NEXT ROUND üîÑ
            </button>
        </div>
    </div>
</div>

<div id="screen-roulette" class="screen">
    <div class="w-full max-w-md glass-panel p-6 relative flex flex-col items-center justify-center min-h-[85vh] border-2 border-slate-600/50 shadow-[0_0_60px_rgba(71,85,105,0.3)]">
        <button onclick="window.goToHome()" class="absolute top-4 left-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-20">
            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </button>

        <div id="roulette-intro" class="text-center w-full">
            <i data-lucide="crosshair" class="w-20 h-20 text-slate-400 mx-auto mb-6"></i>
            <h2 class="text-3xl font-black fancy-font text-slate-200 mb-2">EROS ROULETTE</h2>
            <p class="text-sm opacity-70 mb-8 px-4">
                6 Chambers. 1 Bullet.<br>
                Take turns pulling the trigger.<br>
                <b>Safe?</b> You get Pleasure.<br>
                <b>Bang?</b> You get PUNISHED.
            </p>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window.startRouletteGame('Him')" class="py-4 rounded-xl font-bold text-lg bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 text-blue-200 transition-all">
                    HIM STARTS ‚ôÇÔ∏è
                </button>
                <button onclick="window.startRouletteGame('Her')" class="py-4 rounded-xl font-bold text-lg bg-pink-600/30 border border-pink-500/50 hover:bg-pink-600/50 text-pink-200 transition-all">
                    HER STARTS ‚ôÄÔ∏è
                </button>
            </div>
        </div>

        <div id="roulette-game" class="hidden flex-col items-center w-full text-center relative h-full justify-center">
            
            <div class="mb-8 text-center">
                <p class="text-[10px] uppercase tracking-widest text-white/50 mb-1">CURRENT TURN</p>
                <h2 id="roulette-turn" class="text-3xl font-black text-white fancy-font">...</h2>
            </div>

            <div class="relative w-64 h-64 mb-8 flex items-center justify-center">
                <div id="cylinder-visual" class="w-full h-full rounded-full border-8 border-slate-700 relative transition-transform duration-[200ms] ease-out shadow-inner bg-slate-900">
                    <div class="absolute top-2 left-1/2 -translate-x-1/2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    <div class="absolute top-1/4 left-2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    <div class="absolute top-1/4 right-2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    <div class="absolute bottom-1/4 left-2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    <div class="absolute bottom-1/4 right-2 w-12 h-12 bg-black rounded-full shadow-inner border border-slate-600"></div>
                    
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-slate-600 rounded-full flex items-center justify-center shadow-lg">
                        <span id="shots-left" class="text-xs font-bold text-black">6 Left</span>
                    </div>
                </div>
            </div>

            <p id="roulette-status" class="text-sm font-mono text-slate-400 mb-6 h-6">Spinning cylinder...</p>

            <button onclick="window.pullTrigger()" id="btn-trigger" class="w-full py-5 rounded-xl font-black text-xl bg-gradient-to-r from-slate-700 to-slate-900 border border-slate-500 hover:scale-105 transition-transform shadow-xl text-red-500 uppercase tracking-widest">
                PULL TRIGGER ‚ò†Ô∏è
            </button>
        </div>

        <div id="roulette-safe-overlay" class="absolute inset-0 z-40 bg-black/90 flex flex-col items-center justify-center p-6 text-center hidden">
            <div class="text-green-500 text-6xl mb-4 font-black">CLICK.</div>
            <p class="text-white/60 text-sm uppercase tracking-widest mb-6">You survived.</p>
            
            <div class="bg-white/10 p-6 rounded-xl border border-green-500/50 w-full mb-8">
                <p class="text-[10px] text-green-400 font-bold uppercase mb-2">PLEASURE REWARD:</p>
                <h3 id="roulette-safe-task" class="text-lg font-bold text-white leading-relaxed">...</h3>
            </div>

            <button onclick="window.nextRouletteTurn()" class="px-8 py-3 bg-white text-black font-bold rounded-full">
                PASS THE GUN üî´
            </button>
        </div>

        <div id="roulette-dead-overlay" class="absolute inset-0 z-50 bg-red-950 flex flex-col items-center justify-center p-6 text-center hidden">
            <div class="animate-ping absolute w-full h-full bg-red-600/20 rounded-full"></div>
            <h2 class="text-7xl font-black text-white fancy-font mb-2 relative z-10">BANG!</h2>
            <i data-lucide="skull" class="w-20 h-20 text-white mb-6 mt-4 relative z-10"></i>
            
            <div class="bg-black/60 p-6 rounded-xl border-2 border-red-500 w-full mb-8 relative z-10 shadow-2xl">
                <p class="text-xs text-red-500 font-bold uppercase mb-2 bg-black px-2 inline-block">FATAL PUNISHMENT</p>
                <h3 id="roulette-death-task" class="text-2xl font-black text-white leading-tight">...</h3>
            </div>

            <button onclick="window.initRoulette()" class="px-8 py-3 bg-white text-black font-bold rounded-full relative z-10 hover:scale-105 transition-transform">
                NEW ROUND üîÑ
            </button>
        </div>
    </div>
</div>

    <script type="module">
        // Firebase imports are removed as requested. The app now relies on local storage and P2P (PeerJS).

        // --- LICENSING STATE & MOCK SERVER SETUP (NEW) ---
        const MOCK_SECRET = "IntimateSpark_Key_Secret_2024"; // The secret key used for encryption (Server-side Secret)
        const LICENSED_KEY = 'app_licensed_key'; // localStorage key for the stored license
        const DEVICE_ID_KEY = 'app_device_id'; // localStorage key for the generated device ID
        const LICENSE_STATUS_KEY = 'is_app_licensed'; // localStorage key for the simple status flag

        // --- MOCK SERVER DATABASE (In a real app, this would be a database) ---
        // This is where you would manually add the license keys you sell (Example Keys)
        // Format: Key: Status (Unused/Active/Revoked), Linked_ID (Encrypted/NULL)
        const MOCK_DB = {
            "A7BG-49GH-21JK-LP0D": { status: "Unused", linkedId: null },
            "B8CH-50IA-22KL-MQ1E": { status: "Unused", linkedId: null },
            "C9DI-61JB-33LM-MQ2F": { status: "Unused", linkedId: null },
            // Add keys as you sell them
        };

        // Function to Generate a (Pseudo) Unique Device ID
        window.getDeviceId = () => {
            let id = localStorage.getItem(DEVICE_ID_KEY);
            if (!id) {
                id = 'DEV-' + crypto.randomUUID().toUpperCase().substring(0, 15);
                localStorage.setItem(DEVICE_ID_KEY, id);
            }
            return id;
        };

        // Function to Encrypt the Key with the Device ID (Mimicking Server Linking)
        window.encryptKey = (key, deviceId) => {
            const data = key + "|" + deviceId;
            return CryptoJS.AES.encrypt(data, MOCK_SECRET).toString();
        };

        // Function to Decrypt and Check if the Key Matches (Mimicking Server Validation)
        window.decryptAndCheck = (encryptedKey) => {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedKey, MOCK_SECRET);
                const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                const [originalKey, linkedId] = decryptedText.split('|');
                
                if (originalKey && linkedId) {
                    return { key: originalKey, deviceId: linkedId };
                }
            } catch (e) {
                return null;
            }
            return null;
        };
        
        // MOCK SERVER API: Validates Key, Links Device, and returns new Database state
        window.mockServerVerify = (passkey, deviceId) => {
            return new Promise((resolve) => {
                setTimeout(() => { // Mimic network delay
                    const keyData = MOCK_DB[passkey];
                    
                    if (!keyData) {
                        return resolve({ success: false, message: "Invalid Passkey." });
                    }

                    if (keyData.status === "Revoked") {
                        return resolve({ success: false, message: "Passkey has been revoked." });
                    }

                    if (keyData.status === "Active") {
                        // Check if the key is active on *this* device
                        const decrypted = window.decryptAndCheck(keyData.linkedId);
                        if (decrypted && decrypted.deviceId === deviceId) {
                            return resolve({ success: true, message: "Already Active on this device." });
                        } else {
                            // Active on another device
                            return resolve({ success: false, message: "Passkey is already active on another device." });
                        }
                    }

                    // Key is "Unused" -> Activate it
                    const encryptedId = window.encryptKey(passkey, deviceId);
                    
                    // In a real server, you would update the database here.
                    MOCK_DB[passkey].status = "Active";
                    MOCK_DB[passkey].linkedId = encryptedId;

                    return resolve({ success: true, message: "Passkey successfully activated and linked.", encryptedKey: encryptedId });

                }, 1500);
            });
        };

        // Main Check on App Load
        window.checkLicensingStatus = () => {
            const isLicensed = localStorage.getItem(LICENSE_STATUS_KEY) === 'true';
            const storedKey = localStorage.getItem(LICENSED_KEY);
            
            if (isLicensed && storedKey) {
                const check = window.decryptAndCheck(storedKey);
                // Check if the stored key is valid for this device
                if (check && check.deviceId === window.getDeviceId()) {
                    document.getElementById('licensing-screen').classList.add('hidden');
                    return true;
                }
            }
            
            document.getElementById('licensing-screen').classList.remove('hidden');
            document.getElementById('screen-setup').classList.add('hidden');
            return false;
        };

        // User Initiated Verification
        window.verifyPasskey = async () => {
            const input = document.getElementById('passkey-input');
            const statusEl = document.getElementById('passkey-status');
            const button = document.getElementById('verify-button');
            const passkey = input.value.trim().toUpperCase();
            const deviceId = window.getDeviceId();

            if (passkey.length < 10) {
                statusEl.textContent = "Please enter a valid Passkey.";
                statusEl.classList.remove('hidden', 'text-green-400');
                statusEl.classList.add('text-red-400');
                return;
            }

            // UI state: Loading
            button.disabled = true;
            button.textContent = "VERIFYING...";
            statusEl.textContent = "Checking Server, Please wait...";
            statusEl.classList.remove('hidden', 'text-red-400');
            statusEl.classList.add('text-yellow-400');
            
            const result = await window.mockServerVerify(passkey, deviceId);

            // UI state: Done
            button.disabled = false;
            button.textContent = "UNLOCK APP";
            statusEl.classList.remove('text-yellow-400');

            if (result.success) {
                // Save encrypted key and license flag locally
                localStorage.setItem(LICENSED_KEY, result.encryptedKey);
                localStorage.setItem(LICENSE_STATUS_KEY, 'true');

                statusEl.textContent = "SUCCESS! App Unlocked and Linked to this Device.";
                statusEl.classList.add('text-green-400');
                
                window.showFeedback("App successfully verified and unlocked!", false);
                
                setTimeout(() => {
                    document.getElementById('licensing-screen').classList.add('hidden');
                    // Explicitly call showScreen to start the app flow after successful verification
                    window.showScreen('setup');
                }, 1000);
            } else {
                statusEl.textContent = `ERROR: ${result.message} (${passkey} is Invalid/Used)`;
                statusEl.classList.add('text-red-400');
            }
        };

        // --- END LICENSING LOGIC ---


        // --- GLOBAL HELPERS & VARS ---
        window.state = {
            names: { Him: "Him", Her: "Her" },
            theme: "red",
            todTurn: "Him", // Default starting turn
            story: { role: null, type: null, actor: null, diff: 1 },
            currentAIStory: "",
            rps: { p1Move: null, p2Move: null, currentCoupon: null, resultStatus: null, tempWinner: null, tempLoser: null, isAutoSaved: false },
            vault: [],
            monopoly: { p1: 0, p2: 0, turn: 'Him', isRolling: false, lastRoll: 0 },
            dice: { isRolling: false },
            // SECURITY STATE
            passwords: JSON.parse(localStorage.getItem('vaultPasswords')) || { Him: null, Her: null },
            tempAuth: { action: null, targetId: null, role: null },
            // MULTIPLAYER STATE (NEW)
            isMultiplayer: false,
            myRole: null, 
            myPeer: null,
            connection: null,
            peerId: null,
            isHost: false,
            // MERGED STATE: NHIE
            nhie: { currentQ: 0, himScore: 5, herScore: 5, turn: 'Him', statements: [] },
            // MERGED STATE: MEMORY
            memory: { 
                cards: [], 
                flipped: [], 
                matched: [], 
                turn: 'Him', 
                score: { Him: 0, Her: 0 }, 
                isLocked: false, 
                tempMatch: 0 
            },
            // MOVIE STATE (NEW) - UPDATED WITH LANGUAGE/INDUSTRY
            movie: { genre: null, industry: null, language: null, history: [] },
            // NEW API KEY STATE
            geminiKey: localStorage.getItem('geminiApiKey') || null, 
            pendingAction: null // Stores the function to call after key is saved
        };

        let timerInterval = null;
        let couponStatus = JSON.parse(localStorage.getItem('couponStatus')) || {};
        let savedVault = JSON.parse(localStorage.getItem('contractVault')) || [];
        const lastReset = localStorage.getItem('lastReset');
        const today = new Date().toDateString();
        
        // Reset coupons daily for fresh battles
        if(lastReset !== today) {
            couponStatus = {};
            localStorage.setItem('couponStatus', JSON.stringify(couponStatus));
            localStorage.setItem('lastReset', today);
        }

        // Custom Feedback Function (Replacing all alert() and confirm())
        window.showFeedback = (message, isError = false) => {
            const container = document.getElementById('feedback-container');
            container.innerHTML = '';
            
            const feedbackEl = document.createElement('div');
            feedbackEl.id = 'temp-feedback';
            feedbackEl.className = `p-4 rounded-b-xl shadow-2xl transition-all duration-300 transform ${isError ? 'bg-red-700' : 'bg-green-700'} text-white font-bold opacity-0 -translate-y-full`;
            feedbackEl.textContent = message;
            container.appendChild(feedbackEl);

            setTimeout(() => { feedbackEl.classList.remove('opacity-0', '-translate-y-full'); }, 10);
            
            setTimeout(() => {
                feedbackEl.classList.add('-translate-y-full', 'opacity-0');
                setTimeout(() => feedbackEl.remove(), 300);
            }, 3000);
        };
        
        // Helper function to copy text
        window.copyToClipboard = (elementId) => {
            const el = document.getElementById(elementId);
            const textToCopy = el.textContent.trim();
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                window.showFeedback("Code copied! Send this Invitation to your Lover.");
            } catch (err) {
                window.showFeedback("Copy failed. Manually copy the code.", true);
            }
            document.body.removeChild(textarea);
        };

        window.applyTheme = (t) => {
            window.state.theme = t; 
            const th = { 
                red: { bg: '#0f0505', grad: '#450a0a', accent: '#ef4444', dark: '#991b1b', glass: '40, 10, 10' },
                maroon: { bg: '#1a0505', grad: '#3f0e0e', accent: '#9f1239', dark: '#881337', glass: '50, 5, 5' },
                hotpink: { bg: '#1f0516', grad: '#500738', accent: '#ec4899', dark: '#be185d', glass: '50, 10, 40' },
                purple: { bg: '#0f0518', grad: '#3b0764', accent: '#a855f7', dark: '#6b21a8', glass: '30, 5, 40' },
                blue: { bg: '#020617', grad: '#172554', accent: '#3b82f6', dark: '#1e40af', glass: '5, 15, 40' },
                emerald: { bg: '#021408', grad: '#064e3b', accent: '#10b981', dark: '#047857', glass: '5, 40, 15' },
                gold: { bg: '#161002', grad: '#422006', accent: '#fbbf24', dark: '#b45309', glass: '40, 30, 5' },
                black: { bg: '#000000', grad: '#18181b', accent: '#71717a', dark: '#27272a', glass: '20, 20, 20' }
            }[t] || { bg: '#0f0505', grad: '#450a0a', accent: '#ef4444', dark: '#991b1b', glass: '40, 10, 10' };
            const r = document.documentElement.style;
            r.setProperty('--bg-color', th.bg); r.setProperty('--bg-grad', th.grad); r.setProperty('--accent-color', th.accent); r.setProperty('--dark-accent-color', th.dark); r.setProperty('--glass-rgb', th.glass); r.setProperty('--card-front-1', th.bg); r.setProperty('--card-front-2', th.grad);
        };

        window.updateTimers = () => {
            document.querySelectorAll('.timer-display').forEach(el => {
                const target = parseInt(el.getAttribute('data-target'));
                const diff = target - Date.now();
                if (diff <= 0) { el.textContent = "Refreshing..."; location.reload(); }
                else {
                    const hrs = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    el.textContent = `Resets in: ${hrs}h ${mins}m`;
                }
            });
        };

        window.startTimerInterval = () => { if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(window.updateTimers, 1000); };
        window.stopTimerInterval = () => { if (timerInterval) clearInterval(timerInterval); };

        // Music setup (Unchanged)
        const musicTracks = [
            { title: "Midnight Whisper", url: "https://files.catbox.moe/ctp28w.mp3" },
            { title: "Deep Connection", url: "https://files.catbox.moe/tsxafc.mp3" },
            { title: "Slow Burn", url: "https://files.catbox.moe/mjnnzi.mp3" },
            { title: "Rhythmic Touch", url: "https://files.catbox.moe/ted4cp.mp3" },
            { title: "Afterglow", url: "https://files.catbox.moe/gsox20.mp3" },
            { title: "Those Eyes", url: "https://files.catbox.moe/fh9v4n.mp3" },
            { title: "Promises", url: "https://files.catbox.moe/bd9uce.mp3" },
            { title: "Dance with devil", url: "https://files.catbox.moe/tbrmen.mp3" },
            { title: "They call this love", url: "https://files.catbox.moe/wvmova.mp3" },
            { title: "I See Red", url: "https://files.catbox.moe/6cvy23.mp3" },
            { title: "Until I found you", url: "https://files.catbox.moe/uhbu5v.mp3" },
            { title: "Looking At The Devil", url: "https://files.catbox.moe/zggy8d.mp3" },
            { title: "I'll Make You Love Me", url: "https://files.catbox.moe/za8pws.mp3" },
            { title: "Where are You", url: "https://files.catbox.moe/x64jyy.mp3" }            
        ];
        let audio = new Audio();
        let currentTrackIndex = 0;
        let isMusicPlaying = false;

        window.toggleMusicPanel = () => document.getElementById('music-panel').classList.toggle('active');
        window.initMusicPlayer = () => {
            const list = document.getElementById('track-list'); list.innerHTML = '';
            musicTracks.forEach((track, index) => {
                const el = document.createElement('div'); el.className = 'music-track rounded-lg'; el.id = `track-${index}`;
                el.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="music" class="w-4 h-4"></i><span class="text-sm font-bold opacity-80">${track.title}</span></div><div class="flex gap-1 items-end h-4 mr-2 opacity-0 playing-indicator"><div class="equalizer-bar eq-1"></div><div class="equalizer-bar eq-2"></div><div class="equalizer-bar eq-3"></div></div>`;
                el.onclick = () => window.playTrack(index);
                list.appendChild(el);
            });
            if (window.lucide) lucide.createIcons();
            audio.onended = () => { const nextIndex = (currentTrackIndex + 1) % musicTracks.length; window.playTrack(nextIndex); };
        };
        window.playTrack = (index) => {
            if (currentTrackIndex === index && isMusicPlaying) { audio.pause(); isMusicPlaying = false; } else { audio.src = musicTracks[index].url; currentTrackIndex = index; audio.play().then(() => isMusicPlaying = true).catch(e => console.log("Auto-play blocked:", e)); }
            updateMusicUI();
        };
        window.setVolume = (val) => audio.volume = val;
        function updateMusicUI() {
            document.querySelectorAll('.music-track').forEach(el => { el.classList.remove('playing'); el.querySelector('.playing-indicator').style.opacity = '0'; });
            const active = document.getElementById(`track-${currentTrackIndex}`);
            if (isMusicPlaying && active) { active.classList.add('playing'); active.querySelector('.playing-indicator').style.opacity = '1'; document.getElementById('music-indicator').classList.remove('hidden'); } else { document.getElementById('music-indicator').classList.add('hidden'); }
        }

       window.showScreen = (id) => {
    // 1. License Check
    if (!window.checkLicensingStatus() && id !== 'setup') return;

    // 2. Navigation Logic (Screens Hide/Show)
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('main-header').classList.remove('opacity-0', 'pointer-events-none');
    
    setTimeout(() => document.querySelectorAll('.screen').forEach(s => s.style.display = 'none'), 300);
    
    setTimeout(() => { 
        const target = document.getElementById(`screen-${id}`); 
        if(target) {
            target.style.display = 'flex'; 
            setTimeout(() => target.classList.add('active'), 50); 
        }
    }, 300);
    
    // Background Cleanup
    if(id === 'home') document.getElementById('bg-decoration').innerHTML = '';
    
    // Game Specific Inits
    if(id === 'coupons') { window.renderCoupons(); if(window.startTimerInterval) window.startTimerInterval(); } 
    else { if(window.stopTimerInterval) window.stopTimerInterval(); }
    if(id === 'vault') { window.renderVault(); }
    if(id === 'monopoly') { window.renderMonopolyBoard(); }
    if(id === 'setup') document.getElementById('main-header').classList.add('opacity-0', 'pointer-events-none');

    // --- 3. LIVE STATUS UPDATE (ALL 18 GAMES LIST) ---
    if (window.state && window.state.isMultiplayer) {
        
        // Yahan maine saari games ki list bana di hai
        const gameNames = {
            'home': 'Home Screen',
            'tod': 'Truth or Dare',
            'cards': 'Mystery Cards',
            'movies': 'AI Movie Date',
            'story': 'AI Fantasies',
            'coupons': 'Coupon Battle',
            'nhie': 'Never Have I Ever',
            'memory': 'Memory Match',
            'monopoly': 'Monopoly',
            'scratch': 'Scratch Adventure',
            'dice': 'Spice & Dice',
            'bomb': 'Lust Bomb',
            'risk': 'Risk It All',
            'distraction': 'Temptation Endurance',
            'sls': 'Squeeze Lick Suck',
            'pandora': "Pandora's Box",
            'roulette': 'Russian Roulette',
            'lip': 'Lip Lust',
            'blindfold': 'Sensory Blindfold',
            'contract': 'Signing Contract',
            'vault': 'The Vault'
        };

        // Agar ID list mein hai toh wo naam lo, nahi toh "Playing..." dikhao
        const screenName = gameNames[id] || "Playing a Game";
        
        sendStateUpdate('STATUS_UPDATE', { screenName: screenName });
    }
    
    window.scrollTo(0, 0);
};        
        window.startGameSuite = () => {
             // Check license before starting the suite
            if (!window.checkLicensingStatus()) {
                window.showFeedback("App Locked! Please enter your Passkey to proceed.", true);
                return;
            }

            window.state.names.Him = document.getElementById('input-him').value.trim() || "Him";
            window.state.names.Her = document.getElementById('input-her').value.trim() || "Her";
            document.getElementById('welcome-msg').textContent = `For ${window.state.names.Him} & ${window.state.names.Her}`;
            // Update names for the new games' scoreboards
            document.getElementById('memory-him-name').textContent = `${window.state.names.Him} Matches`;
            document.getElementById('memory-her-name').textContent = `${window.state.names.Her} Matches`;
            document.getElementById('nhie-him-label').textContent = `${window.state.names.Him} Fingers`;
            document.getElementById('nhie-her-label').textContent = `${window.state.names.Her} Fingers`;
            window.showScreen('home'); if(!isMusicPlaying) window.playTrack(0);
        };
        window.goToHome = () => window.showScreen('home');

        // --- MULTIPLAYER P2P LOGIC (Unchanged, uses PeerJS only) ---
        window.updateMultiplayerUI = () => { 
            const dot = document.getElementById('mp-connected-dot');
            const icon = document.getElementById('mp-status-icon');
            if (window.state.isMultiplayer) {
                dot.classList.remove('bg-red-500');
                dot.classList.add('bg-green-500');
                icon.classList.add('text-green-300');
            } else {
                dot.classList.remove('bg-green-500');
                dot.classList.add('bg-red-500');
                icon.classList.remove('text-green-300');
            }
        };
        
        function sendStateUpdate(type, payload = {}) {
            if (window.state.isMultiplayer && window.state.connection) {
                try {
                    window.state.connection.send({ type, payload });
                } catch (e) {
                    console.error("Failed to send data:", e);
                    window.showFeedback("Connection lost!", true);
                    window.state.isMultiplayer = false;
                    window.updateMultiplayerUI();
                }
            }
        }

        function handleReceivedData(data) {
    console.log("Received data:", data);
    
    // Safety: Data ko sahi se unpack karo
    const payload = data.payload || data; 
    const type = payload.type || data.type || data; // Kabhi kabhi type direct data mein hota hai

    switch (type) {

        // --- 1. CONN_TEST (Agar ye aaye toh bhi Chat dikhao) ---
        case 'CONN_TEST':
            window.showFeedback("Partner Connected! ‚ù§Ô∏è");
            document.getElementById('chat-toggle-btn').classList.remove('hidden');
            document.getElementById('partner-status').classList.remove('hidden');
            break; 

        // --- 2. INIT NAMES (Yahan Chat aur Loading Fix dono hai) ---
        case 'INIT_NAMES':
            // Sabse pehle CHAT aur STATUS dikhao (Ye line zaroori hai)
            document.getElementById('chat-toggle-btn').classList.remove('hidden');
            document.getElementById('partner-status').classList.remove('hidden');

            // Naam set karo
            const myRole = window.state.myRole;
            const partnerRole = myRole === 'Him' ? 'Her' : 'Him';
            
            // Check karo agar payload mein naam hai
            if(payload.partnerName) {
                window.state.names[partnerRole] = payload.partnerName;
            }
            
            // Input boxes update karo
            if(document.getElementById('input-him')) document.getElementById('input-him').value = window.state.names.Him;
            if(document.getElementById('input-her')) document.getElementById('input-her').value = window.state.names.Her;
            
            // --- LOADING FIX: Game start karo ---
            if(window.startGameSuite) window.startGameSuite(); 
            
            // Feedback
            window.showFeedback(`Connected with ${window.state.names[partnerRole]}!`);
            
            // Data Sync karo (Host vs Client)
            if (!window.state.isHost) {
                sendStateUpdate('SYNC_STATE_REQUEST');
            } else {
                sendStateUpdate('SYNC_FULL_STATE', { 
                    monopoly: window.state.monopoly, 
                    vault: savedVault || [], 
                    couponStatus: couponStatus || {},
                    todTurn: window.state.todTurn || 'Him',
                    nhie: window.state.nhie, 
                    memory: window.state.memory
                });
                // Ye loading screen hatata hai
                if(window.showMultiplayerStep) window.showMultiplayerStep(5);
            }
            break;

        // --- ISKE NEECHE BAAKI CASES (SYNC_STATE_REQUEST wagera) HONGE ---                case 'SYNC_STATE_REQUEST':
                    if (window.state.isHost) {
                        sendStateUpdate('SYNC_FULL_STATE', { 
                            monopoly: window.state.monopoly, 
                            vault: savedVault, 
                            couponStatus: couponStatus,
                            todTurn: window.state.todTurn,
                            nhie: window.state.nhie,
                            memory: window.state.memory
                        });
                    }
                    break;
                case 'SYNC_FULL_STATE':
                    window.state.monopoly = payload.monopoly;
                    savedVault = payload.vault;
                    couponStatus = payload.couponStatus;
                    window.state.todTurn = payload.todTurn || 'Him'; 
                    window.state.nhie = payload.nhie || { currentQ: 0, himScore: 5, herScore: 5, turn: 'Him', statements: [] };
                    window.state.memory = payload.memory || { cards: [], flipped: [], matched: [], turn: 'Him', score: { Him: 0, Her: 0 }, isLocked: false, tempMatch: 0 };
                    localStorage.setItem('contractVault', JSON.stringify(savedVault));
                    localStorage.setItem('couponStatus', JSON.stringify(couponStatus));
                    window.renderMonopolyBoard(); 
                    window.renderCoupons(); 
                    window.todResetUI();
                    window.updateMemoryUI();
                    window.renderMemoryBoard();
                    window.showMultiplayerStep(5);
                    break;
                case 'UPDATE_MONOPOLY':
                    window.state.monopoly = payload;
                    window.updateMonopolyTokens();
                    window.renderMonopolyBoard(); 
                    document.getElementById('mono-msg').textContent = `Partner rolled a ${payload.lastRoll}. ${window.state.names[window.state.monopoly.turn]}'s turn now.`;
                    
                    const movedPlayer = window.state.monopoly.turn === 'Him' ? 'Her' : 'Him';
                    const newPos = movedPlayer === 'Him' ? window.state.monopoly.p1 : window.state.monopoly.p2;
                    const tile = monoMap.find(t => t.id === newPos);
                    if(tile) {
                         const centerText = document.getElementById('mono-active-desc');
                         if(centerText) centerText.textContent = tile.detail;
                    }
                    break;
                case 'UPDATE_VAULT':
                    savedVault = payload.vault;
                    couponStatus = payload.couponStatus;
                    localStorage.setItem('contractVault', JSON.stringify(savedVault));
                    localStorage.setItem('couponStatus', JSON.stringify(couponStatus));
                    window.showFeedback("Vault/Coupon update received from partner!");
                    window.renderVault();
                    window.renderCoupons();
                    break;
                case 'MONOPOLY_WIN':
                    window.showFeedback(`üëë ${payload.winner} Won Monopoly! Redirecting to Vault...`);
                    setTimeout(() => { window.showVault(); }, 1500);
                    break;
                // --- NHIE SYNC LOGIC (MERGED) ---
                case 'NHIE_INIT':
                    if (!window.state.isHost) {
                        window.state.nhie.statements = payload.statements;
                        window.state.nhie.turn = payload.turn;
                        window.state.nhie.currentQ = 0; window.state.nhie.himScore = 5; window.state.nhie.herScore = 5;
                        window.updateNHIEUI();
                        window.showFeedback("Never Have I Ever game initialized by partner.");
                    }
                    break;
                case 'NHIE_QUESTION':
                    window.state.nhie.currentQ = payload.currentQ;
                    window.state.nhie.turn = payload.turn;
                    window.updateNHIEUI();
                    window.showFeedback(`Next statement is read by ${window.state.names[payload.turn]}.`);
                    break;
                case 'NHIE_FINGER_DOWN':
                    const player = payload.player;
                    const scoreKey = player === 'Him' ? 'himScore' : 'herScore';
                    if (window.state.nhie[scoreKey] > 0) {
                        window.state.nhie[scoreKey] -= 1;
                        window.updateNHIEUI();
                        window.showFeedback(`${window.state.names[player]} confessed! Remaining: ${window.state.nhie[scoreKey]}`);
                    }
                    break;
                case 'NHIE_END':
                    document.getElementById('nhie-game-area').classList.add('hidden');
                    document.getElementById('nhie-punishment-area').classList.remove('hidden');
                    document.getElementById('nhie-loser-name').textContent = `${window.state.names[payload.loser]} is the LOSER! (Zero Fingers)`;
                    document.getElementById('nhie-winner-name').textContent = `${window.state.names[payload.winner]} is the WINNER and chooses the punishment.`;
                    
                    const listEl = document.getElementById('nhie-punishment-list'); listEl.innerHTML = ''; 
                    nhiePunishments.forEach((p) => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-4 rounded-xl border border-red-500/30 bg-red-500/10 transition-all flex flex-col items-start group cursor-pointer opacity-50 cursor-not-allowed';
                        btn.innerHTML = `<div class="flex items-center gap-2 mb-1"><i data-lucide="${p.icon}" class="w-5 h-5 text-red-300"></i><span class="font-bold text-lg text-red-200">${p.title}</span></div><p class="text-xs opacity-70">${p.desc}</p>`;
                        listEl.appendChild(btn);
                    });
                    if(window.lucide) lucide.createIcons();
                    break;
                // --- END NHIE SYNC LOGIC ---

                // --- MEMORY SYNC LOGIC (MERGED) ---
                case 'MEMORY_INIT':
                    if (!window.state.isHost) {
                        window.state.memory.cards = payload.cards.map(c => ({...c, isFlipped: false}));
                        window.state.memory.turn = payload.turn;
                        window.state.memory.score = { Him: 0, Her: 0 };
                        window.state.memory.matched = payload.cards.filter(c => c.isMatched).map((c, i) => i);
                        window.state.memory.flipped = [];
                        window.state.memory.isLocked = false;
                        window.state.memory.tempMatch = 0;
                        window.renderMemoryBoard();
                        window.updateMemoryUI();
                        document.getElementById('memory-action-log').textContent = `Game started by partner! ${window.state.names[payload.turn]}'s turn.`;
                    }
                    break;
                case 'MEMORY_FLIP':
                    if (window.state.memory.flipped.length < 2) {
                        window.state.memory.cards[payload.index].isFlipped = true;
                        window.state.memory.flipped.push(payload.index);
                        window.renderMemoryBoard();
                        if (window.state.memory.flipped.length === 2) {
                             window.state.memory.isLocked = true;
                             document.getElementById('memory-action-log').textContent = `Partner flipped two cards. Checking match...`;
                        }
                    }
                    break;
                case 'MEMORY_MATCH':
                    window.state.memory.cards[payload.idx1].isFlipped = true;
                    window.state.memory.cards[payload.idx2].isFlipped = true;
                    window.state.memory.cards[payload.idx1].isMatched = true;
                    window.state.memory.cards[payload.idx2].isMatched = true;
                    window.state.memory.matched.push(payload.idx1, payload.idx2);
                    window.state.memory.score = payload.score;
                    window.state.memory.flipped = [];
                    window.state.memory.isLocked = false;
                    window.state.memory.tempMatch = payload.tempMatch;
                    window.renderMemoryBoard();
                    window.updateMemoryUI();
                    document.getElementById('memory-action-log').textContent = payload.message;
                    break;
                case 'MEMORY_NO_MATCH_TURN':
                    // Flip back non-matched cards
                    window.state.memory.cards.forEach(c => { if(!c.isMatched) c.isFlipped = false; });
                    window.state.memory.flipped = [];
                    window.state.memory.isLocked = false;
                    window.state.memory.turn = payload.turn;
                    window.state.memory.tempMatch = 0;
                    window.renderMemoryBoard();
                    window.updateMemoryUI();
                    document.getElementById('memory-action-log').textContent = `No Match! Turn change. It's now ${window.state.names[payload.turn]}'s turn.`;
                    break;
                case 'MEMORY_SHUFFLE':
                    // Update entire card array and state after shuffling
                    window.state.memory.cards = payload.cards;
                    window.state.memory.turn = payload.turn;
                    window.state.memory.flipped = [];
                    window.state.memory.isLocked = false;
                    window.state.memory.tempMatch = 0;
                    window.renderMemoryBoard();
                    window.updateMemoryUI();
                    document.getElementById('memory-action-log').textContent = `Chain break! Cards Shuffled! It's now ${window.state.names[payload.turn]}'s turn.`;
                    break;
                // --- END MEMORY SYNC LOGIC ---

                case 'TOD_ACTION':
                    // Just show the action, do NOT change the turn yet.
                    document.getElementById('tod-turn').textContent = `${window.state.names[window.state.todTurn]}'s Turn`; // Keep current turn visible
                    document.getElementById('tod-choice-btns').classList.add('hidden');
                    document.getElementById('tod-result').classList.remove('hidden');
                    document.getElementById('tod-result').classList.add('flex');
                    document.getElementById('tod-type-badge').textContent = payload.type;
                    document.getElementById('tod-text').textContent = payload.text;
                    
                    // Disable the Next Turn button for the user who *received* the action, 
                    // only the original player (whose turn it still is) can proceed.
                    document.querySelector('#tod-result button').disabled = (window.state.todTurn !== window.state.myRole);
                    break;
                case 'TOD_NEXT':
                    // Now update the turn on both sides and reset UI
                    window.state.todTurn = payload.turn;
                    window.todResetUI();
                    window.showFeedback(`It is now ${window.state.names[window.state.todTurn]}'s turn!`);
                    break;
                case 'CARD_ROLL_START':
                    document.getElementById('mystery-dice-box').classList.add('mystery-dice-rolling');
                    document.getElementById('active-card').classList.remove('visible', 'flipped');
                    document.getElementById('card-placeholder').style.display = 'block';
                    document.getElementById('card-placeholder').textContent = "Partner Rolling...";
                    break;
                case 'CARD_REVEAL':
                    document.getElementById('mystery-dice-box').classList.remove('mystery-dice-rolling');
                    document.getElementById('dice-val').textContent = payload.roll;
                    window.revealCard(payload.index);
                    break;
                case 'RPS_MOVE':
                    if (payload.couponId === window.state.rps.currentCoupon?.id) {
                         // RPS is Him (P1) vs Her (P2)
                         if (payload.role === 'Him') {
                             window.state.rps.p1Move = payload.move;
                             window.showFeedback(`${window.state.names.Him} moved! Now your turn.`);
                             document.getElementById('p1-name-display').textContent = `${window.state.names.Her}'s Turn (Your Move!)`;
                             document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = (window.state.myRole !== 'Her'));
                         } else if (payload.role === 'Her' && window.state.rps.p1Move) {
                             window.state.rps.p2Move = payload.move;
                             window.showFeedback(`${window.state.names.Her} moved! Showing result...`);
                             window.startRPSShowdown(window.state.rps.p1Move, window.state.rps.p2Move);
                         }
                    }
                    break;
                case 'RPS_WIN_SYNC':
                     // This syncs the result/contract after the winner's device processes it.
                    savedVault = payload.vault;
                    couponStatus = payload.couponStatus;
                    localStorage.setItem('contractVault', JSON.stringify(savedVault));
                    localStorage.setItem('couponStatus', JSON.stringify(couponStatus));
                    // Re-render coupons to show locked state for the day
                    window.renderCoupons();
                    break;
                    
                                        // --- RUSSIAN ROULETTE SYNC (FIXED VARIABLE SCOPE) ---
        case 'ROULETTE_INIT':
            // Galti yahan thi: 'window.' hata diya hai taaki asli variable update ho
            rouletteTurn = payload.starter;
            currentChamber = 1;
            bulletChamber = payload.bullet; 
            
            // UI Show
            document.getElementById('roulette-intro').classList.add('hidden');
            document.getElementById('roulette-game').classList.remove('hidden');
            document.getElementById('roulette-game').classList.add('flex');
            
            // Visual Reset
            const cylInit = document.getElementById('cylinder-visual');
            cylInit.style.transition = "none";
            cylInit.style.transform = "rotate(0deg)";
            
            window.updateRouletteUI("Game Started. Bullet Locked.");
            break;

        case 'ROULETTE_TRIGGER':
            // Sync Chamber Count
            currentChamber = payload.chamber; // 'window.' hataya
            
            // Animation
            const rot = currentChamber * 60; 
            document.getElementById('cylinder-visual').style.transform = `rotate(${rot}deg)`;

            // Result Show
            if (payload.result === 'BANG') {
                window.handleRouletteDeath(payload.task);
            } else {
                window.handleRouletteSafe(payload.task);
            }
            break;

        case 'ROULETTE_NEXT':
            // Sync Turn Change
            currentChamber = payload.nextChamber; // 'window.' hataya
            rouletteTurn = payload.turn;          // 'window.' hataya (Ye sabse zaroori tha!)
            
            // Hide Overlay
            document.getElementById('roulette-safe-overlay').classList.add('hidden');
            document.getElementById('roulette-safe-overlay').classList.remove('flex');
            
            // Enable Button
            const btn = document.getElementById('btn-trigger');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            window.updateRouletteUI("Partner passed the gun.");
            break;

        // --- LUST BOMB SYNC START ---
        case 'BOMB_ACTION':
            // Action check karo: Start, Pass, ya Explode
            if (payload.action === 'START') {
                // Timer sync karke start karo
                window.startBombGame(true, payload.value);
            } 
            else if (payload.action === 'PASS') {
                // Task sync karke update karo
                window.passTheBomb(true, payload.value);
            } 
            else if (payload.action === 'EXPLODE') {
                // Same punishment dikhao aur timer roko
                window.explodeBomb(true, payload.value);
            }
            break;
        // --- LUST BOMB SYNC END ---
        
                // --- SPICE & DICE SYNC START ---
        case 'SPICE_SPIN':
            // Partner ne wheel ghumaya, hum bhi wahi same result dikhayenge
            window.performSpiceSpin(payload.actionIndex, payload.bodyIndex);
            break;
        // --- SPICE & DICE SYNC END ---
        
                // --- PANDORA SYNC START ---
        case 'PANDORA_OPEN':
            const pCard = document.getElementById(`pandora-box-${payload.index}`);
            const pBack = document.getElementById(`pandora-back-${payload.index}`);
            
            // Partner ne box khola, hum bhi wahi kholenge with SAME text
            window.openPandoraBox(payload.index, pCard, pBack, payload.item, true, payload.text);
            break;
        // --- PANDORA SYNC END ---
        
                // --- CHAT & STATUS SYNC START ---
        
        // CASE 1: PARTNER STATUS CHANGED
        case 'STATUS_UPDATE':
            const statusBox = document.getElementById('partner-status');
            const statusText = document.getElementById('partner-status-text');
            
            // Show status box
            statusBox.classList.remove('hidden');
            statusText.textContent = `Partner is on: ${payload.screenName}`;
            
            // 5 second baad hide kar sakte ho agar chaho, ya permanent rakho
            // setTimeout(() => statusBox.classList.add('hidden'), 5000);
            break;

        // CASE 2: CHAT MESSAGE RECEIVED
        case 'CHAT_MSG':
            // Message dikhao
            appendMessage(payload.text, 'partner');
            
            // Agar Chat band hai, toh Badge (Red Dot) dikhao aur vibrate karo
            const chatBox = document.getElementById('game-chat-box');
            if (chatBox.classList.contains('hidden')) {
                document.getElementById('chat-badge').classList.remove('hidden');
                if(navigator.vibrate) navigator.vibrate([50, 50]);
            }
            break;

        // --- CHAT & STATUS SYNC END ---
        

    // Iske baad default: aayega, usko mat chhedna
    default:
        console.log("Unknown data type:", data.type);
        
            }
        }
        
        // Multiplayer setup steps (Unchanged)
        window.openMultiplayerModal = () => {
             if (!window.checkLicensingStatus()) {
                window.showFeedback("App Locked! Please enter your Passkey to use multiplayer.", true);
                return;
            }
            if (window.state.isMultiplayer) {
                window.showMultiplayerStep(5); 
                document.getElementById('mp-host-info').textContent = window.state.isHost ? `${window.state.names.Him} (You)` : `${window.state.names.Him} (Partner)`;
                document.getElementById('mp-guest-info').textContent = window.state.isHost ? `${window.state.names.Her} (Partner)` : `${window.state.names.Her} (You)`;
                document.getElementById('multiplayer-modal').classList.add('active');
            } else {
                document.getElementById('mp-player-name').value = document.getElementById('input-him').value;
                document.getElementById('mp-player-gender').value = 'Him';
                window.showMultiplayerStep(1);
            }
        };

        window.closeMultiplayerModal = (start = false) => {
            document.getElementById('multiplayer-modal').classList.remove('active');
            if (start) {
                window.showScreen('home');
            }
        };
        
        window.showMultiplayerStep = (step) => {
            ['1', '2', '3', '4', '5'].forEach(s => document.getElementById(`mp-step-${s}`).classList.add('hidden'));
            document.getElementById(`mp-step-${step}`).classList.remove('hidden');
            document.getElementById('multiplayer-modal').classList.add('active');

            if (step === 2) {
                const name = document.getElementById('mp-player-name').value.trim() || "Player";
                document.getElementById('mp-welcome-msg').textContent = `Welcome, ${name}! Now, choose your role: Dominant or Submissive.`;
            }
            if(window.lucide) lucide.createIcons();
        };

        window.hostGame = () => {
            window.state.isHost = true;
            window.state.myRole = document.getElementById('mp-player-gender').value;
            const myName = document.getElementById('mp-player-name').value.trim() || "Player";
            
            window.state.names[window.state.myRole] = myName;
            
            document.getElementById('input-him').value = window.state.names.Him;
            document.getElementById('input-her').value = window.state.names.Her;
            
            window.showMultiplayerStep(4);
            document.getElementById('mp-status-heading').textContent = "Hosting Game...";
            document.getElementById('mp-status-desc').textContent = "Generating room code (ID)...";
            document.getElementById('mp-host-code-display').classList.remove('hidden');

            window.initPeer(true);
        };

        window.joinGame = () => {
            window.state.isHost = false;
            window.state.myRole = document.getElementById('mp-player-gender').value;
            const myName = document.getElementById('mp-player-name').value.trim() || "Player";
            const peerId = document.getElementById('mp-join-code').value.trim();

            if (!peerId) {
                window.showFeedback("Enter the Host's Secret Key.", true);
                return;
            }
            
            window.state.names[window.state.myRole] = myName; 
            
            document.getElementById('input-him').value = window.state.names.Him;
            document.getElementById('input-her').value = window.state.names.Her;
            
            window.showMultiplayerStep(4);
            document.getElementById('mp-status-heading').textContent = "Joining Room...";
            document.getElementById('mp-status-desc').textContent = `Connecting to: ${peerId}`;
            document.getElementById('mp-host-code-display').classList.add('hidden');
            
            window.initPeer(false, peerId);
        };
        
        window.initPeer = (isHost, connectToId = null) => {
            const peerConfig = { debug: 0 }; 
            
            if (window.state.myPeer) { window.state.myPeer.destroy(); }

            try {
                window.state.myPeer = new Peer(undefined, peerConfig);
            } catch (e) {
                console.error("PeerJS initialization error:", e);
                window.showFeedback("Connection failed. The stars are misaligned. Try again.", true);
                window.closeMultiplayerModal();
                return;
            }

            window.state.myPeer.on('open', (id) => {
                window.state.peerId = id;
                document.getElementById('mp-peer-id').textContent = id;
                document.getElementById('mp-status-desc').textContent = isHost 
                    ? "Room Code generated. Waiting for partner to join..." 
                    : `Connecting to Host: ${connectToId}`;

                if (isHost) {
                    window.state.myPeer.on('connection', (conn) => {
                        window.state.connection = conn;
                        setupConnection(conn);
                    });
                } else if (connectToId) {
                    const conn = window.state.myPeer.connect(connectToId);
                    window.state.connection = conn;
                    setupConnection(conn);
                }
            });

            window.state.myPeer.on('error', (err) => {
                console.error("PeerJS Error:", err);
                window.showFeedback(`Connection Error: ${err.message || err.type}`, true);
                window.state.isMultiplayer = false;
                window.updateMultiplayerUI();
                if (window.state.myPeer && !window.state.myPeer.destroyed) {
                    window.state.myPeer.destroy();
                }
            });
            
            window.state.myPeer.on('disconnected', () => {
                console.log("PeerJS Disconnected");
                window.state.isMultiplayer = false;
                window.updateMultiplayerUI();
                window.showFeedback("Connection lost (Disconnected).", true);
            });
        };

        function setupConnection(conn) {
            conn.on('open', () => {
                window.state.isMultiplayer = true;
                window.updateMultiplayerUI();
                console.log("P2P Connection Established!");
                
                sendStateUpdate('INIT_NAMES', {
                    partnerName: window.state.names[window.state.myRole],
                });

                conn.on('data', handleReceivedData);
                
                conn.on('close', () => {
                    window.state.isMultiplayer = false;
                    window.updateMultiplayerUI();
                    window.showFeedback("Partner disconnected.", true);
                });
                conn.on('error', (err) => {
                    console.error("Connection error:", err);
                    window.state.isMultiplayer = false;
                    window.updateMultiplayerUI();
                    window.showFeedback("Connection error with partner.", true);
                });
            });
        }
        // --- END MULTIPLAYER P2P LOGIC ---

        // --- SECURITY LOGIC (Unchanged) ---
        window.savePasswords = () => localStorage.setItem('vaultPasswords', JSON.stringify(window.state.passwords));
        
        window.openSecuritySettings = () => {
            window.state.tempAuth = { action: 'manage', role: null };
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('pwd-modal-title').textContent = "Vault Security";
            document.getElementById('pwd-modal-desc').textContent = "Who are you managing?";
            document.getElementById('pwd-input').classList.add('hidden');
            document.getElementById('pwd-change-fields').classList.add('hidden');
            document.getElementById('pwd-forgot-link').classList.add('hidden');
            
            const btnArea = document.getElementById('pwd-action-btn').parentElement;
            const originalHTML = btnArea.innerHTML;
            btnArea.innerHTML = `
                <button onclick="window.selectSecurityUser('Him')" class="flex-1 btn-gradient py-3 rounded-xl font-bold text-sm bg-blue-600">HIM ‚ôÇÔ∏è</button>
                <button onclick="window.selectSecurityUser('Her')" class="flex-1 btn-gradient py-3 rounded-xl font-bold text-sm bg-pink-600">HER ‚ôÄÔ∏è</button>
            `;
            
            window.restoreModal = () => { btnArea.innerHTML = originalHTML; };
        };

        window.selectSecurityUser = (role) => {
            window.state.tempAuth.role = role;
            const hasPass = !!window.state.passwords[role];
            
            window.restoreModal();
            document.getElementById('pwd-input').classList.remove('hidden');
            
            if (!hasPass) {
                document.getElementById('pwd-modal-title').textContent = `Set Password for ${role}`;
                document.getElementById('pwd-modal-desc').textContent = "Create a new vault password.";
                document.getElementById('pwd-input').placeholder = "New Password";
                document.getElementById('pwd-input').value = "";
                document.getElementById('pwd-action-btn').textContent = "SET PASSWORD";
                document.getElementById('pwd-action-btn').onclick = window.handleSetPassword;
                document.getElementById('pwd-forgot-link').classList.add('hidden'); 
            } else {
                document.getElementById('pwd-modal-title').textContent = `Change ${role}'s Password`;
                document.getElementById('pwd-modal-desc').textContent = "Enter current password to change it.";
                document.getElementById('pwd-input').placeholder = "Current Password";
                document.getElementById('pwd-input').value = "";
                document.getElementById('pwd-change-fields').classList.remove('hidden');
                document.getElementById('pwd-new').value = "";
                document.getElementById('pwd-action-btn').textContent = "CHANGE PASSWORD";
                document.getElementById('pwd-action-btn').onclick = window.handleChangePassword;
                document.getElementById('pwd-forgot-link').classList.remove('hidden');
            }
        };

        window.initiateDelete = (contractId, winnerName) => {
            let role = 'Him';
            if (winnerName === window.state.names.Her) role = 'Her';
            else if (winnerName !== window.state.names.Him) role = 'Him';
            
            window.state.tempAuth = { action: 'delete', targetId: contractId, role: role };
            
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('pwd-input').classList.remove('hidden');
            document.getElementById('pwd-change-fields').classList.add('hidden');
            document.getElementById('pwd-input').value = "";
            document.getElementById('pwd-forgot-link').classList.remove('hidden');

            if (!window.state.passwords[role]) {
                document.getElementById('pwd-modal-title').textContent = "Setup Security";
                document.getElementById('pwd-modal-desc').textContent = `Set a password for ${role} to secure contracts.`;
                document.getElementById('pwd-input').placeholder = "Create Password";
                document.getElementById('pwd-action-btn').textContent = "SET & DELETE";
                document.getElementById('pwd-action-btn').onclick = window.handleSetPassword;
                document.getElementById('pwd-forgot-link').classList.add('hidden');
            } else {
                document.getElementById('pwd-modal-title').textContent = "Delete Contract";
                document.getElementById('pwd-modal-desc').textContent = `Enter ${role}'s password to confirm deletion.`;
                document.getElementById('pwd-input').placeholder = "Enter Password";
                document.getElementById('pwd-action-btn').textContent = "CONFIRM DELETE";
                document.getElementById('pwd-action-btn').onclick = window.handleVerifyDelete;
            }
        };

        window.handleSetPassword = () => {
            const input = document.getElementById('pwd-input').value;
            if(!input) return window.showFeedback("Password cannot be empty", true);
            
            const role = window.state.tempAuth.role;
            window.state.passwords[role] = input;
            window.savePasswords();
            
            if (window.state.tempAuth.action === 'delete') {
                window.performDelete();
            } else {
                window.showFeedback("Password Set Successfully!");
                window.closePasswordModal();
            }
        };

        window.handleVerifyDelete = () => {
            const input = document.getElementById('pwd-input').value;
            const role = window.state.tempAuth.role;
            
            if (input === window.state.passwords[role]) {
                window.performDelete();
            } else {
                window.showFeedback("Incorrect Password!", true);
            }
        };

        window.handleChangePassword = () => {
            const current = document.getElementById('pwd-input').value;
            const newPass = document.getElementById('pwd-new').value;
            const role = window.state.tempAuth.role;
            
            if (current !== window.state.passwords[role]) {
                window.showFeedback("Incorrect Old Password!", true);
                return;
            }
            if (!newPass) {
                window.showFeedback("New password cannot be empty", true);
                return;
            }
            
            window.state.passwords[role] = newPass;
            window.savePasswords();
            window.showFeedback("Password Changed Successfully!");
            window.closePasswordModal();
        };

        window.handleForgotPass = () => {
            const role = window.state.tempAuth.role;
            
            document.getElementById('pwd-input').classList.add('hidden');
            document.getElementById('pwd-change-fields').classList.add('hidden');
            document.getElementById('pwd-forgot-link').classList.add('hidden');

            const actionBtn = document.getElementById('pwd-action-btn');
            const originalActionBtnText = actionBtn.textContent;
            const originalActionBtnHandler = actionBtn.onclick;

            document.getElementById('pwd-modal-title').textContent = "‚ö†Ô∏è CONFIRM PASSWORD WIPE ‚ö†Ô∏è";
            document.getElementById('pwd-modal-desc').innerHTML = `Resetting the password for <b>${role}</b> will PERMANENTLY DELETE ALL contracts won by ${window.state.names[role]}. Are you sure?`;

            actionBtn.textContent = "WIPE & RESET VAULT";
            actionBtn.onclick = window.handleForgotPassConfirm;
            actionBtn.classList.remove('btn-gradient');
            actionBtn.classList.add('bg-red-700', 'hover:bg-red-800', 'shadow-red-900/50');

            const originalCancel = document.querySelector('#password-modal button:last-child').onclick;
            window.restoreModal = () => {
                document.querySelector('#password-modal button:last-child').onclick = originalCancel;
                document.getElementById('pwd-input').classList.remove('hidden');
                actionBtn.textContent = originalActionBtnText;
                actionBtn.onclick = originalActionBtnHandler;
                actionBtn.classList.remove('bg-red-700', 'hover:bg-red-800', 'shadow-red-900/50');
                actionBtn.classList.add('btn-gradient');
                document.getElementById('pwd-forgot-link').classList.remove('hidden');
            };
        };

        window.handleForgotPassConfirm = () => {
            const role = window.state.tempAuth.role;
            
            savedVault = savedVault.filter(c => {
                const roleName = window.state.names[role];
                return c.winner !== roleName;
            });
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            window.state.passwords[role] = null;
            window.savePasswords();
            
            document.getElementById('pwd-modal-title').textContent = "‚úÖ SUCCESS";
            document.getElementById('pwd-modal-desc').textContent = `Vault wiped for ${role}. Password has been reset.`;
            
            const actionBtn = document.getElementById('pwd-action-btn');
            actionBtn.textContent = "CONTINUE";
            actionBtn.onclick = window.closePasswordModal; 
            actionBtn.classList.remove('bg-red-700', 'hover:bg-red-800', 'shadow-red-900/50');
            actionBtn.classList.add('btn-gradient');
            
            window.restoreModal = () => { /* Prevent old restore logic */ };
            window.renderVault();
        };
        
        window.performDelete = () => {
            const id = window.state.tempAuth.targetId;
            savedVault = savedVault.filter(c => c.id !== id);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            window.renderVault();
            window.closePasswordModal();
            window.showFeedback("Contract Deleted!");
            
            sendStateUpdate('UPDATE_VAULT', { vault: savedVault, couponStatus: couponStatus });
        };

        window.closePasswordModal = () => {
            document.getElementById('password-modal').classList.remove('active');
            if(window.restoreModal) window.restoreModal();
        };
        // --- END SECURITY LOGIC ---


        // --- MONOPOLY LOGIC (Unchanged, relies on multiplayer logic) ---
        const monoMap = [
            { id: 0, text: "START", icon: "flag", row: 1, col: 1, detail: "The game begins. Roll to determine your fate." },
            { id: 1, text: "Kiss Neck", icon: "heart", row: 1, col: 2, detail: "You have to gently kiss your partner's neck for 1 minute. No hands allowed." },
            { id: 2, text: "Truth", icon: "help-circle", row: 1, col: 3, detail: "Answer a deeply intimate question honestly. No skipping." },
            { id: 3, text: "Strip 1", icon: "shirt", row: 1, col: 4, detail: "You must have to remove one piece of clothing. Slowly." },
            { id: 4, text: "Massage", icon: "hand", row: 1, col: 5, detail: "You have to give a 2-minute deep shoulder massage to your partner." },
            { id: 5, text: "Dare", icon: "flame", row: 2, col: 5, detail: "Perform a spicy dare chosen by the opponent." },
            { id: 6, text: "Spank", icon: "hand-metal", row: 3, col: 5, detail: "Let your partner deliver 3 firm spanks." },
            { id: 7, text: "Lick Ear", icon: "music", row: 4, col: 5, detail: "You have to trace your partner's ear with their tongue for 30 seconds." },
            { id: 8, text: "Blindfold", icon: "eye-off", row: 5, col: 5, detail: "you have to wear a blindfold for the next 3 turns." },
            { id: 9, text: "Safe Spot", icon: "shield", row: 5, col: 4, detail: "You are safe... for now. Take a breath." },
            { id: 10, text: "Lap Dance", icon: "music", row: 5, col: 3, detail: "Now performs a seductive lap dance for 1 minute." },
            { id: 11, text: "Go Back 2", icon: "rewind", row: 5, col: 2, detail: "Bad luck! Move back 2 spaces." },
            { id: 12, text: "Whisper", icon: "mic", row: 5, col: 1, detail: "Whisper your deepest fantasy into your partner's ear." },
            { id: 13, text: "Roll Again", icon: "refresh-cw", row: 4, col: 1, detail: "Destiny smiles on you. Roll the dice again." },
            { id: 14, text: "French Kiss", icon: "heart", row: 3, col: 1, detail: "A deep, passionate French kiss for 60 seconds." },
            { id: 15, text: "Bite Lip", icon: "smile", row: 2, col: 1, detail: "Let your partner Gently bite your lower lip. Hold for 5 seconds." }
        ];

        window.initMonopoly = () => {
             if (!window.checkLicensingStatus()) {
                window.showFeedback("App Locked! Please enter your Passkey to play games.", true);
                return;
            }
            if (!window.state.isMultiplayer) {
                 window.state.monopoly = { p1: 0, p2: 0, turn: 'Him', isRolling: false, lastRoll: 0 };
            } 
            window.showScreen('monopoly');
            window.renderMonopolyBoard();
        };

        window.renderMonopolyBoard = () => {
            const board = document.getElementById('monopoly-board');
            const center = board.querySelector('.board-center');
            board.innerHTML = '';
            board.appendChild(center);

            monoMap.forEach(tile => {
                const el = document.createElement('div');
                el.className = `board-tile ${tile.id===0?'tile-corner':''}`;
                el.style.gridRow = tile.row;
                el.style.gridColumn = tile.col;
                el.id = `mono-tile-${tile.id}`;
                el.innerHTML = `<i data-lucide="${tile.icon}" class="w-3 h-3 mb-1 opacity-70"></i><span>${tile.text}</span>`;
                board.appendChild(el);
            });
            if(window.lucide) lucide.createIcons();
            window.updateMonopolyTokens();
        };

        window.updateMonopolyTokens = () => {
            document.querySelectorAll('.token').forEach(t => t.remove());
            
            const p1Tile = document.getElementById(`mono-tile-${window.state.monopoly.p1}`);
            const p2Tile = document.getElementById(`mono-tile-${window.state.monopoly.p2}`);
            
            if(p1Tile) { const t = document.createElement('div'); t.className = 'token token-him'; p1Tile.appendChild(t); }
            if(p2Tile) { const t = document.createElement('div'); t.className = 'token token-her'; p2Tile.appendChild(t); }
            
            document.getElementById('mono-turn-text').textContent = `Turn: ${window.state.names[window.state.monopoly.turn]}`;
            
            const rollBtn = document.getElementById('btn-roll-mono');
            if (window.state.isMultiplayer) {
                if (window.state.monopoly.turn === window.state.myRole) {
                    rollBtn.disabled = false;
                    rollBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    rollBtn.disabled = true;
                    rollBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                 rollBtn.disabled = false;
                 rollBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        window.rollMonopolyDice = () => {
            if (window.state.isMultiplayer && window.state.monopoly.turn !== window.state.myRole) {
                window.showFeedback(`Wait, it's ${window.state.names[window.state.monopoly.turn]}'s turn!`, true);
                return;
            }
            
            if(window.state.monopoly.isRolling) return;
            window.state.monopoly.isRolling = true;
            
            const cube = document.getElementById('dice-cube');
            const msg = document.getElementById('mono-msg');
            const roll = Math.floor(Math.random() * 6) + 1;
            
            cube.className = `cube show-${roll}`;
            msg.textContent = "Rolling...";
            
            setTimeout(() => {
                window.moveMonopolyToken(roll);
            }, 1200);
        };

        window.moveMonopolyToken = (roll) => {
            const isHim = window.state.monopoly.turn === 'Him';
            let current = isHim ? window.state.monopoly.p1 : window.state.monopoly.p2;
            let next = current + roll;
            const msg = document.getElementById('mono-msg');
            
            window.state.monopoly.lastRoll = roll; 

            if (next >= 16) {
                next = next % 16;
                window.finishMonopolyGame(window.state.names[window.state.monopoly.turn]);
                if(isHim) window.state.monopoly.p1 = next; else window.state.monopoly.p2 = next;
                window.updateMonopolyTokens();
                sendStateUpdate('UPDATE_MONOPOLY', window.state.monopoly);
                return;
            }

            const tile = monoMap.find(t => t.id === next);
            
            const centerText = document.getElementById('mono-active-desc');
            if(centerText) centerText.textContent = tile.detail;

            if(tile.text.includes("Go Back")) {
                const back = 2;
                msg.textContent = `Oops! Back ${back} spaces!`;
                next = (next - back + 16) % 16; 
            } else {
                msg.textContent = `${window.state.names[window.state.monopoly.turn]} landed on: ${tile.text}`;
            }

            if(isHim) window.state.monopoly.p1 = next; else window.state.monopoly.p2 = next;
            window.updateMonopolyTokens();

            if(tile.text !== "Roll Again") {
                window.state.monopoly.turn = isHim ? 'Her' : 'Him';
            }
            window.state.monopoly.isRolling = false;
            setTimeout(window.updateMonopolyTokens, 500);
            
            sendStateUpdate('UPDATE_MONOPOLY', window.state.monopoly);
        };

        window.finishMonopolyGame = (winner) => {
            const loser = winner === window.state.names.Him ? window.state.names.Her : window.state.names.Him;
            const msg = document.getElementById('mono-msg');
            msg.textContent = "CHAMPION FOUND!";
            
            const deal = {
                id: Date.now(),
                title: "The Protocol of Total Surrender",
                desc: `The Loser (${loser}) is stripped and blindfolded. The Winner (${winner}) has 20 minutes of absolute control using ice, breath, and warmth. The Loser cannot speak or move. The goal is to bring them to the edge but deny release until the Winner permits.`,
                winner: winner,
                loser: loser,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: "Auto-Sealed"
            };
            
            savedVault.unshift(deal);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            window.showFeedback(`üëë ${winner} Conquered the Board! Contract Sealed in Vault.`);
            
            sendStateUpdate('UPDATE_VAULT', { vault: savedVault, couponStatus: couponStatus });
            sendStateUpdate('MONOPOLY_WIN', { winner: winner });
            
            setTimeout(() => { window.showVault(); }, 800);
        };
        
        window.resetMonopoly = () => { 
            window.initMonopoly(); 
            sendStateUpdate('UPDATE_MONOPOLY', window.state.monopoly);
        };
        // --- END MONOPOLY LOGIC ---


        // --- COUPONS (Unchanged, relies on multiplayer logic) ---
        const detailedCoupons = [
            { id: 1, type: "Her", title: "Queen's Command", desc: "Winner (Her) gives 3 orders. Loser (Him) MUST obey immediately. No questions.", icon: "crown" },
            { id: 2, type: "Him", title: "King's Pleasure", desc: "Winner (Him) gets 20 mins of oral focus. No rushing allowed.", icon: "crown" },
            { id: 3, type: "Both", title: "Naked Dinner", desc: "Next meal at home must be eaten completely naked. Winner chooses food.", icon: "utensils" },
            { id: 4, type: "Her", title: "Full Body Massage", desc: "Loser (Him) gives Winner (Her) a 30-min oil massage. Front and back.", icon: "hand" },
            { id: 5, type: "Him", title: "Visual Treat", desc: "Loser (She) performs a striptease or wears his favorite lingerie. His choice.", icon: "eye" },
            { id: 6, type: "Both", title: "Shower Together", desc: "Save water. Soap each other up. Winner controls the temperature.", icon: "droplet" },
            { id: 7, type: "Her", title: "Yes Day", desc: "Loser (Him) cannot say 'No' to any reasonable request for 2 hours.", icon: "check-circle" },
            { id: 8, type: "Him", title: "Silence Game", desc: "Loser (She) must remain silent for 15 mins while he teases her body.", icon: "mic-off" },
            { id: 9, type: "Both", title: "No Panties/Boxers", desc: "Go out for dinner/drink wearing no underwear. Winner picks the spot.", icon: "ghost" },
            { id: 10, type: "Her", title: "Foot Worship", desc: "Loser (Him) must massage and kiss her feet for 10 minutes.", icon: "heart" },
            { id: 11, type: "Him", title: "Gaming/Chill Pass", desc: "1 hour of undisturbed chill time for Him. She brings snacks.", icon: "gamepad-2" },
            { id: 12, type: "Both", title: "Tech Free Night", desc: "Phones off. Lights dim. Just talking and touching for 2 hours.", icon: "smartphone-off" },
            { id: 13, type: "Her", title: "Shopping Treat", desc: "Loser (Him) buys her one small gift (under $20/‚Çπ500).", icon: "shopping-bag" },
            { id: 14, type: "Him", title: "Head Massage", desc: "Loser (She) gives him a relaxing head/scalp massage until he sleeps.", icon: "smile" },
            { id: 15, type: "Both", title: "Fantasy Reveal", desc: "Winner shares a fantasy. Loser must help act it out (if comfortable).", icon: "sparkles" },
            { id: 16, type: "Her", title: "Chore Free Day", desc: "Loser (Him) does ALL household chores for the day. She relaxes.", icon: "coffee" },
            { id: 17, type: "Him", title: "Remote Control", desc: "Winner (Him) controls the TV/Music for the entire night.", icon: "tv" },
            { id: 18, type: "Both", title: "Blindfold Challenge", desc: "Loser wears a blindfold for 10 mins. Winner teases with ice/feather.", icon: "eye-off" },
            { id: 19, type: "Both", title: "Date Planner", desc: "Winner plans a date. Loser pays.", icon: "calendar-heart" },
            { id: 20, type: "Him", title: "Breakfast in Bed", desc: "Loser (She) serves him breakfast in bed tomorrow morning.", icon: "coffee" },
            { id: 21, type: "Both", title: "Roleplay Switch", desc: "Winner picks new names for the night. You must stay in character.", icon: "user-cog" },
            { id: 22, type: "Her", title: "Cuddle Command", desc: "Loser (He) must cuddle her in the position she chooses for 30 mins.", icon: "heart" },
            { id: 23, type: "Him", title: "Beer/Drink Pass", desc: "Loser (She) fetches him a cold drink whenever he asks for the next hour.", icon: "beer" },
            { id: 24, type: "Both", title: "Truth Serum", desc: "Winner asks one deep/dirty question. Loser MUST answer truthfully.", icon: "help-circle" },
            { id: 25, type: "Her", title: "Neck Kisses", desc: "Loser (He) must kiss her neck from behind for 5 mins without moving lower.", icon: "flame" },
            { id: 26, type: "Him", title: "Lap Dance", desc: "Loser (She) gives a private lap dance to his favorite song.", icon: "music" },
            { id: 27, type: "Both", title: "Quickie", desc: "Stop everything. Do it now. Winner picks the spot.", icon: "zap" },
            { id: 28, type: "Her", title: "Compliment Shower", desc: "Loser (He) must give her 5 genuine compliments about her body/mind.", icon: "star" },
            { id: 29, type: "Him", title: "No Nagging", desc: "Loser (She) cannot complain about anything for 24 hours.", icon: "shield-check" },
            { id: 30, type: "Both", title: "Mirror Play", desc: "Watch yourselves in the mirror while making out.", icon: "monitor" },
            { id: 31, type: "Both", title: "Lotion Application", desc: "Loser applies lotion to Winner's entire body. Slowly.", icon: "droplet" },
            { id: 32, type: "Him", title: "Guy's Night Out", desc: "He gets a pass to hang with friends, no guilt trip.", icon: "users" },
            { id: 33, type: "Both", title: "Midnight Walk", desc: "Go for a walk late at night holding hands.", icon: "moon" },
            { id: 34, type: "Her", title: "Hair Play", desc: "Loser (He) brushes or plays with her hair until she feels sleepy.", icon: "wind" },
            { id: 35, type: "Him", title: "Sandwich Maker", desc: "Loser (She) makes him his favorite snack/sandwich right now.", icon: "sandwich" },
            { id: 36, type: "Both", title: "Edging Game", desc: "Winner controls when the loser is allowed to finish.", icon: "stop-circle" },
            { id: 37, type: "Her", title: "Bubble Bath", desc: "Loser (He) prepares a hot bath for her with candles.", icon: "bath" },
            { id: 38, type: "Him", title: "Back Scratch", desc: "Loser (She) scratches his back for 15 mins.", icon: "move" },
            { id: 39, type: "Both", title: "Photo Session", desc: "Take a spicy photo together. Winner keeps it.", icon: "camera" },
            { id: 40, type: "Her", title: "Argument End", desc: "Use this to instantly win any petty argument.", icon: "flag" },
            { id: 41, type: "Both", title: "Kiss Attack", desc: "Winner kisses loser everywhere for 2 mins.", icon: "heart" },
            { id: 42, type: "Her", title: "Princess Treatment", desc: "He treats her like royalty for 2 hours. No lifting a finger.", icon: "crown" },
            { id: 43, type: "Him", title: "King for a Day", desc: "She treats him like a king for 2 hours.", icon: "crown" },
            { id: 44, type: "Both", title: "69", desc: "Mutual oral pleasure. No rush.", icon: "repeat" },
            { id: 45, type: "Both", title: "Oral for Her", desc: "She receives. He gives. 15 mins min.", icon: "mic" },
            { id: 46, type: "Both", title: "Oral for Him", desc: "He receives. She gives. 15 mins min.", icon: "mic" },
            { id: 47, type: "Both", title: "Spanking", desc: "Winner spanks loser. Playful or hard.", icon: "hand" },
            { id: 48, type: "Both", title: "Toy Time", desc: "Introduce a toy into the bedroom.", icon: "battery-charging" },
            { id: 49, type: "Her", title: "Chocolate Body (Her)", desc: "He eats chocolate off her body.", icon: "utensils" },
            { id: 50, type: "Him", title: "Chocolate Body (Him)", desc: "She eats chocolate off his body.", icon: "utensils" },
            { id: 51, type: "Both", title: "Ice Cube Play", desc: "Run ice over loser's body. No touching.", icon: "snowflake" },
            { id: 52, type: "Her", title: "Dress Up (Her)", desc: "He picks her outfit for the night.", icon: "shirt" },
            { id: 53, type: "Him", title: "Dress Up (Him)", desc: "She picks his outfit for the night.", icon: "shirt" },
            { id: 54, type: "Both", title: "Slow Dance", desc: "Dance to a slow romantic song.", icon: "music" },
            { id: 55, type: "Both", title: "Hand Holding", desc: "Hold hands for 30 mins straight.", icon: "heart-handshake" },
            { id: 56, type: "Both", title: "Deep Gaze", desc: "Stare into eyes for 5 mins. No blinking.", icon: "eye" },
            { id: 57, type: "Her", title: "Thigh Massage", desc: "He massages her inner thighs.", icon: "move" },
            { id: 58, type: "Him", title: "Thigh Pillow", desc: "He rests head on her thighs for 15 mins.", icon: "moon" },
            { id: 59, type: "Both", title: "Dirty Talk", desc: "Winner whispers dirty things for 5 mins.", icon: "mic" },
            { id: 60, type: "Both", title: "Confession", desc: "Tell a secret you've never told.", icon: "key" },
            { id: 61, type: "Both", title: "Phone Swap", desc: "Let partner see your gallery for 2 mins.", icon: "smartphone" },
            { id: 62, type: "Her", title: "Makeup Artist", desc: "He does her makeup (try his best).", icon: "pencil" },
            { id: 63, type: "Him", title: "Shave/Groom", desc: "She helps him shave/groom.", icon: "scissors" },
            { id: 64, type: "Both", title: "Strip Poker", desc: "Play a hand. Loser strips one item.", icon: "club" },
            { id: 65, type: "Both", title: "Car Fun", desc: "Find a secluded spot. You know the rest.", icon: "car" },
            { id: 66, type: "Her", title: "Lingerie Shopping", desc: "He buys her a set she picks.", icon: "shopping-bag" },
            { id: 67, type: "Him", title: "Gadget Time", desc: "1 hour unbothered with his tech.", icon: "monitor" },
            { id: 68, type: "Both", title: "Yoga Together", desc: "Try a couple's yoga pose.", icon: "activity" },
            { id: 69, type: "Both", title: "Workout Buddy", desc: "Do 20 squats together. Naked.", icon: "dumbbell" },
            { id: 70, type: "Both", title: "Feeding", desc: "Winner feeds loser dinner bite by bite.", icon: "utensils" },
            { id: 71, type: "Her", title: "Pedicure", desc: "He paints her toenails.", icon: "brush" },
            { id: 72, type: "Him", title: "Manicure", desc: "She trims his nails.", icon: "scissors" },
            { id: 73, type: "Both", title: "Karaoke", desc: "Sing a duet. Loudly.", icon: "mic-2" },
            { id: 74, type: "Both", title: "Drawing", desc: "Draw each other naked. Best art wins.", icon: "pen-tool" },
            { id: 75, type: "Her", title: "Carry Me", desc: "He carries her to bed.", icon: "arrow-up" },
            { id: 76, type: "Him", title: "Lazy Boy", desc: "He doesn't move from the couch for 1 hour.", icon: "armchair" },
            { id: 77, type: "Both", title: "Nap Time", desc: "Take a nap together. Cuddling required.", icon: "moon" },
            { id: 78, type: "Both", title: "Tickle Fight", desc: "Until someone says mercy.", icon: "feather" },
            { id: 79, type: "Both", title: "Wrestle", desc: "Play wrestle on the bed.", icon: "swords" },
            { id: 80, type: "Her", title: "Dominant Hour", desc: "She is in charge for 1 hour.", icon: "lock" },
            { id: 81, type: "Him", title: "Dominant Hour", desc: "He is in charge for 1 hour.", icon: "lock" },
            { id: 82, type: "Both", title: "Submissive Hour", desc: "Both must serve each other.", icon: "unlock" },
            { id: 83, type: "Both", title: "Outdoor Kiss", desc: "Kiss in public where people might see.", icon: "sun" },
            { id: 84, type: "Both", title: "Elevator Action", desc: "Quick kiss/touch in an elevator.", icon: "arrow-up-circle" },
            { id: 85, type: "Her", title: "No Cooking", desc: "He cooks or orders. She does nothing.", icon: "coffee" },
            { id: 86, type: "Him", title: "Dish Duty", desc: "She washes all the dishes today.", icon: "droplet" },
            { id: 87, type: "Both", title: "Movie Marathon", desc: "Watch 2 movies back to back.", icon: "film" },
            { id: 88, type: "Both", title: "Series Binge", desc: "Watch 3 episodes of a show.", icon: "tv" },
            { id: 89, type: "Her", title: "Book Read", desc: "He reads a romantic chapter to her.", icon: "book" },
            { id: 90, type: "Him", title: "Sports Pass", desc: "Watch a full game undisturbed.", icon: "trophy" },
            { id: 91, type: "Both", title: "Cocktail Night", desc: "Make drinks for each other.", icon: "martini" },
            { id: 92, type: "Both", title: "No Sleep", desc: "Stay up all night talking/fun.", icon: "sunrise" },
            { id: 93, type: "Her", title: "Morning Coffee", desc: "He brings her coffee in bed.", icon: "coffee" },
            { id: 94, type: "Him", title: "Morning Tea", desc: "She brings him tea in bed.", icon: "coffee" },
            { id: 95, type: "Both", title: "Scent Play", desc: "Winner picks the perfume/cologne for loser.", icon: "wind" },
            { id: 96, type: "Both", title: "Taste Test", desc: "Blindfolded taste test of kitchen items.", icon: "apple" },
            { id: 97, type: "Both", title: "Video Game", desc: "Play a co-op game together.", icon: "gamepad" },
            { id: 98, type: "Both", title: "Board Game", desc: "Play a board game. Winner gets a wish.", icon: "box" },
            { id: 99, type: "Her", title: "Compliment List", desc: "He writes 10 things he loves about her.", icon: "list" },
            { id: 100, type: "Him", title: "Compliment List", desc: "She writes 10 things she loves about him.", icon: "list" }
        ];

        window.renderCoupons = () => {
             if (!window.checkLicensingStatus()) return;
            const grid = document.getElementById('coupons-grid'); grid.innerHTML = '';
            detailedCoupons.forEach(c => {
                const status = couponStatus[c.id];
                const el = document.createElement('div');
                const badgeClass = c.type === 'Her' ? 'target-her' : (c.type === 'Him' ? 'target-him' : 'target-both');
                let cardClass = 'locked hover:bg-white/5';
                let borderColor = c.type === 'Her' ? 'border-pink-500/30' : (c.type === 'Him' ? 'border-blue-500/30' : 'border-purple-500/30');
                let statusHtml = '';
                let isClickable = true;

                if (status && status.type === 'won') {
                    cardClass = 'won'; borderColor = 'border-green-400';
                    const expiry = new Date(); expiry.setHours(24,0,0,0);
                    statusHtml = `<p class='text-[10px] font-bold text-green-400 mt-1 uppercase'>WON BY ${status.winner}</p><p class="text-[9px] font-mono text-white/60 timer-display" data-target="${expiry.getTime()}">Resets in: ...</p>`;
                    isClickable = false;
                } else {
                    statusHtml = `<p class='text-[10px] font-bold text-amber-400 mt-1 opacity-70'>CLICK TO BATTLE</p>`;
                }

                el.className = `coupon-card p-4 rounded-xl flex items-start justify-between cursor-pointer border ${borderColor} ${cardClass}`;
                el.innerHTML = `<div class="coupon-hole left-[-10px]"></div><div class="flex-1 pr-2"><div class="flex items-center gap-2 mb-1"><span class="target-badge ${badgeClass}">${c.type === 'Both' ? 'FOR BOTH' : (c.type === 'Him' ? 'FOR HIM' : 'FOR HER')}</span></div><h3 class="font-bold text-lg leading-tight mb-1 text-white">${c.title}</h3><p class="text-xs opacity-70 leading-relaxed">${c.desc}</p>${statusHtml}</div><div class="flex flex-col items-center justify-center pl-2 border-l border-white/10"><i data-lucide="${c.icon}" class="w-6 h-6 opacity-60 mb-1"></i>${status && status.type === 'won' ? '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>' : '<span class="text-[8px] uppercase opacity-40">RPS</span>'}</div><div class="coupon-hole right-[-10px]"></div>`;
                if(isClickable) el.onclick = () => window.openRPS(c);
                grid.appendChild(el);
            });
            if(window.lucide) lucide.createIcons();
            window.updateTimers();
        };

        window.openRPS = (coupon) => {
            window.state.rps.currentCoupon = coupon; window.state.rps.p1Move = null; window.state.rps.p2Move = null; window.state.rps.isAutoSaved = false;
            document.getElementById('coupon-list-view').classList.add('hidden');
            document.getElementById('rps-arena').classList.remove('hidden');
            document.getElementById('rps-selection-area').classList.remove('hidden');
            document.getElementById('rps-countdown').classList.add('hidden');
            document.getElementById('rps-result-area').classList.add('hidden');
            document.getElementById('rps-status').textContent = `BATTLE FOR: ${coupon.title}`;
            
            let firstPlayer = window.state.names.Him; 
            
            if (window.state.isMultiplayer) {
                if (window.state.myRole === 'Him') {
                    document.getElementById('p1-name-display').textContent = `${firstPlayer}'s Turn (Your Move!)`;
                    document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = false);
                } else {
                    document.getElementById('p1-name-display').textContent = `${firstPlayer}'s Turn (Partner's Move - Anticipate...)`;
                    document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = true);
                }
            } else {
                document.getElementById('p1-name-display').textContent = `${window.state.names.Him}'s Turn (Hide Screen!)`;
                document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = false);
            }
        };

        window.playRPSMove = (move) => {
            if (window.state.isMultiplayer) {
                // Him (P1) is myRole, and P1Move is null -> I am the first mover
                if (window.state.myRole === 'Him' && !window.state.rps.p1Move) {
                    window.state.rps.p1Move = move;
                    document.getElementById('p1-name-display').textContent = `${window.state.names.Her}'s Turn (Partner's Move)`;
                    document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = true);
                    sendStateUpdate('RPS_MOVE', { role: 'Him', move: move, couponId: window.state.rps.currentCoupon.id });
                } 
                // Her (P2) is myRole, and P1Move is known -> I am the second mover, ready for showdown
                else if (window.state.myRole === 'Her' && window.state.rps.p1Move && !window.state.rps.p2Move) {
                    window.state.rps.p2Move = move;
                    document.querySelectorAll('.rps-btn').forEach(btn => btn.disabled = true);
                    sendStateUpdate('RPS_MOVE', { role: 'Her', move: move, couponId: window.state.rps.currentCoupon.id });
                    
                    window.startRPSShowdown(window.state.rps.p1Move, window.state.rps.p2Move);
                } else {
                    window.showFeedback("Wait for your turn or partner's move!", true);
                }
            } else {
                 if(!window.state.rps.p1Move) {
                    window.state.rps.p1Move = move;
                    document.getElementById('rps-selection-area').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('rps-selection-area').classList.remove('hidden');
                        document.getElementById('p1-name-display').textContent = `${window.state.names.Her}'s Turn (Don't peek!)`;
                    }, 500);
                 } else { window.startRPSShowdown(window.state.rps.p1Move, move); }
            }
        };

        window.startRPSShowdown = (p1, p2) => {
            document.getElementById('rps-selection-area').classList.add('hidden');
            document.getElementById('rps-countdown').classList.remove('hidden');
            const txt = document.getElementById('countdown-text'); let count = 3; txt.textContent = "ROCK...";
            const timer = setInterval(() => {
                count--;
                if(count === 2) txt.textContent = "PAPER..."; if(count === 1) txt.textContent = "SCISSORS...";
                if(count === 0) { clearInterval(timer); txt.textContent = "SHOOT!"; setTimeout(() => window.showRPSResult(p1, p2), 500); }
            }, 600);
        };

        window.showRPSResult = (p1, p2) => {
            document.getElementById('rps-countdown').classList.add('hidden');
            document.getElementById('rps-result-area').classList.remove('hidden');
            const getIcon = (m) => m === 'rock' ? 'hexagon' : (m === 'paper' ? 'file-text' : 'scissors');
            document.getElementById('res-icon-1').innerHTML = `<i data-lucide="${getIcon(p1)}" class="w-16 h-16 text-white"></i>`;
            document.getElementById('res-icon-2').innerHTML = `<i data-lucide="${getIcon(p2)}" class="w-16 h-16 text-white"></i>`;
            if(window.lucide) lucide.createIcons();

            let winner = null;
            if(p1 === p2) winner = 'Draw';
            else if((p1 === 'rock' && p2 === 'scissors') || (p1 === 'paper' && p2 === 'rock') || (p1 === 'scissors' && p2 === 'paper')) winner = 'Him';
            else winner = 'Her';

            const wText = document.getElementById('rps-winner-text');
            const rDesc = document.getElementById('rps-result-desc');
            const claimBtn = document.getElementById('claim-btn');
            const contractBtn = document.getElementById('contract-btn');
            const coupon = window.state.rps.currentCoupon;
            const wName = window.state.names[winner];

            claimBtn.classList.add('hidden');
            contractBtn.classList.add('hidden');

            if(winner === 'Draw') {
                wText.textContent = "DRAW! Replaying..."; wText.className = "text-3xl font-bold fancy-font mb-6 text-white"; rDesc.textContent = "Try again."; 
                setTimeout(() => { window.state.rps.p1Move = null; window.state.rps.p2Move = null; document.getElementById('rps-result-area').classList.add('hidden'); window.openRPS(coupon); }, 2000);
            } else {
                let contractCondition = false;
                if (coupon.type === 'Him' && winner === 'Him') contractCondition = true;
                else if (coupon.type === 'Her' && winner === 'Her') contractCondition = true;
                else if (coupon.type === 'Both') contractCondition = true;

                if (contractCondition) {
                    const loserName = winner === 'Him' ? window.state.names.Her : window.state.names.Him;
                    couponStatus[coupon.id] = { type: 'won', winner: wName, time: Date.now() };
                    localStorage.setItem('couponStatus', JSON.stringify(couponStatus));
                    const deal = { id: Date.now(), title: coupon.title, desc: coupon.desc, winner: wName, loser: loserName, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), status: "Auto-Sealed" };
                    savedVault.unshift(deal);
                    localStorage.setItem('contractVault', JSON.stringify(savedVault));
                    wText.textContent = `${wName} Wins!`; wText.className = "text-3xl font-bold fancy-font mb-2 text-amber-400";
                    rDesc.innerHTML = `Asset Automatically Secured in Vault! üîê<br>Official signing is optional but hot.`;
                    contractBtn.classList.remove('hidden'); contractBtn.textContent = "Sign/View Contract üíã"; 
                    window.state.rps.tempWinner = wName; window.state.rps.tempLoser = loserName; window.state.rps.isAutoSaved = true;
                    
                    // Sync vault and coupon status
                    sendStateUpdate('RPS_WIN_SYNC', { vault: savedVault, couponStatus: couponStatus });
                } else {
                     wText.textContent = `${wName} Wins!`;
                     wText.className = "text-3xl font-bold fancy-font mb-2 text-white";
                     rDesc.innerHTML = `${window.state.names[winner]} won, but this coupon was not for them. No contract sealed.`;
                     claimBtn.classList.remove('hidden'); claimBtn.textContent = "Back to List";
                }
            }
        };

        window.openContractSign = (isReadOnly, data = null) => {
            window.showScreen('contract');
            const btnSign = document.getElementById('btn-sign-deal');
            const btnClose = document.getElementById('btn-close-contract');
            const stamp = document.getElementById('contract-stamp');
            const signDisplay = document.getElementById('contract-sign-display');

            if (isReadOnly && data) {
                document.getElementById('contract-date').textContent = data.date;
                document.getElementById('contract-loser').textContent = data.loser;
                document.getElementById('contract-winner').textContent = data.winner;
                document.getElementById('contract-title').textContent = data.title;
                signDisplay.textContent = data.loser;
                stamp.classList.remove('hidden');
                btnSign.classList.add('hidden');
                btnClose.classList.remove('hidden');
            } else {
                const c = window.state.rps.currentCoupon;
                const now = new Date();
                document.getElementById('contract-date').textContent = now.toLocaleDateString();
                document.getElementById('contract-loser').textContent = window.state.rps.tempLoser;
                document.getElementById('contract-winner').textContent = window.state.rps.tempWinner;
                document.getElementById('contract-title').textContent = c.title;
                signDisplay.textContent = ""; 
                stamp.classList.add('hidden');
                btnSign.classList.remove('hidden');
                btnClose.classList.add('hidden');
            }
        };

        window.signDeal = () => {
            if(window.state.rps.isAutoSaved) {
                const loserName = window.state.rps.tempLoser;
                document.getElementById('contract-sign-display').textContent = loserName;
                setTimeout(() => {
                     document.getElementById('contract-stamp').classList.remove('hidden');
                     window.showFeedback("Contract Officially Signed! üíã"); 
                     setTimeout(() => { window.showScreen('coupons'); }, 1500);
                }, 500);
            }
        };

        window.showVault = () => { window.showScreen('vault'); window.filterVault('all'); };
        window.renderVault = () => { window.filterVault('all'); };

        window.filterVault = (filter) => {
             if (!window.checkLicensingStatus()) return;
            const list = document.getElementById('vault-list'); list.innerHTML = '';
            const filtered = savedVault.filter(d => {
                if (filter === 'all') return true;
                if (filter === 'Him') return d.winner === window.state.names.Him;
                if (filter === 'Her') return d.winner === window.state.names.Her;
                return true;
            });

            if(filtered.length === 0) { list.innerHTML = `<div class="text-center opacity-50 mt-10">No active contracts found.</div>`; return; }

            filtered.forEach(d => {
                const el = document.createElement('div');
                const borderColor = d.winner === window.state.names.Him ? 'border-blue-500' : 'border-rose-500';
                el.className = `bg-white text-gray-900 p-4 rounded-lg border-l-4 ${borderColor} shadow-md mb-3 relative cursor-pointer hover:bg-gray-50 transition-colors group`;
                el.innerHTML = `
                    <div class="absolute top-2 right-2 flex gap-2">
                         <span class="opacity-20 text-pink-600 font-bold text-xs uppercase border border-pink-200 p-1 rounded transform rotate-12">SEALED</span>
                         <button onclick="event.stopPropagation(); window.initiateDelete(${d.id}, '${d.winner}')" class="bg-red-100 hover:bg-red-200 text-red-600 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Delete Contract"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <h4 class="font-bold text-lg font-serif uppercase tracking-wider text-pink-900 pr-8">${d.title}</h4>
                    <p class="text-xs text-gray-600 mb-2">${d.desc}</p>
                    <div class="flex justify-between items-end border-t border-gray-200 pt-2 mt-2">
                        <div><p class="text-[10px] uppercase text-gray-400">Date</p><p class="font-bold text-sm text-gray-800">${d.date}</p></div>
                        <div class="text-right"><p class="text-[10px] uppercase text-gray-400">Signed By</p><p class="font-script text-lg text-pink-700 transform -rotate-2">${d.loser}</p></div>
                    </div>`;
                el.onclick = (e) => { if(!e.target.closest('button')) window.openContractSign(true, d); };
                list.appendChild(el);
            });
            if(window.lucide) lucide.createIcons();
        };

        window.closeRPS = (save) => {
            document.getElementById('rps-arena').classList.add('hidden');
            document.getElementById('coupon-list-view').classList.remove('hidden');
            window.renderCoupons();
        };
        
        // --- STORY/SAVED LOGIC (Simplified after Firebase removal) ---
        window.viewSavedStory = (data) => {
             if (!window.checkLicensingStatus()) return;
            window.showScreen('view-story');
            document.getElementById('view-story-role').textContent = data.role || 'Fantasy Roleplay';
            document.getElementById('view-story-date').textContent = data.date || new Date().toLocaleDateString();
            document.getElementById('view-story-content').innerHTML = data.content || 'Story content unavailable.';
        };

        window.copySavedStory = () => {
            const text = document.getElementById('view-story-content').innerText; const textarea = document.createElement('textarea'); textarea.value = text; textarea.style.position = 'fixed'; textarea.style.opacity = '0'; document.body.appendChild(textarea); textarea.select();
            try { document.execCommand('copy'); window.showFeedback("Story Copied!"); } catch (err) { window.showFeedback("Copy failed.", true); }
            document.body.removeChild(textarea);
        };

        window.showSavedStories = async () => {
             if (!window.checkLicensingStatus()) return;
            window.showScreen('saved'); 
            // This function is simplified since Firebase is removed.
            document.getElementById('saved-list').innerHTML = "<p class='text-center opacity-50 mt-10'>Saved Stories feature is disabled in this version. Please start a new fantasy.</p>";
        };
        
        // --- FULL DATA (MERGED) ---
        const todData = {
            truths: [
                { for: "Her", text: "Have you ever fantasized about him with someone else?" },
                { for: "Her", text: "What‚Äôs the wildest thought you‚Äôve had while touching yourself?" },
                { for: "Her", text: "Which body part of his do you secretly crave the most?" },
                { for: "Her", text: "Have you ever faked it with him?" },
                { for: "Her", text: "What‚Äôs the dirtiest thing you want him to whisper in your ear?" },
                { for: "Her", text: "If he blindfolded you right now, what‚Äôs the first thing you‚Äôd want him to do?" },
                { for: "Her", text: "Have you ever secretly recorded or wanted to record your intimate moments?" },
                { for: "Her", text: "What‚Äôs the kinkiest outfit you want to wear just for him?" },
                { for: "Her", text: "Have you ever wanted to dominate him completely?" },
                { for: "Her", text: "Have you ever imagined me going down on you for more than 30 minutes?" },
                { for: "Her", text: "Do you secretly love when I pull your hair during it?" },
                { for: "Her", text: "Have you ever tasted yourself on my lips after a kiss?" },
                { for: "Her", text: "Would you let me cum on your face?" },
                { for: "Her", text: "Do you want me to spank you harder than ever before?" },
                { for: "Her", text: "What‚Äôs the wildest place you want me to bend you over?" },
                { for: "Her", text: "Have you ever touched yourself while watching me sleep?" },
                { for: "Her", text: "Do you get turned on when I call you my slut?" },
                { for: "Her", text: "Which toy would you want me to use on you?" },
                { for: "Her", text: "Have you ever sent nudes to anyone except me?" },
                { for: "Her", text: "Have you ever imagined him taking full control in bed without asking?" },
                { for: "Her", text: "What‚Äôs the dirtiest compliment you secretly want from him?" },
                { for: "Her", text: "Have you ever touched yourself thinking about him while he was away?" },
                { for: "Her", text: "What‚Äôs the wildest public place you dream about doing it with him?" },
                { for: "Her", text: "What‚Äôs the boldest outfit you wish to wear for him in bed?" },
                { for: "Him", text: "Have you ever imagined her friend naked?" },
                { for: "Him", text: "What‚Äôs the dirtiest thing you‚Äôve searched online but never told her?" },
                { for: "Him", text: "Which body part of hers you could spend hours worshipping?" },
                { for: "Him", text: "Have you ever thought about tying her up?" },
                { for: "Him", text: "What‚Äôs the wildest roleplay you‚Äôd want to try with her?" },
                { for: "Him", text: "Would you ever let her tease you without touching you all night?" },
                { for: "Him", text: "What‚Äôs the craziest position you secretly want to try with her?" },
                { for: "Him", text: "Have you ever wanted her to completely control you?" },
                { for: "Him", text: "Do you want her to swallow or spit?" },
                { for: "Him", text: "Have you ever jerked off thinking about her moans?" },
                { for: "Him", text: "What‚Äôs the dirtiest porn category you‚Äôve watched?" },
                { for: "Him", text: "Do you secretly want to record our sex tape?" },
                { for: "Him", text: "Would you lick her ass if she asked?" },
                { for: "Him", text: "Do you imagine her riding you while you‚Äôre at work?" },
                { for: "Him", text: "Do you want her to choke you while she rides?" },
                { for: "Him", text: "Which part of her body do you dream of finishing on?" },
                { for: "Him", text: "Would you fuck her in front of a mirror?" },
                { for: "Him", text: "Have you ever cum just by hearing her voice?" },
                { for: "Him", text: "What‚Äôs the longest you‚Äôve lasted without touching yourself thinking of her?" },
                { for: "Him", text: "What‚Äôs the dirtiest thing she has done that blew your mind?" },
                { for: "Both", text: "Would you both dare to do it in the balcony at night?" },
                { for: "Both", text: "Who wants it rougher ‚Äî him or her?" },
                { for: "Both", text: "Which position would you both do endlessly if there were no limits?" },
                { for: "Both", text: "Would you both try anal?" },
                { for: "Both", text: "Have you both thought of a threesome?" },
                { for: "Both", text: "Who moans louder during sex?" },
                { for: "Both", text: "Would you both dare to fuck in the shower?" },
                { for: "Both", text: "Who enjoys teasing more before sex?" },
                { for: "Both", text: "Do you both want to try roleplay in bed?" },
                { for: "Both", text: "Have you ever thought of a voyeuristic fantasy with me?" },
                { for: "Both", text: "Do you like when I whisper naughty commands in your ear?" },
                { for: "Both", text: "Which forbidden act excites you the most?" },
                { for: "Both", text: "Would you try pegging if I asked?" },
                { for: "Both", text: "Have you ever wanted to fuck in a car or public spot?" },
                { for: "Both", text: "What‚Äôs the kinkiest thing you‚Äôve done in bed?" }
            ],
            dares: [
                { for: "Her", text: "Give him a lap dance for 2 minutes with music on." },
                { for: "Her", text: "Lick chocolate off his chest slowly." },
                { for: "Her", text: "Whisper the dirtiest thing you can think of in his ear." },
                { for: "Her", text: "Blindfold him and tease him with only your lips for 3 minutes." },
                { for: "Her", text: "Kiss every part of his body but skip the lips for 2 minutes." },
                { for: "Her", text: "Call him ‚ÄòDaddy‚Äô until your next turn." },
                { for: "Her", text: "Sit on his lap and grind for 60 seconds." },
                { for: "Her", text: "Make a moan sound in his ear without touching him." },
                { for: "Her", text: "Take off one piece of clothing in the slowest way possible." },
                { for: "Her", text: "Write ‚ÄòI‚Äôm yours‚Äô on his chest with your tongue." },
                { for: "Her", text: "Give your partner a blowjob/lick job for 1 minute without stopping." },
                { for: "Her", text: "Sit on his face and don‚Äôt move for 30 seconds." },
                { for: "Her", text: "Ride him for 2 minutes no matter where you are sitting right now." },
                { for: "Her", text: "Whisper ‚Äòfuck me‚Äô in his ear 10 times with a moan." },
                { for: "Her", text: "Remove your panties and throw them at him." },
                { for: "Her", text: "Play with yourself while looking into his eyes." },
                { for: "Her", text: "Let him spank you as hard as he wants 5 times." },
                { for: "Her", text: "Lick his cock tip slowly without finishing him." },
                { for: "Her", text: "Do a striptease while touching your own body." },
                { for: "Her", text: "Kiss his lower stomach and go lower slowly." },
                { for: "Him", text: "Kiss her thighs slowly until she tells you to stop." },
                { for: "Him", text: "Bite her neck gently and leave a mark." },
                { for: "Him", text: "Massage her inner thighs without going further for 2 minutes." },
                { for: "Him", text: "Pin her against the wall and kiss her passionately." },
                { for: "Him", text: "Take off her socks/footwear with just your teeth." },
                { for: "Him", text: "Hold her wrists and kiss her without letting her move." },
                { for: "Him", text: "Say the nastiest fantasy you want to try with her right now." },
                { for: "Him", text: "Go down on her for exactly 1 minute‚Äîno more, no less." },
                { for: "Him", text: "Kiss her stomach slowly moving downward but stop before reaching her spot." },
                { for: "Him", text: "Pick her up and carry her to the bed in the hottest way possible." },
                { for: "Him", text: "Eat her out until she moans loudly." },
                { for: "Him", text: "Finger her slowly while looking into her eyes." },
                { for: "Him", text: "Make her beg before you kiss her lips." },
                { for: "Him", text: "Pick her up and pin her against the wall." },
                { for: "Him", text: "Choke her lightly while kissing passionately." },
                { for: "Him", text: "Lick her nipples until she says stop." },
                { for: "Him", text: "Tie her hands and tease her with your tongue." },
                { for: "Him", text: "Slap her ass hard 3 times and kiss it." },
                { for: "Him", text: "Make her sit on your lap and grind." },
                { for: "Him", text: "Tease her pussy with just your tongue tip." },
                { for: "Both", text: "Kiss each other passionately for 2 minutes without break." },
                { for: "Both", text: "Do a 69 position for 1 minute (no finishing)." },
                { for: "Both", text: "Record a 10-second moaning video together." },
                { for: "Both", text: "Touch each other under clothes while blindfolded." },
                { for: "Both", text: "French kiss and don‚Äôt stop until you‚Äôre both out of breath." },
                { for: "Both", text: "Remove each other‚Äôs top using only your mouth." },
                { for: "Both", text: "Do a slow lap dance for each other." },
                { for: "Both", text: "Try a new sex position immediately." },
                { for: "Both", text: "Make out in the dirtiest way possible for 3 minutes." },
                { for: "Both", text: "Whisper your nastiest fantasy in each other‚Äôs ear." },
                { for: "Both", text: "Spank each other for 10 seconds while kissing." },
                { for: "Both", text: "Blindfold your partner and tease them with ice or fingers." },
                { for: "Both", text: "Remove one piece of clothing each in 5 seconds." },
                { for: "Both", text: "Moan loudly in front of your partner for 30 seconds." }
            ]
        };
        // --- 50 POSITIONS (Detailed) ---
        const positions = [
            { icon: "heart", title: "Face-to-Face Lap Sit", tease: "Intimacy Overload", method: "SHE: Sit on his lap facing him, wrap your legs around his waist. HE: Hold her close and kiss her deeply. Maintain eye contact." },
            { icon: "moon", title: "Side Spoons", tease: "Lazy & Deep", method: "SHE: Lie on your side. HE: Lie behind her, curling around her back. Whisper in your ear while your hands roam her body." },
            { icon: "zap", title: "Standing Against Wall", tease: "Quick & Urgent", method: "SHE: Stand against a wall, lift one leg up. HE: Stand close, support her leg, and press your body against hers. Kiss passionately." },
            { icon: "crown", title: "Queen on Top", tease: "Take Control", method: "HE: Lie on your back. SHE: Straddle him, sitting upright. You control the pace and depth. Lean back to tease him with the view." },
            { icon: "rotate-cw", title: "Reverse Cowgirl", tease: "The Best View", method: "HE: Lie back and enjoy the view. SHE: Sit on top facing his feet. Use his legs for support and grind slowly." },
            { icon: "arrow-up", title: "Legs on Shoulders", tease: "Total Surrender", method: "SHE: Lie on back, lift legs and rest them on his shoulders. HE: Kneel and enter deeply. Hold her hands for connection." },
            { icon: "music", title: "The Lap Dance", tease: "Tease Him", method: "HE: Sit on a chair. SHE: Straddle him facing forward. Grind slowly on his lap without removing clothes at first. Whisper what you want." },
            { icon: "repeat", title: "The 69", tease: "Give & Take", method: "BOTH: Lie head-to-toe. Focus entirely on oral pleasure for each other. Take your time and listen to the moans." },
            { icon: "anchor", title: "The Anvil", tease: "Deep Impact", method: "SHE: Lie on back, lift legs high onto his chest. HE: Kneel and enter deeply. Hold her hands for connection." },
            { icon: "feather", title: "Prone Bone", tease: "Soft Entry", method: "HE: Lie flat on your stomach. SHE: Lie on top of him. Relaxed, intimate grinding with full body contact." },
            { icon: "paw-print", title: "Doggy Style", tease: "Primal Control", method: "SHE: Get on hands and knees. Arch your back. HE: Enter from behind. Grab her hips or hair gently to take control." },
            { icon: "mountain", title: "Edge of Bed", tease: "Perfect Angle", method: "SHE: Lie on back at the edge of the bed. HE: Stand between her legs. This offers him great control and a deep angle." },
            { icon: "sun", title: "The Deck Chair", tease: "Relaxed", method: "HE: Sit up with legs extended. SHE: Sit between his legs, leaning back against his chest. His hands are free to roam." },
            { icon: "flame", title: "The Bridge", tease: "Arch Back", method: "SHE: Lie on back, lift hips high into a bridge. HE: Support her waist. The angle hits deep. Submit to gravity." },
            { icon: "eye", title: "Seated Face-Off", tease: "Eye Contact", method: "SHE: Sit on the edge of a table. HE: Stand between her legs. Lock eyes. Kiss deeply while connecting." },
            { icon: "link", title: "The Pretzel", tease: "Tangled", method: "SHE: One leg over his shoulder, the other wrapped around his waist. HE: Hold her tight. Feel every heartbeat." },
            { icon: "waves", title: "Head Rush", tease: "Blood Rush", method: "SHE: Lie with head hanging slightly off the bed. HE: Stand above. The blood rush heightens every sensation." },
            { icon: "coffee", title: "Lazy Dog", tease: "Comfort", method: "SHE: Lie flat on stomach with a pillow under hips. HE: Enter from behind. Relax completely." },
            { icon: "flower", title: "The Butterfly", tease: "Open Up", method: "SHE: Lie on back, lift legs straight up. HE: Kneel close. Allows for deep intimacy and eye contact." },
            { icon: "armchair", title: "The Throne", tease: "Embrace", method: "HE: Sit cross-legged. SHE: Sit on his lap facing away. HE: Wrap arms around her. Cozy and filling." },
            { icon: "layers", title: "The Flatiron", tease: "Friction", method: "SHE: Lie on stomach, hips slightly raised. HE: Lie on top. Enjoy the friction of full body contact." },
            { icon: "activity", title: "The Dancer", tease: "Balance", method: "BOTH: Stand up. SHE: Lift one leg high onto his shoulder or hip. HE: Hold her tight for balance. Deep stretches." },
            { icon: "triangle", title: "Raised Hips", tease: "Lifted", method: "SHE: Lie on back with pillows under hips. HE: Enter from above. Changes the angle completely." },
            { icon: "shuffle", title: "The X", tease: "Diagonal", method: "BOTH: Missionary but shift bodies diagonally. Rubbing against each other creates electric friction." },
            { icon: "snowflake", title: "Snow Angel", tease: "Exposed", method: "SHE: Lie back, spread arms and legs wide. HE: Enter and worship her body. Surrender control." },
            { icon: "scissors", title: "The Scissor", tease: "Scissoring", method: "BOTH: Lie side by side facing each other, one leg between the other's. Squeeze thighs for sensation." },
            { icon: "bug", title: "The Spider", tease: "Wrapped", method: "SHE: Sit face to face, wrap arms and legs around him completely. HE: Rock back and forth together." },
            { icon: "check", title: "The V", tease: "Wide Open", method: "SHE: Sit on table edge, legs in V shape. HE: Stand close. Holding hands allows for deep leverage." },
            { icon: "key", title: "Pinned Wall", tease: "No Escape", method: "HE: Pin her against a wall. SHE: Lift one leg up. HE: Hold her tight for balance. Deep stretches." },
            { icon: "droplet", title: "Shower Sex", tease: "Slippery", method: "BOTH: Under warm water. HE: Support her against wet tiles. Steam and passion combined. Be careful!" },
            { icon: "lock", title: "Hands Tied", tease: "Pretend", method: "SHE: Hold hands above head (or tie them). HE: Explore her body without her touching back." },
            { icon: "mic", title: "Her Pleasure", tease: "Worship Her", method: "SHE: Sit on edge or lie back. HE: Focus entirely on oral pleasure for 10 minutes. No rushing." },
            { icon: "mic-2", title: "His Pleasure", tease: "Worship Him", method: "HE: Sit or lie back. SHE: Take control orally. Use hands and mouth together for maximum effect." },
            { icon: "navigation", title: "Standing Rear", tease: "Quickie", method: "BOTH: Standing. SHE: Bend over slightly holding a surface. HE: Enter from behind. Fast pace." },
            { icon: "camera", title: "Mirror View", tease: "Visual", method: "BOTH: Do it in front of a mirror. Watch yourselves connect. The visual stimulation adds a layer." },
            { icon: "award", title: "Golden Arch", tease: "Deep Curve", method: "SHE: On back, pillow under lower back. Shoulders on bed. Maximum pelvic tilt for sensation." },
            { icon: "smile", title: "Happy Baby", tease: "Flexible Fun", method: "SHE: Lie on back, grab your own feet. HE: Enter deep. Very exposing and intense." },
            { icon: "star", title: "The Starfish", tease: "Relax", method: "SHE: Lay back, spread out. HE: Do absolutely all the work. Just enjoy the sensation." },
            { icon: "shield", title: "The Guard", tease: "Protect", method: "HE: Sit up. SHE: Sit facing him. Wrap arms around his neck and bury face in his neck." },
            { icon: "sword", title: "The Conqueror", tease: "Power", method: "HE: Stand up. SHE: Wrap legs around his waist. HE: Hold her up. Requires strength but very intimate." },
            { icon: "heart-pulse", title: "The Pulse", tease: "Rhythm", method: "BOTH: Missionary, but focus entirely on syncing your breathing and movement perfectly." },
            { icon: "battery-charging", title: "The Charge", tease: "Energy", method: "SHE: Sit on him, lean back on hands. Grind hard and fast." },
            { icon: "bluetooth", title: "The Connect", tease: "Close", method: "ANY: Keep foreheads touching and eyes open the entire time. Slow movement." },
            { icon: "wifi", title: "The Signal", tease: "Strong", method: "SHE: Doggy style, but stretch arms forward. HE: Hold her hands stretched forward on the bed." },
            { icon: "radio", title: "Blindfold", tease: "Listen", method: "ONE: Wear a blindfold. Focus only on sound and touch. Let other senses take over." },
            { icon: "tv", title: " The Show", tease: "Watch", method: "ONE: Watch while the other touches themselves. Visual foreplay only for 5 minutes." },
            { icon: "film", title: "The Movie", tease: "Act", method: "BOTH: Roleplay a scene before touching. Build the tension with dialogue first." },
            { icon: "disc", title: "The Spin", tease: "Rotate", method: "SHE: On top, move hips in circles. Don't just go up and down. Grind the clit." },
            { icon: "speaker", title: "Loud Love", tease: "Vocal", method: "BOTH: Encourage moaning and dirty talk. The louder, the better." },
            { icon: "headphones", title: "Silent Love", tease: "Quiet", method: "BOTH: Try to climax without making a sound. The suppression makes it more intense." }
        ];
        
        // --- NHIE DATA (MERGED) ---
        // Statements translated to English for distribution.
        const nhieStatements = [
            "Never have I ever wished my partner was here when I was naked.",
            "Never have I ever watched your photo/video while masturbating.",
            "Never have I ever used a sex toy with the video call muted.",
            "Never have I ever kept my full sex fantasy a secret from you.",
            "Never have I ever thought the partner's neighbor was hot.",
            "Never have I ever kept my eyes open while kissing.",
            "Never have I ever secretly taken off my clothes during a zoom call.",
            "Never have I ever complained about you to a friend.",
            "Never have I ever gotten bored of your favorite position.",
            "Never have I ever wished you were here right now.",
            "Never have I ever wished I were single for more freedom.",
            "Never have I ever sent my nude picture to someone else.",
            "Never have I ever flirted with your friend.",
            "Never have I ever not missed you when you were busy.",
            "Never have I ever ignored you when you were angry.",
            "Never have I ever hidden someone else's mark on my body.",
            "Never have I ever stalked my ex.",
            "Never have I ever thought of you in the shower.",
            "Never have I ever secretly worn your panties/boxers.",
            "Never have I ever thought a sex toy was better than you.",
            "Never have I ever pretended to be angry over something you did.",
            "Never have I ever flashed you naked during a video call.",
            "Never have I ever thought of using an ice-cube on your body.",
            "Never have I ever thought about tying you up and controlling you.",
            "Never have I ever gotten hard/wet just by hearing your voice.",
            "Never have I ever continued flirting after being told no.",
            "Never have I ever thought your friend was hot.",
            "Never have I ever planned a big surprise for you.",
            "Never have I ever read your message and not replied.",
            "Never have I ever lied about being busy.",
            "Never have I ever pretended to be asleep on a sleep call.",
            "Never have I ever hidden a condom in a lunchbox.",
            "Never have I ever made a secret account on a dating app.",
            "Never have I ever gone on a trip without telling you.",
            "Never have I ever tried to check your phone.",
            "Never have I ever guessed your password.",
            "Never have I ever ordered a sex toy in your name.",
            "Never have I ever recorded your voice (without permission).",
            "Never have I ever covered up a secret with a lie.",
            "Never have I ever wished you were more romantic.",
            "Never have I ever wished you were more bold.",
            "Never have I ever slept wearing your T-shirt.",
            "Never have I ever had dirty thoughts while looking at you.",
            "Never have I ever lied to you while looking in your eyes.",
            "Never have I ever taken the blame for your mistake.",
            "Never have I ever secretly kept your favorite snack.",
            "Never have I ever hugged you without reason.",
            "Never have I ever imagined you with someone else.",
            "Never have I ever kissed you while you were asleep on a video call."
        ];

        const nhiePunishments = [
            { title: "Contract of Total Control", desc: "The Loser is stripped and blindfolded. The Winner has 20 minutes of absolute control using ice, breath, and warmth. The Loser cannot speak or move. The goal is to bring them to the edge but deny release until the Winner permits. (Winner's Choice)", icon: "hand-metal" },
            { title: "The Forbidden Fantasies", desc: "Loser must fully and explicitly share their deepest, darkest, most forbidden fantasy with the Winner. Then, they must act out a part of that fantasy (over call or text) as decided by the Winner.", icon: "zap" },
            { title: "20-Minute Oral Feast", desc: "The Winner gets to demand a 20-minute uninterrupted oral session from the Loser the next time they meet. The Loser cannot stop or speak, only focus on the Winner's pleasure.", icon: "heart-handshake" },
            { title: "Blind Date Naughty Night", desc: "The Loser must plan a complete surprise night for the Winner (virtual or in-person). The catch: the Loser must wear a blindfold for the entire intimate session and listen to the Winner's whispers.", icon: "eye-off" }
        ];

        // --- MEMORY DATA (MERGED) ---
        const memoryRewards = [
            { icon: "hand", title: "Oral Pleasure", 
                him: { reward: "She goes down on him until he begs for mercy." }, 
                her: { reward: "He goes down on her until she begs for mercy." } 
            },
            { icon: "feather", title: "Body Massage", 
                him: { reward: "She gives him a full body oil massage, ending with a happy finish." }, 
                her: { reward: "He gives her a sensual full body massage, focusing on erogenous zones." } 
            },
            { icon: "flame", title: "Strip Tease", 
                him: { reward: "She performs a slow, seductive striptease for him." }, 
                her: { reward: "He performs a sexy striptease just for her eyes." } 
            },
            { icon: "eye", title: "Blindfold Play", 
                him: { reward: "She blindfolds him and teases his body with ice/feather." }, 
                her: { reward: "He blindfolds her and teases her body with ice/feather." } 
            },
            { icon: "user", title: "Roleplay Fantasy", 
                him: { reward: "She acts out his deepest fantasy role for the night." }, 
                her: { reward: "He acts out her deepest fantasy role for the night." } 
            },
            { icon: "zap", title: "Toy Control", 
                him: { reward: "She uses a toy on him (or lets him use one on her as he directs)." }, 
                her: { reward: "He uses a toy on her for 15 minutes of pure pleasure." } 
            },
            { icon: "droplet", title: "Shower Fun", 
                him: { reward: "She joins him in the shower and washes every inch of him." }, 
                her: { reward: "He joins her in the shower and washes every inch of her." } 
            },
            { icon: "lock", title: "Total Control", 
                him: { reward: "He controls her body and actions for 10 minutes." }, 
                her: { reward: "She controls his body and actions for 10 minutes." } 
            },
        ];

        const memoryContracts = {
            Him: {
                title: "ULTIMATE FANTASY: Total Submission",
                desc: "The Partner (Her) must be completely stripped and bound (consensually). She must accept 3 intimate commands from the Winner (Him) during this period and obey without question. This is for complete, loving submission and worship."
            },
            Her: {
                title: "ULTIMATE FANTASY: Slave for an Hour",
                desc: "The Partner (Him) must remain entirely naked for one hour, acting as her personal servant. He must fulfill all physical needs She dictates. The Winner (Her) controls the pace and duration of all acts."
            }
        };

        const rolesData = [
            "Boss & Secretary", "Neighbors", "Doctor & Patient", "Stranger at Bar", 
            "Photographer & Model", "Thief & Homeowner", "Ex-Lovers", "Massage Therapist", 
            "CEO & Intern", "Pilot & Flight Attendant", "Vampire & Human", "Roommates", 
            "Strict Boss & Late Employee", "Nurse & Patient", "Plumber & Homeowner", 
            "Maid/Butler & Owner", "Personal Trainer & Client", "Uber Driver & Passenger", 
            "Hitchhiker & Driver", "High School Crush", "Police & Thief", "Arranged Marriage", 
            "Professor & Student", "Landlord & Tenant", "Babysitter & Single Parent", 
            "Best Friend's Partner", "Pizza Delivery", "Yoga Instructor", "Mechanic & Customer", 
            "Hotel Staff & Guest", "Gym Crush", "Cinema Strangers", "Kidnapper & Hostage", 
            "Rival Spies", "Bodyguard & Celebrity", "Soldier & Nurse", "King & Servant", 
            "Ghost & Living", "Coworkers (Rivals)", "Interviewer & Candidate", "Librarian & Student", 
            "Guest & Host", "Home Tutor & Parent", "Tattoo Artist", "Tailor & Customer", 
            "Hairdresser & Client", "Park Meeting", "Train Journey", "Lifeguard & Swimmer", 
            "Pirate & Captive"
        ];
        
        // --- NEW: AI MOVIE PICKER DATA (UPDATED) ---
        const movieIndustries = [
            "Hollywood (English)", "Bollywood (Hindi)", "Korean (K-Drama)", 
            "European Cinema", "Regional Indian (South/Marathi)", "Animated/Studio Ghibli"
        ];
        
        const movieLanguages = [
            "English", "Hindi", "Korean", "Spanish", 
            "French", "Marathi", "Tamil", "Telugu", "Any Language"
        ];

        const movieGenres = [
            "Romantic Comedy (Light & Fun)", 
            "Steamy Romance (18+ Adult)", 
            "Spicy Thriller (Dark Desire)", 
            "Erotic Drama (Intense)",
            "Web Series (Binge-worthy)", 
            "Adult Animation (Couple Fun)",
            "Classic 90s Romance", 
            "Horror (Cuddle Factor)", 
            "Mystery/Crime"
        ];

        window.initMovies = () => {
             if (!window.checkLicensingStatus()) return;
            // Populate Industry List
            const industryList = document.getElementById('industry-list');
            industryList.innerHTML = '';
            movieIndustries.forEach(i => {
                const btn = document.createElement('button');
                btn.className = 'genre-btn text-white w-full';
                btn.innerHTML = `<span>${i}</span><i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>`;
                btn.onclick = () => window.selectMovieFilter('industry', i, btn);
                industryList.appendChild(btn);
            });
            
            // Populate Language List
            const languageList = document.getElementById('language-list');
            languageList.innerHTML = '';
            movieLanguages.forEach(l => {
                const btn = document.createElement('button');
                btn.className = 'genre-btn text-white w-full';
                btn.innerHTML = `<span>${l}</span><i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>`;
                btn.onclick = () => window.selectMovieFilter('language', l, btn);
                languageList.appendChild(btn);
            });

            // Populate Genre List (Existing)
            const genreList = document.getElementById('genre-list');
            genreList.innerHTML = '';
            movieGenres.forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'genre-btn text-white w-full';
                btn.innerHTML = `<span>${g}</span><i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>`;
                btn.onclick = () => window.selectMovieFilter('genre', g, btn);
                genreList.appendChild(btn);
            });

            // Reset UI
            document.getElementById('movie-result').classList.add('hidden');
            document.getElementById('movie-intro').classList.remove('hidden');
            document.getElementById('btn-suggest-movie').classList.add('hidden');
            window.state.movie.genre = null;
            window.state.movie.industry = null;
            window.state.movie.language = null;
            if(window.lucide) lucide.createIcons();
            window.checkMovieReadiness();
        };

        window.selectMovieFilter = (type, value, btnElement) => {
            // Update state
            window.state.movie[type] = value;

            // Update UI active state
            const listId = `${type}-list`;
            document.getElementById(listId).querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            
            window.checkMovieReadiness();
        };
        
        window.checkMovieReadiness = () => {
             const btn = document.getElementById('btn-suggest-movie');
             const allFiltersSelected = window.state.movie.genre && window.state.movie.industry && window.state.movie.language;
             
             if (allFiltersSelected) {
                 btn.classList.remove('hidden');
                 btn.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4"></i> Get Perfect Movie Date!`;
             } else {
                 btn.classList.add('hidden');
             }
             if(window.lucide) lucide.createIcons();
        };


        window.generateAIMovie = async () => {
             if (!window.checkLicensingStatus()) {
                window.showFeedback("App Locked! Please enter your Passkey to use AI features.", true);
                return;
            }
            // Set pending action before checking key
            window.state.pendingAction = window.generateAIMovie;

            if (!window.state.geminiKey) {
                window.openAPIKeyModal();
                return;
            }
            if (!window.state.movie.genre || !window.state.movie.industry || !window.state.movie.language) {
                 window.showFeedback("Please select one option from Industry, Language, and Genre.", true);
                 return;
            }

            const { genre, industry, language } = window.state.movie;

            // UI Loading State
            document.getElementById('movie-intro').classList.add('hidden');
            document.getElementById('movie-result').classList.add('hidden');
            document.getElementById('movie-loading').classList.remove('hidden');
            document.getElementById('movie-loading').style.display = 'flex';

            // NEW: Anti-repetition logic
            const history = window.state.movie.history.slice(-5).join(", "); // Remember last 5
            
            const prompt = `Suggest ONE movie or web series for a couple date night based on the following specific criteria.
            Criteria:
            1. Industry/Origin: ${industry}
            2. Language: ${language}
            3. Genre/Mood: ${genre}
            Constraint: Do NOT suggest these titles: [${history}].
            Constraint: Pick something unique, highly rated, or spicy if requested.
            Return ONLY a valid JSON object. Do not include markdown formatting like \`\`\`json.
            Structure:
            {
                "title": "Movie Title",
                "year": "Year",
                "genre": "Short Genre (e.g., Romance/Thriller)",
                "plot": "A 2-sentence captivating tease of the plot. No spoilers.",
                "why": "One spicy or romantic reason why a couple should watch this together tonight."
            }`;

            try {
                const apiKey = window.state.geminiKey;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                let data, text;
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    data = await response.json();

                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        text = data.candidates[0].content.parts[0].text;
                        break; // Success
                    } else if (data.error && data.error.message.includes("API key not valid")) {
                        window.showFeedback("Error: Invalid API Key. Please re-enter your key.", true);
                        localStorage.removeItem('geminiApiKey');
                        window.state.geminiKey = null;
                        document.getElementById('ai-loading').style.display = 'none';
                        window.openAPIKeyModal();
                        return;
                    }
                }

                if (text) {
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const movieData = JSON.parse(text);
                    
                    document.getElementById('res-title').textContent = movieData.title;
                    document.getElementById('res-year').textContent = movieData.year;
                    document.getElementById('res-genre').textContent = movieData.genre;
                    document.getElementById('res-desc').textContent = movieData.plot;
                    document.getElementById('res-why').textContent = movieData.why;

                    // Add to history
                    window.state.movie.history.push(movieData.title);

                    document.getElementById('movie-loading').style.display = 'none';
                    document.getElementById('movie-result').classList.remove('hidden');
                    
                    // Clear pending action on success
                    window.state.pendingAction = null;
                } else {
                    throw new Error(data.error?.message || "No data returned");
                }

            } catch (e) {
                console.error("AI Error:", e);
                window.showFeedback(`AI Error: ${e.message}. Please check your Key.`, true);
                document.getElementById('movie-loading').style.display = 'none';
                document.getElementById('movie-intro').classList.remove('hidden');
            }
        };
        
        // --- API KEY LOGIC (UPDATED FOR PENDING ACTION) ---
        
        // Function to open the API Key input modal
        window.openAPIKeyModal = () => {
            document.getElementById('api-input').value = window.state.geminiKey || '';
            document.getElementById('api-key-modal').classList.add('active');
        };
        
        // Function to save the API key (UPDATED LOGIC)
        window.saveAPIKey = () => {
            const key = document.getElementById('api-input').value.trim();
            if (key.length < 30) {
                window.showFeedback("Please enter a valid Gemini API Key.", true);
                return;
            }
            window.state.geminiKey = key;
            localStorage.setItem('geminiApiKey', key);
            document.getElementById('api-key-modal').classList.remove('active');
            window.showFeedback("API Key saved! Processing your request...");
            
            // Execute pending action (Movie or Story)
            if (window.state.pendingAction && typeof window.state.pendingAction === 'function') {
                const action = window.state.pendingAction;
                window.state.pendingAction = null; // Clear it before execution
                action();
            }
        };

        window.initStory = () => {
             if (!window.checkLicensingStatus()) return;
            const list = document.getElementById('roles-list'); list.innerHTML = '';
            rolesData.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-3 rounded-lg border border-white/10 hover:bg-white/10 transition-colors text-sm font-semibold flex justify-between group';
                btn.innerHTML = `<span>${r}</span><i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100"></i>`;
                btn.onclick = () => { window.state.story.role = r; window.storyNav(2); };
                list.appendChild(btn);
            });
            if(window.lucide) lucide.createIcons(); 
            window.storyNav(1);
        };
        window.storyNav = (step) => {
            ['1','2','3'].forEach(s => document.getElementById(`story-step-${s}`).classList.add('hidden'));
            document.getElementById(`story-step-${step}`).classList.remove('hidden');
            if(step === 2 && !window.state.story.actor) window.setStoryActor('Him');
        };
        window.setStoryActor = (a) => {
            window.state.story.actor = a;
            document.querySelectorAll('.story-actor-btn').forEach(b => b.classList.remove('bg-white/20', 'border-white'));
            const idx = a === 'Him' ? 0 : 1; document.querySelectorAll('.story-actor-btn')[idx].classList.add('bg-white/20', 'border-white');
        };

        // This function now checks for the API key first.
        window.generateAIStory = async () => {
             if (!window.checkLicensingStatus()) {
                window.showFeedback("App Locked! Please enter your Passkey to use AI features.", true);
                return;
            }
            // Set pending action
            window.state.pendingAction = window.generateAIStory;

            if (!window.state.geminiKey) {
                window.openAPIKeyModal();
                return;
            }
            
            // Proceed to the loading screen
            window.showScreen('story'); window.storyNav(3); 
            document.getElementById('ai-loading').style.display = 'flex'; document.getElementById('story-content').innerHTML = ''; 
            const role = window.state.story.role;
            document.getElementById('story-role-title').textContent = role;
            const actor = window.state.story.actor; const target = actor === 'Him' ? 'Her' : 'Him';
            const diff = window.state.story.diff;
            const diffText = diff === 1 ? "Playful/Easy" : (diff === 2 ? "Hesitant/Hard" : "Forbidden/Extreme");
            
            const prompt = `Write an extended, intense, seductive, dialogue-focused roleplay story in Hinglish.
            
            Goal:
            ‚Ä¢ Story must start slowly, with a smooth buildup.
            ‚Ä¢ Increase length through layered dialogues, reactions, pauses.
            ‚Ä¢ No romance ‚Äî only mutual physical tension and attraction.
            ‚Ä¢ Full consent maintained throughout.
            ‚Ä¢ Slow-burn progression: hesitation ‚Üí tension ‚Üí persuasion ‚Üí agreement.
            ‚Ä¢ Do NOT rush to acceptance; let the dialogue create a gradual shift.
            ‚Ä¢ No explicit or graphic physical details ‚Äî only implied sensuality.
            ‚Ä¢ 80‚Äì90% of the story should be dialogue and close-up tension.

            Dynamic Variables:
            Role: ${role}
            Initiator: ${actor} (${actor === 'Him' ? 'Male' : 'Female'})
            Target: ${target} (${target === 'Him' ? 'Male' : 'Female'})
            Resistance Level: ${diffText}

            Structure:
            1. Slow Start ‚Äî The Visit  
            2. Gradual Pull-In ‚Äî Invitation Inside  
            3. Extended Push‚ÄìPull  
            4. The Shift ‚Äî Mutual Realization  
            5. After Acceptance ‚Äî Extended Tension  
            
            Length: 250‚Äì300+ words  
            Tone: Slow, bold, seductive, highly dialogue-heavy, tension-driven.  
            Output: Only <p> HTML paragraphs, no headings.`;

            // Using the user-provided key
            const apiKey = window.state.geminiKey; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            // Implement simple retry logic with exponential backoff (max 3 retries)
            let response, data, text;
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    data = await response.json();

                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        text = data.candidates[0].content.parts[0].text;
                        break; // Success
                    } else if (data.error && data.error.message.includes("API key not valid")) {
                        window.showFeedback("Error: Invalid API Key. Please re-enter your key.", true);
                        localStorage.removeItem('geminiApiKey');
                        window.state.geminiKey = null;
                        document.getElementById('ai-loading').style.display = 'none';
                        window.openAPIKeyModal();
                        return;
                    }
                } catch (e) {
                    console.error(`Attempt ${i+1} failed:`, e);
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }
            
            if (text) {
                text = text.replace(/```html/g, '').replace(/```/g, '').trim();
                window.state.currentAIStory = text;
                document.getElementById('story-content').innerHTML = text;
                window.state.pendingAction = null;
            } else {
                 document.getElementById('story-content').innerHTML = `<p class='text-red-400'>Error: Failed to generate story. Please check your API key or try again later.</p>`;
            }
            document.getElementById('ai-loading').style.display = 'none';
        };

        // Replaced: No longer saves to Firebase, gives user feedback instead.
        window.saveCurrentStory = async () => { 
            if(!window.state.currentAIStory) return; 
            window.showFeedback("Feature Disabled: Please use the Copy Text button to save your story manually.", true);
        };
        
        window.copyStory = () => {
            const text = document.getElementById('story-content').innerText; const textarea = document.createElement('textarea'); textarea.value = text; textarea.style.position = 'fixed'; textarea.style.opacity = '0'; document.body.appendChild(textarea); textarea.select(); 
            try { document.execCommand('copy'); window.showFeedback("Copied!"); } catch (err) { window.showFeedback("Copy failed.", true); }
            document.body.removeChild(textarea);
        };
        
        // --- FIXED TOD LOGIC WITH SYNC ---
        window.initTOD = () => { 
             if (!window.checkLicensingStatus()) return;
            if (!window.state.isMultiplayer || window.state.isHost) {
                window.state.todTurn = Math.random() < 0.5 ? 'Him' : 'Her'; 
            }
            window.todResetUI(); 
            if (window.state.isMultiplayer && window.state.isHost) {
                 sendStateUpdate('SYNC_FULL_STATE', { 
                    monopoly: window.state.monopoly, 
                    vault: savedVault, 
                    couponStatus: couponStatus,
                    todTurn: window.state.todTurn,
                    nhie: window.state.nhie,
                    memory: window.state.memory 
                });
            }
        };

        window.todResetUI = () => {
            document.getElementById('tod-turn').textContent = `${window.state.names[window.state.todTurn]}'s Turn`;
            document.getElementById('tod-choice-btns').classList.remove('hidden'); 
            document.getElementById('tod-result').classList.add('hidden'); 
            document.getElementById('tod-result').classList.remove('flex');
            
            const isMyTurn = window.state.todTurn === window.state.myRole;
            document.querySelectorAll('#tod-choice-btns button').forEach(btn => {
                btn.disabled = window.state.isMultiplayer && !isMyTurn;
                if (btn.disabled) { btn.classList.add('opacity-50', 'cursor-not-allowed'); }
                else { btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
            });
        };

        window.todAction = (type) => {
            if (window.state.isMultiplayer && window.state.todTurn !== window.state.myRole) {
                window.showFeedback(`Wait! It is ${window.state.names[window.state.todTurn]}'s turn!`, true);
                return;
            }

            const pool = type === 'Truth' ? todData.truths : todData.dares;
            const item = pool[Math.floor(Math.random() * pool.length)];
            
            document.getElementById('tod-choice-btns').classList.add('hidden');
            const res = document.getElementById('tod-result'); 
            res.classList.remove('hidden'); 
            res.classList.add('flex');
            
            document.getElementById('tod-type-badge').textContent = type; 
            document.getElementById('tod-text').textContent = item.text;
            
            const nextBtn = document.querySelector('#tod-result button');
            nextBtn.disabled = false; 
            nextBtn.onclick = () => window.todNextTurn();

            sendStateUpdate('TOD_ACTION', { type: type, text: item.text });
        };

        window.todNextTurn = () => {
            const nextTurn = window.state.todTurn === 'Him' ? 'Her' : 'Him';
            window.state.todTurn = nextTurn;
            
            window.todResetUI();
            
            sendStateUpdate('TOD_NEXT', { turn: nextTurn });
        };
        // --- END FIXED TOD LOGIC ---

        // --- CARDS LOGIC (Unchanged) ---
        window.initCards = () => { 
             if (!window.checkLicensingStatus()) return;
            document.getElementById('active-card').classList.remove('visible', 'flipped'); document.getElementById('card-placeholder').style.display = 'block'; document.getElementById('mystery-dice-box').classList.remove('mystery-dice-rolling'); document.getElementById('dice-val').textContent = '?'; 
        };
        window.rollDice = () => {
            sendStateUpdate('CARD_ROLL_START');
            const diceBox = document.getElementById('mystery-dice-box'); diceBox.classList.add('mystery-dice-rolling');
            document.getElementById('active-card').classList.remove('visible', 'flipped'); document.getElementById('card-placeholder').style.display = 'block'; document.getElementById('card-placeholder').textContent = "Rolling...";
            
            setTimeout(() => { 
                diceBox.classList.remove('mystery-dice-rolling'); 
                const rollVal = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-val').textContent = rollVal; 
                const cardIndex = Math.floor(Math.random() * positions.length);
                
                sendStateUpdate('CARD_REVEAL', { roll: rollVal, index: cardIndex });
                window.revealCard(cardIndex); 
            }, 800);
        };
        window.revealCard = (index = null) => {
            const pos = (index !== null) ? positions[index] : positions[Math.floor(Math.random() * positions.length)];
            
            document.getElementById('card-icon').setAttribute('data-lucide', pos.icon); document.getElementById('card-title').textContent = pos.title; document.getElementById('card-tease').textContent = pos.tease;
            document.getElementById('card-method').innerHTML = pos.method.replace("SHE:", `<span class='text-rose-300 font-bold'>SHE:</span>`).replace("HE:", `<span class='text-blue-300 font-bold'>HE:</span>`);
            if(window.lucide) lucide.createIcons();
            document.getElementById('card-placeholder').style.display = 'none';
            const card = document.getElementById('active-card'); card.classList.add('visible'); setTimeout(() => card.classList.add('flipped'), 300);
        };

       // --- NEVER HAVE I EVER (NHIE) LOGIC (MERGED) ---
        window.initNHIE = () => {
             if (!window.checkLicensingStatus()) return;
            document.getElementById('nhie-game-area').classList.remove('hidden');
            document.getElementById('nhie-punishment-area').classList.add('hidden');

            document.getElementById('nhie-him-label').textContent = `${window.state.names.Him} Fingers`;
            document.getElementById('nhie-her-label').textContent = `${window.state.names.Her} Fingers`;
            
            if (!window.state.isMultiplayer || window.state.isHost) {
                window.state.nhie.statements = [...nhieStatements].sort(() => Math.random() - 0.5);
                window.state.nhie.currentQ = 0;
                window.state.nhie.himScore = 5;
                window.state.nhie.herScore = 5;
                window.state.nhie.turn = Math.random() < 0.5 ? 'Him' : 'Her';
                
                if (window.state.isHost) {
                    sendStateUpdate('NHIE_INIT', { 
                        statements: window.state.nhie.statements,
                        turn: window.state.nhie.turn
                    });
                }
            }
            
            window.updateNHIEUI();
        };

        window.updateNHIEUI = () => {
            const currentQ = window.state.nhie.statements[window.state.nhie.currentQ];
            const isHimTurn = window.state.nhie.turn === 'Him';

            document.getElementById('nhie-q-num').textContent = window.state.nhie.currentQ + 1;
            document.getElementById('nhie-current-question').textContent = currentQ || "Game Over!";
            document.getElementById('nhie-turn-prompt').textContent = `${window.state.names[window.state.nhie.turn]} will read the statement.`;
            
            document.getElementById('nhie-him-score').textContent = window.state.nhie.himScore;
            document.getElementById('nhie-her-score').textContent = window.state.nhie.herScore;

            const btnHim = document.getElementById('btn-him-down');
            const btnHer = document.getElementById('btn-her-down');
            const btnNext = document.getElementById('btn-nhie-next');
            
            btnHim.textContent = `${window.state.names.Him} Did It`;
            btnHer.textContent = `${window.state.names.Her} Did It`;

            const isMyRoleHim = window.state.myRole === 'Him';
            const isMyRoleHer = window.state.myRole === 'Her';
            const isMyTurn = window.state.isMultiplayer && (window.state.nhie.turn === window.state.myRole);
            
            btnHim.disabled = (window.state.isMultiplayer && !isMyRoleHim);
            btnHer.disabled = (window.state.isMultiplayer && !isMyRoleHer);
            
            btnNext.disabled = (window.state.isMultiplayer && !isMyTurn);
            
            if (!window.state.isMultiplayer) {
                 btnHim.disabled = false;
                 btnHer.disabled = false;
                 btnNext.disabled = false;
            }

            if (window.state.nhie.himScore <= 0 || window.state.nhie.herScore <= 0) {
                 window.NHIEEndGame();
                 btnNext.classList.add('hidden');
            } else {
                 btnNext.classList.remove('hidden');
            }
        };

        window.NHIEFingerDown = (player) => {
            if (window.state.isMultiplayer && window.state.myRole !== player) {
                 window.showFeedback(`Only ${window.state.names[player]} can confess!`, true);
                 return;
            }
            
            const scoreKey = player === 'Him' ? 'himScore' : 'herScore';
            if (window.state.nhie[scoreKey] > 0) {
                window.state.nhie[scoreKey] -= 1;
                window.updateNHIEUI();
                window.showFeedback(`${window.state.names[player]} lost a finger! Remaining: ${window.state.nhie[scoreKey]}`);
                sendStateUpdate('NHIE_FINGER_DOWN', { player: player });
            }
        };

        window.nextNHIEQuestion = () => {
            if (window.state.isMultiplayer && window.state.nhie.turn !== window.state.myRole) {
                window.showFeedback(`Wait, it's ${window.state.names[window.state.nhie.turn]}'s turn to click Next!`, true);
                return;
            }

            if (window.state.nhie.himScore <= 0 || window.state.nhie.herScore <= 0) {
                window.NHIEEndGame();
                return;
            }
            
            window.state.nhie.currentQ++;
            window.state.nhie.turn = window.state.nhie.turn === 'Him' ? 'Her' : 'Him';

            if (window.state.nhie.currentQ >= nhieStatements.length) {
                window.NHIEEndGame(true); 
                return;
            }

            window.updateNHIEUI();
            sendStateUpdate('NHIE_QUESTION', { currentQ: window.state.nhie.currentQ, turn: window.state.nhie.turn });
        };

        window.NHIEEndGame = (isDraw = false) => {
            const himScore = window.state.nhie.himScore;
            const herScore = window.state.nhie.herScore;
            
            let winner, loser;
            
            if (isDraw || (himScore > 0 && herScore > 0)) { 
                loser = (himScore < herScore) ? 'Him' : ((herScore < himScore) ? 'Her' : (Math.random() < 0.5 ? 'Him' : 'Her'));
                winner = loser === 'Him' ? 'Her' : 'Him';
                window.showFeedback(`Draw! Loser decided by fewer fingers/sudden death: ${window.state.names[loser]} is the LOSER!`);
            } else if (himScore <= 0) {
                winner = 'Her'; loser = 'Him';
            } else if (herScore <= 0) {
                winner = 'Him'; loser = 'Her';
            } else {
                loser = Math.random() < 0.5 ? 'Him' : 'Her';
                winner = loser === 'Him' ? 'Her' : 'Him';
            }
            
            const winnerName = window.state.names[winner];
            const loserName = window.state.names[loser];

            document.getElementById('nhie-game-area').classList.add('hidden');
            document.getElementById('nhie-punishment-area').classList.remove('hidden');
            
            document.getElementById('nhie-loser-name').textContent = `${loserName} is the LOSER! (Zero Fingers)`;
            document.getElementById('nhie-winner-name').textContent = `${winnerName} is the WINNER and chooses the punishment.`;

            const listEl = document.getElementById('nhie-punishment-list');
            listEl.innerHTML = '';
            
            nhiePunishments.forEach((p) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-4 rounded-xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/20 transition-all flex flex-col items-start group cursor-pointer';
                btn.innerHTML = `<div class="flex items-center gap-2 mb-1"><i data-lucide="${p.icon}" class="w-5 h-5 text-red-300"></i><span class="font-bold text-lg text-red-200">${p.title}</span></div><p class="text-xs opacity-70">${p.desc}</p>`;
                
                if (window.state.isMultiplayer && window.state.myRole !== winner) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.onclick = () => window.NHIESealPunishment(p, winnerName, loserName);
                }
                listEl.appendChild(btn);
            });
            
            if(window.lucide) lucide.createIcons();
            
            if (!window.state.isMultiplayer || window.state.myRole === winner) {
                 sendStateUpdate('NHIE_END', { winner: winnerName, loser: loserName });
            }
        };
        
        window.NHIESealPunishment = (punishment, winnerName, loserName) => {
             const deal = {
                id: Date.now(),
                title: punishment.title,
                desc: `Punishment for LOSER (${loserName}): ${punishment.desc}`,
                winner: winnerName,
                loser: loserName,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: "NHIE Game Contract"
            };
            
            savedVault.unshift(deal);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            window.showFeedback(`Contract Sealed for ${loserName}! Winner (${winnerName}) gets the prize!`);
            
            sendStateUpdate('UPDATE_VAULT', { vault: savedVault, couponStatus: couponStatus });
            
            setTimeout(() => { window.showVault(); }, 1500);
        };
        // --- END NHIE LOGIC ---


        // --- NEW MEMORY GAME LOGIC (MERGED) ---
        window.initMemory = () => {
             if (!window.checkLicensingStatus()) return;
            let cards = [];
            memoryRewards.forEach((reward, index) => {
                cards.push({ id: index * 2, rewardIndex: index, isFlipped: false, isMatched: false, icon: reward.icon });
                cards.push({ id: index * 2 + 1, rewardIndex: index, isFlipped: false, isMatched: false, icon: reward.icon });
            });
            
            cards = cards.sort(() => Math.random() - 0.5);

            if (!window.state.isMultiplayer || window.state.isHost) {
                window.state.memory = {
                    cards: cards,
                    flipped: [], 
                    matched: [], 
                    turn: Math.random() < 0.5 ? 'Him' : 'Her',
                    score: { Him: 0, Her: 0 },
                    isLocked: false,
                    tempMatch: 0 
                };
                
                if (window.state.isHost) {
                    sendStateUpdate('MEMORY_INIT', { 
                        cards: window.state.memory.cards,
                        turn: window.state.memory.turn
                    });
                }
            }
            
            window.updateMemoryUI();
            window.renderMemoryBoard();
            document.getElementById('memory-action-log').textContent = `Game Ready! ${window.state.names[window.state.memory.turn]}'s turn to flip.`;
        };

        window.renderMemoryBoard = () => {
            const board = document.getElementById('memory-board');
            board.innerHTML = '';
            
            const currentTurn = window.state.memory.turn;
            const isMyTurn = !window.state.isMultiplayer || currentTurn === window.state.myRole;
            const boardLockClass = (window.state.memory.isLocked || (window.state.isMultiplayer && !isMyTurn)) ? 'pointer-events-none opacity-80' : '';
            board.className = `memory-board ${boardLockClass}`;
            
            window.state.memory.cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `memory-card rounded-xl shadow-xl transition-all duration-300 relative transform-gpu ${card.isMatched ? 'matched' : ''} ${card.isFlipped ? 'flipped' : ''} cursor-pointer`;
                cardEl.id = `mem-card-${index}`;

                if (!card.isMatched) {
                    cardEl.onclick = () => window.handleCardClick(index);
                } else {
                    cardEl.onclick = null;
                    cardEl.classList.add('cursor-default');
                }

                const front = `<div class="card-face card-front bg-fuchsia-600/30 border border-fuchsia-400/50 flex items-center justify-center"><i data-lucide="gem" class="w-8 h-8 text-fuchsia-200"></i></div>`;
                const back = `<div class="card-face card-back bg-white/10 border border-white/20 flex items-center justify-center"><i data-lucide="${card.icon}" class="w-8 h-8 text-fuchsia-400"></i></div>`;

                cardEl.innerHTML = `<div class="card-inner">${front}${back}</div>`;
                board.appendChild(cardEl);
            });

            if (window.lucide) lucide.createIcons();
        };

        window.updateMemoryUI = () => {
            const himName = window.state.names.Him;
            const herName = window.state.names.Her;

            document.getElementById('memory-turn-text').textContent = `Turn: ${window.state.names[window.state.memory.turn]}`;
            document.getElementById('memory-him-score').textContent = window.state.memory.score.Him;
            document.getElementById('memory-her-score').textContent = window.state.memory.score.Her;
            document.getElementById('memory-him-name').textContent = `${himName} Matches`;
            document.getElementById('memory-her-name').textContent = `${herName} Matches`;
            
            if (window.state.memory.matched.length === window.state.memory.cards.length && window.state.memory.cards.length > 0) {
                window.endMemoryGame();
            }
        };

        window.handleCardClick = (index) => {
            const currentTurn = window.state.memory.turn;
            
            if (window.state.memory.isLocked || window.state.memory.cards[index].isFlipped || window.state.memory.cards[index].isMatched) return;
            if (window.state.isMultiplayer && currentTurn !== window.state.myRole) {
                window.showFeedback(`Wait for your turn, ${window.state.names[window.state.myRole]}!`, true);
                return;
            }
            if (window.state.memory.flipped.length >= 2) return;
            
            window.state.memory.cards[index].isFlipped = true;
            window.state.memory.flipped.push(index);
            window.renderMemoryBoard(); 

            sendStateUpdate('MEMORY_FLIP', { index: index });
            document.getElementById('memory-action-log').textContent = `Card flipped: ${window.state.memory.flipped.length} of 2.`;

            if (window.state.memory.flipped.length === 2) {
                window.state.memory.isLocked = true; 
                setTimeout(window.checkForMatch, 1000);
            }
        };

        window.checkForMatch = () => {
            const [idx1, idx2] = window.state.memory.flipped;
            const card1 = window.state.memory.cards[idx1];
            const card2 = window.state.memory.cards[idx2];
            const currentTurn = window.state.memory.turn;
            const msgEl = document.getElementById('memory-action-log');
            
            if (card1.rewardIndex === card2.rewardIndex) {
                card1.isMatched = true;
                card2.isMatched = true;
                window.state.memory.score[currentTurn]++;
                window.state.memory.matched.push(idx1, idx2);
                window.state.memory.flipped = []; 
                window.state.memory.tempMatch++;
                window.state.memory.isLocked = false; 

                const rewardData = memoryRewards[card1.rewardIndex];
                const rewardText = rewardData[currentTurn.toLowerCase()].reward;
                
                const message = `üéâ Match Found! ${window.state.names[currentTurn]}'s Reward: ${rewardText}`;
                
                msgEl.innerHTML = `<p class="font-bold text-lg text-green-300">MATCH! ${rewardData.title}</p><p class="mt-1">${message}</p>`;

                if (window.state.memory.matched.length === window.state.memory.cards.length) {
                    window.endMemoryGame(); 
                    return;
                }
                
                window.renderMemoryBoard();
                window.updateMemoryUI();

                sendStateUpdate('MEMORY_MATCH', { 
                    idx1: idx1, 
                    idx2: idx2, 
                    score: window.state.memory.score,
                    message: message,
                    tempMatch: window.state.memory.tempMatch
                });

            } else {
                msgEl.textContent = `No Match! Checking for shuffle rule...`;

                setTimeout(() => {
                    const currentTurn = window.state.memory.turn;
                    const nextTurn = currentTurn === 'Him' ? 'Her' : 'Him';
                    
                    window.state.memory.cards.forEach(c => { 
                         if (!c.isMatched) c.isFlipped = false; 
                    });
                    
                    if (window.state.memory.tempMatch >= 1) { 
                        window.state.memory.tempMatch = 0; 
                        window.shuffeCardsAndContinue(nextTurn); 
                    } else {
                        window.state.memory.turn = nextTurn;
                        window.state.memory.flipped = [];
                        window.state.memory.isLocked = false;
                        window.renderMemoryBoard();
                        window.updateMemoryUI();
                        msgEl.textContent = `No Match! Turn change. It's now ${window.state.names[nextTurn]}'s turn.`;
                        sendStateUpdate('MEMORY_NO_MATCH_TURN', { turn: window.state.memory.turn });
                    }
                }, 800);
            }
        };

        window.shuffeCardsAndContinue = (nextTurn) => {
            const msgEl = document.getElementById('memory-action-log');

            let nonMatchedIndices = window.state.memory.cards
                .map((card, index) => card.isMatched ? null : index)
                .filter(index => index !== null);

            let nonMatchedCards = nonMatchedIndices.map(index => ({ 
                ...window.state.memory.cards[index], 
                isFlipped: false
            }));
            
            nonMatchedCards.sort(() => Math.random() - 0.5);

            let newCards = [...window.state.memory.cards]; 
            let shuffledIndex = 0;

            for(let i=0; i < newCards.length; i++) {
                if (!newCards[i].isMatched) {
                    newCards[i] = {
                        ...nonMatchedCards[shuffledIndex],
                        id: i,
                        isFlipped: false
                    };
                    shuffledIndex++;
                }
            }
            
            window.state.memory.cards = newCards;
            window.state.memory.turn = nextTurn;
            window.state.memory.flipped = []; 
            window.state.memory.isLocked = false; 

            window.renderMemoryBoard();
            window.updateMemoryUI();
            
            msgEl.textContent = `Chain break! Cards Shuffled! It's now ${window.state.names[nextTurn]}'s turn.`;

            sendStateUpdate('MEMORY_SHUFFLE', { 
                cards: window.state.memory.cards,
                turn: window.state.memory.turn 
            });
        };

        window.endMemoryGame = () => {
            if(window.state.memory.isLocked) return; 
            window.state.memory.isLocked = true;

            const himScore = window.state.memory.score.Him;
            const herScore = window.state.memory.score.Her;

            let winnerRole, loserRole;

            if (himScore > herScore) { winnerRole = 'Him'; loserRole = 'Her'; } 
            else if (herScore > himScore) { winnerRole = 'Her'; loserRole = 'Him'; } 
            else { 
                winnerRole = window.state.memory.turn === 'Him' ? 'Her' : 'Him';
                loserRole = winnerRole === 'Him' ? 'Her' : 'Him';
            }

            const winnerName = window.state.names[winnerRole];
            const loserName = window.state.names[loserRole];

            const contract = memoryContracts[winnerRole];

            const deal = {
                id: Date.now(),
                // FIX: Template literal was missing the closing bracket } which caused the SyntaxError
                title: `${winnerName}'s ULTIMATE CONTRACT: ${contract.title}`,
                desc: contract.desc,
                winner: winnerName,
                loser: loserName,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: "Memory Game Contract"
            };
            
            savedVault.unshift(deal);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            window.showFeedback(`üëë ${winnerName} Wins the Ultimate Contract! Sealed in Vault!`, false);
            document.getElementById('memory-action-log').textContent = `GAME OVER! ${winnerName} won the final contract! Check the Vault.`;
            
            sendStateUpdate('UPDATE_VAULT', { vault: savedVault, couponStatus: couponStatus });
            
            setTimeout(() => { window.showVault(); }, 2000);
        };
        // --- END MEMORY GAME LOGIC ---

        // Initialize App Directly
        if(window.lucide) window.lucide.createIcons(); 
        if(typeof window.applyTheme === 'function') window.applyTheme('red'); 
        if(typeof window.initMusicPlayer === 'function') window.initMusicPlayer();
        window.updateMultiplayerUI(); 

        // Initial check for license status
        document.addEventListener('DOMContentLoaded', () => {
             // Only call showScreen('setup') if licensing check passes (meaning the user is licensed)
             if (window.checkLicensingStatus()) {
                 window.showScreen('setup'); 
             }
             if(window.lucide) lucide.createIcons();
        });

       
// --- SPICE & DICE LOGIC ---

        const diceActions = [
            "Kiss", "Lick", "Bite (Gently)", "Suck", "Massage", 
            "Spank", "Tickle", "Caress", "Blow Air", "Nip", 
            "Trace with Tongue", "Scratch (Lightly)", "Rub", "Squeeze", "Tease", 
            "Pinch", "Graze with Teeth", "Wet with Ice", "Kiss Repeatedly", "Taste"
        ];

        const diceBodyParts = [
            "Lips", "Neck", "Ear Lobe", "Collarbone", "Nipples", 
            "Inner Thigh", "Navel", "Lower Back", "Butt Cheeks", "Behind Knee", 
            "Fingers", "Toes", "Wrist", "Abs", "Chest", 
            "Shoulder", "Jawline", "Spine", "Inner Arm", "Ankles",
            "Nape of Neck", "Hip Bone", "Soles of Feet", "Palm", "Underboob / Pecs",
            "Tailbone", "Chin", "Forehead", "Eyelids", "Nose Tip",
            "Hair", "Waist", "Calves", "Upper Arm", "Between Fingers",
            "Ribcage", "Groin Area", "Back of Thigh", "Throat / Adam's Apple", "Pubic Bone"
        ];

        let isSpinning = false;

        // CSS Injector for Wheel Styling
        const style = document.createElement('style');
        style.innerHTML = `
            .wheel-item {
                height: 64px; /* Matches the selection bar height */
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-size: 14px;
                color: rgba(255,255,255,0.4);
                transition: color 0.3s, font-size 0.3s;
            }
            /* Jab wheel ruke, toh beech wala highlight hoga */
            .wheel-active {
                color: #fbbf24 !important; /* Amber/Gold */
                font-size: 18px !important;
                text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            }
        `;
        document.head.appendChild(style);

        window.initSpiceDice = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('dice');
            
            // Populate Wheels (Multiple copies for smooth infinite loop illusion)
            // Hum list ko 3 baar repeat karenge taaki scroll lamba ho
            const populate = (id, arr) => {
                const el = document.getElementById(id);
                // 50 copies create karte hai taaki spin lamba chale
                let html = '';
                for(let i=0; i<50; i++) {
                    arr.forEach(item => {
                        html += `<div class="wheel-item">${item}</div>`;
                    });
                }
                el.innerHTML = html;
                // Reset position
                el.style.transition = 'none';
                el.style.transform = 'translateY(0px)';
            };

            populate('wheel-action', diceActions);
            populate('wheel-body', diceBodyParts);
            
            document.getElementById('dice-result').querySelector('p').style.opacity = '0';
            isSpinning = false;
        };

        // --- SPICE & DICE FUNCTIONS (Paste at the bottom) ---

// 1. BUTTON CLICK HANDLER
window.spinSpiceDice = () => {
    // Agar pehle se ghoom raha hai toh kuch mat karo
    if(window.isSpinning) return;
    
    // Result pehle hi calculate kar lo
    const aIndex = Math.floor(Math.random() * diceActions.length);
    const bIndex = Math.floor(Math.random() * diceBodyParts.length);

    // Partner ko bhejo: "Ye index aaya hai, tum bhi yahi dikhao"
    if (window.state.isMultiplayer) {
        sendStateUpdate('SPICE_SPIN', { 
            actionIndex: aIndex, 
            bodyIndex: bIndex 
        });
    }

    // Khud ke screen par animation chalao
    window.performSpiceSpin(aIndex, bIndex);
};

// 2. ANIMATION HANDLER (Dono taraf same chalega)
window.performSpiceSpin = (aIndex, bIndex) => {
    window.isSpinning = true;
    
    const btn = document.getElementById('btn-spin-dice');
    const resultText = document.getElementById('dice-result').querySelector('p');
    const actionWheel = document.getElementById('wheel-action');
    const bodyWheel = document.getElementById('wheel-body');

    // UI Reset
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    resultText.style.opacity = '0';

    // Calculation for exact scroll position
    const itemHeight = 64; // Item height in pixels
    // Thoda extra ghumake exact position par land karwana
    const actionScroll = -((30 * diceActions.length * itemHeight) + (aIndex * itemHeight)) + 96; 
    const bodyScroll = -((35 * diceBodyParts.length * itemHeight) + (bIndex * itemHeight)) + 96;

    // Reset Position instantly
    actionWheel.style.transition = 'none';
    bodyWheel.style.transition = 'none';
    actionWheel.style.transform = 'translateY(0px)';
    bodyWheel.style.transform = 'translateY(0px)';

    // Start Animation after tiny delay
    setTimeout(() => {
        actionWheel.style.transition = 'transform 3s cubic-bezier(0.1, 0.9, 0.2, 1)';
        bodyWheel.style.transition = 'transform 3.5s cubic-bezier(0.1, 0.9, 0.2, 1)';
        
        actionWheel.style.transform = `translateY(${actionScroll}px)`;
        bodyWheel.style.transform = `translateY(${bodyScroll}px)`;
    }, 50);

    // Show Final Result
    setTimeout(() => {
        const action = diceActions[aIndex];
        const bodyPart = diceBodyParts[bIndex];
        
        resultText.innerHTML = `<span class="text-orange-400 text-2xl uppercase">${action}</span> <span class="text-xs opacity-50">ON</span> <span class="text-pink-400 text-2xl uppercase">${bodyPart}</span>`;
        resultText.style.opacity = '1';
        
        window.isSpinning = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        
        // Vibration for impact
        if(navigator.vibrate) navigator.vibrate(50);
    }, 3500); // 3.5s animation time
};



        // --- TICKING LUST BOMB LOGIC (FIXED TIMER: 60-120 SECONDS) ---

        const bombTasks = [
            // --- ACTION DARES (FAST) ---
            "Quick! Kiss your partner's neck!",
            "Lick your lips seductively!",
            "Wink at your partner with your left eye!",
            "Spank yourself hard!",
            "Moan your partner's name loudly!",
            "Bite your lower lip!",
            "Freeze! Don't move for 5 seconds!",
            "Show your orgasm face!",
            "Shake your booty for 3 seconds!",
            "Touch your toes (give a view)!",
            "Kiss your partner's hand!",
            "Blow a kiss to your partner's crotch!",
            "Squeeze your own butt!",
            "Flash your underwear color!",
            "Rub your nipples through your shirt!",
            "Make a growling sound!",
            "Look at your partner with pure lust!",
            "Kiss your partner's earlobe!",
            "Trace your own lips with your finger!",
            "Do a sexy body roll!",
            "Lift your shirt for 1 second!",
            "Pull your pants down an inch!",
            "Slap your own thigh!",
            "Give a quick air-hump!",
            "Simulate giving oral sex (with air)!",
            "Lick your partner's nose!",
            "Bite your partner's shoulder gently!",
            "Whisper 'Fuck me' in their ear!",
            "Say 'Daddy/Mommy' in a sexy voice!",
            "Touch your partner's chest!",
            "Run your fingers through their hair!",
            "Smell your partner's neck!",
            "Kiss your partner's inner arm!",
            "Gently choke yourself for 2 seconds!",
            "Open your mouth wide like you're ready!",
            "Suck your own finger sensually!",
            "Give your partner a high-five... but miss and grab their hand!",
            "Tickle your partner's waist!",
            "Pinch your partner's nipple (lightly)!",
            "Sit on your partner's lap for 2 seconds!",
            "Grind on your partner (standing or sitting)!",
            "Kiss the tip of your partner's nose!",
            "Lick the palm of your partner's hand!",
            "Blow air on your partner's neck!",
            "Trace a line down your partner's chest!",
            "Hold eye contact without blinking for 5s!",
            "Massage your partner's shoulders quickly!",
            "Kiss your partner's forehead!",
            "Bark like a dog!",
            "Say 'You own me'!",
            "Pretend to strip (take off invisible clothes)!",
            "Jiggle your chest/boobs!",
            "Flex your muscles!",
            "Strike a pornstar pose!",
            "Make a purring sound like a cat!",
            "Bite the air!",
            "Kiss your own knee!",
            "Spank your partner once!",
            "Rub your face against their arm!",
            "Do a squat (sexy style)!",
            "Lick the air like a snake!",
            "Touch your partner's thigh!",
            "Whisper 'I'm not wearing panties/underwear' (even if lying)!",
            "Say 'Punish me'!",
            "Kiss the screen of the phone!",
            
            // --- QUICK QUESTIONS (3 THINGS) ---
            "Name 3 places you want to be kissed!",
            "Name 3 dirty words you love!",
            "Name 3 places for public sex!",
            "Name 3 foods you'd lick off me!",
            "Name 3 porn categories you watch!",
            "Name 3 parts of my body you love!",
            "Name 3 things that turn you on!",
            "Name 3 things that turn you off!",
            "Name 3 places you've masturbated!",
            "Name 3 toys you want to try!",
            "Name 3 positions you love!",
            "Name 3 positions you hate!",
            "Name 3 celebrities you'd sleep with!",
            "Name 3 colors of underwear I own!",
            "Name 3 reasons why I am sexy!",
            "Name 3 weird fetishes!",
            "Name 3 places you want me to touch you!",
            "Name 3 noises you make in bed!",
            "Name 3 roleplay scenarios!",
            "Name 3 naughty things we did last month!",
            "Name 3 things you'd do if we were naked right now!",
            "Name 3 drinks to use in bed!",
            "Name 3 items of clothing you want me to remove!",
            "Name 3 places you want to leave a hickey!",
            "Name 3 fruits that remind you of sex!",
            
            // --- THIS OR THAT (CHOOSE 1) ---
            "Spit or Swallow?",
            "Lights On or Lights Off?",
            "Rough or Gentle?",
            "Loud or Silent?",
            "Morning Sex or Night Sex?",
            "Top or Bottom?",
            "Doggy or Missionary?",
            "69 or Oral?",
            "Shower Sex or Car Sex?",
            "Blindfold or Handcuffs?",
            "Hair Pulling or Choking?",
            "Lube or Spit?",
            "Quickie or Marathon?",
            "Boobs or Butt?",
            "Dick or Balls?",
            "Shaven or Hairy?",
            "Lingerie or Naked?",
            "Mirror or Video?",
            "Music or Silence?",
            "Talk dirty or Moan?",
            "Biting or Licking?",
            "Scratching or Massaging?",
            "Cream Pie or Facial?",
            "Inside or Outside?",
            "Bed or Sofa?",
            "Kitchen counter or Floor?",
            "Whiskey or Wine?",
            "Shower or Bath?",
            "Dominant or Submissive?",
            "Giving or Receiving?",
            "Toys or Hands?",
            "Edging or Quick Finish?",
            "Eyes Open or Closed?",
            "Socks On or Off?",
            "Condom or Raw?",
            "Threesome or Duo?",
            "Anal or Vaginal?",
            "Deep Throat or Teasing?",
            "Spank or Caress?",
            "Roleplay or Real?",
            
            // --- TRUTH / CONFESSIONS ---
            "When did you last masturbate?",
            "What color is your underwear right now?",
            "Have you ever faked an orgasm?",
            "Do you want to have sex right now?",
            "What is your dirtiest fantasy?",
            "Have you ever sent a nude?",
            "Have you ever made a sex tape?",
            "Do you like being watched?",
            "Have you ever done it in a car?",
            "Have you ever done it outside?",
            "Do you own a sex toy?",
            "Do you watch porn together?",
            "Have you ever caught someone having sex?",
            "Have you ever been caught having sex?",
            "Do you like dirty talk?",
            "What's your favorite time of day to do it?",
            "Do you sleep naked?",
            "Have you ever had a wet dream about me?",
            "Do you prefer giving or receiving oral?",
            "Do you like anal play?",
            "Have you ever tried bondage?",
            "What's the weirdest place you've done it?",
            "Do you like hickeys?",
            "Do you like biting?",
            "Do you like hair pulling?",
            "Have you ever fantasized about a friend?",
            "Have you ever had phone sex?",
            "Have you ever sexted at work?",
            "Do you like period sex?",
            "Have you ever used food in bed?",
            "Do you like being tied up?",
            "Have you ever been to a strip club?",
            "Do you like lap dances?",
            "Have you ever gone commando in public?",
            "Do you like public displays of affection?",
            "Have you ever kissed a stranger?",
            "Do you like aggressive sex?",
            "Have you ever cried during sex?",
            "Do you like shower sex?",
            "Have you ever broken a bed?",
            "Do you make noise when you cum?",
            "Do you like swallowing?",
            "Have you ever tasted your own cum/fluids?",
            "Do you like fingering?",
            "Do you like handjobs?",
            "Have you ever used ice in bed?",
            "Have you ever used wax in bed?",
            "Do you like feet?",
            "Have you ever had a one-night stand?",
            "Do you regret your first time?",
            
            // --- SPICY COMMANDS ---
            "Admit who is the better kisser!",
            "Rate your partner's oral skills (1-10)!",
            "Describe your partner's genitals in one word!",
            "Say the last dirty thing you thought about!",
            "Confess a place you want to try!",
            "Tell your partner one thing to do to you later!",
            "Guess your partner's favorite position!",
            "Say 'I love your body'!",
            "Compliment your partner's butt!",
            "Compliment your partner's chest!",
            "Dare your partner to take off one item!",
            "Ask your partner to spank you!",
            "Beg for a kiss!",
            "Ask for permission to speak!",
            "Tell your partner they are the boss!",
            "Promise a massage later!",
            "Promise oral sex later!",
            "Admit if you are horny right now!",
            "Check if your partner is hard/wet!",
            "Ask your partner 'What are you wearing'!",
            "Tell your partner to shut up and kiss you!",
            "Say 'Make me yours'!",
            "Ask 'Do you want to see me naked?'!",
            "Say 'Touch me there'!",
            "Describe the feeling of orgasm!",
            "Moan like you just finished!",
            "Pretend to be a cat in heat!",
            "Act like you are handcuffed!",
            "Pretend you are a virgin!",
            "Act like a strict teacher!",
            "Act like a bad student!",
            "Pretend you are drunk and horny!",
            "Act like you are in a porno!",
            "Make a face like you smelled something sexy!",
            "Look at your partner's lips and bite yours!",
            "Stare at your partner's crotch!",
            "Point to where you want to be touched!",
            "Use your tongue to signal what you want!",
            "Wiggle your eyebrows suggestively!",
            "Blow on your finger!",
            "Put your finger in your mouth and pop it out!",
            "Make a kissing sound 5 times!",
            "Say 'Boing'!",
            "Say 'Sploosh'!",
            "Say 'Harder'!",
            "Say 'Deeper'!",
            "Say 'Faster'!",
            "Say 'Stop teasing me'!",
            "Say 'I need you inside me/I need inside you'!"
        ];

        const bombPunishments = [
            "REMOVE ONE ITEM OF CLOTHING! (No socks)",
            "30 Seconds of vigorous ORAL (Receiver's choice)!",
            "Let your partner SPANK you 10 times (Hard)!",
            "Perform a 1-minute STRIPTEASE (No music)!",
            "Blindfold on! 5 minutes of teasing (No touching back)!",
            "Winner sends a dirty text to you; you must post it on your story for 1 min!",
            "Give a 5-minute deep throat / oral worship session!",
            "Let your partner BITE your inner thigh (Mark required)!",
            "Total Submission: You must obey 3 commands instantly!",
            "Face-Sitting Time! Serve the throne for 2 minutes!"
        ];

        let bombTimer = null;
        let bombAnimation = null;
        let timeLeft = 0;

        // --- LUST BOMB FUNCTIONS (Paste at the bottom) ---

// 1. GAME START
window.startBombGame = (isRemote = false, remoteDuration = 0) => {
    // UI Reset
    const btnStart = document.getElementById('btn-start-bomb');
    const btnPass = document.getElementById('btn-pass-bomb');
    const icon = document.getElementById('bomb-icon');
    const glow = document.getElementById('bomb-glow');
    
    btnStart.classList.add('hidden');
    btnPass.classList.remove('hidden');
    
    // Visuals active karo
    glow.style.opacity = '1';
    icon.classList.remove('text-white');
    icon.classList.add('text-red-500');
    
    // DURATION SYNC
    let duration = remoteDuration;
    if (!isRemote) {
        // Agar maine start kiya, toh time main decide karunga
        duration = Math.floor(Math.random() * (60 - 30 + 1)) + 30; // 30-60 seconds
        
        // Partner ko bhejo
        if (window.state.isMultiplayer) {
            sendStateUpdate('BOMB_ACTION', { action: 'START', value: duration });
        }
    }
    
    // Timer Logic
    timeLeft = duration * 10;
    
    // Pehla Task dikhao
    document.getElementById('bomb-task-text').textContent = bombTasks[Math.floor(Math.random() * bombTasks.length)];

    // Purana timer clear karo taaki double speed na ho
    if(window.bombTimer) clearInterval(window.bombTimer);

    // Timer Start
    window.bombTimer = setInterval(() => {
        timeLeft--;
        
        // Shake Effect (Bomb fatne wala ho toh)
        if (timeLeft < 100) { // Last 10 seconds
             const shake = Math.random() * 5 - 2.5;
             icon.style.transform = `translate(${shake}px, ${shake}px)`;
        }

        // --- EXPLOSION LOGIC ---
        if (timeLeft <= 0) {
            // Local timer khatam hua, toh explode call karo
            window.explodeBomb(); 
        }
    }, 100);
};

// 2. PASS THE BOMB
window.passTheBomb = (isRemote = false, nextTask = null) => {
    // Agar timer khatam ho chuka hai toh pass mat karo
    if (timeLeft <= 0) return;
    
    let taskToDisplay = nextTask;
    
    // Agar maine button dabaya (Remote nahi hai)
    if (!isRemote) {
        taskToDisplay = bombTasks[Math.floor(Math.random() * bombTasks.length)];
        
        // Partner ko naya task bhejo
        if (window.state.isMultiplayer) {
            sendStateUpdate('BOMB_ACTION', { action: 'PASS', value: taskToDisplay });
        }
        // Feedback
        window.showFeedback("Passed! Hurry up!");
    }
    
    // Animation & Update
    const taskText = document.getElementById('bomb-task-text');
    taskText.style.opacity = '0';
    setTimeout(() => {
        taskText.textContent = taskToDisplay;
        taskText.style.opacity = '1';
    }, 100);
};

// 3. EXPLODE (BOOM)
window.explodeBomb = (isRemote = false, remotePunishment = null) => {
    // Timer Roko
    if(window.bombTimer) clearInterval(window.bombTimer);
    
    let finalPunishment = remotePunishment;

    // Agar Local Timer ne trigger kiya hai
    if (!isRemote) {
        finalPunishment = bombPunishments[Math.floor(Math.random() * bombPunishments.length)];
        
        // Partner ko bhejo: "Ye punishment dikhao aur game roko"
        if (window.state.isMultiplayer) {
            sendStateUpdate('BOMB_ACTION', { action: 'EXPLODE', value: finalPunishment });
        }
    }
    
    // Punishment UI Show
    document.getElementById('bomb-punishment-text').textContent = finalPunishment;
    
    const explosion = document.getElementById('bomb-explosion');
    explosion.classList.remove('hidden');
    explosion.classList.add('flex', 'animate-pulse');
    
    if (navigator.vibrate) navigator.vibrate([1000]);
};


        window.resetBombGame = () => {
            document.getElementById('bomb-explosion').classList.add('hidden');
            document.getElementById('bomb-explosion').classList.remove('flex');
            
            document.getElementById('btn-start-bomb').classList.remove('hidden');
            document.getElementById('btn-pass-bomb').classList.add('hidden');
            
            document.getElementById('bomb-task-text').textContent = "Press START to ignite...";
            
            const icon = document.getElementById('bomb-icon');
            icon.style.transform = 'none';
            icon.classList.remove('text-white');
            icon.classList.add('text-red-500');
            document.getElementById('bomb-glow').style.opacity = '0';
        };
// --- SENSORY BLINDFOLD LOGIC (FINAL FIXED VERSION) ---

        const blindfoldTools = [
            // TEMPERATURE
            "Ice Cube ‚ùÑÔ∏è (Run slowly)", "Warm Mug/Spoon ‚òï (Test heat first!)", "Cold Water Drops üíß", "Hot Breath üå¨Ô∏è (No touch)", "A Cold Coin ü™ô",
            // TEXTURE
            "Silk Scarf üß£", "Rough Beard/Stubble üßî", "Hair Tips üíá", "Leather Belt üëñ", "Velvet Fabric üõå", "Feather ü™∂",
            // SENSATION
            "Phone Vibration üì≥", "Fingertips üñêÔ∏è (Light)", "Palm Rub ‚úã (Hard)", "Slap üëã (Playful)", "Pinch ü§è", "Sucking üíã (Hickey)", "Biting üßõ", "Whispering üó£Ô∏è", "Nose Rub üëÉ", "Knuckles üëä",
            // PROPS
            "Whipped Cream üç´", "Paintbrush üé®", "Comb Teeth üíà", "Piece of Fruit üçì", "Perfume Spray üí®"
        ];

        const blindfoldSpots = [
            "Nape of Neck", "Behind Ear", "Earlobe", "Throat Hollow", "Collarbone", "Chest Center", "Nipples", "Underarm", "Shoulder Blade", "Spine",
            "Eyelids", "Nose Tip", "Upper Lip", "Jawline", "Temple", "Forehead",
            "Navel", "Lower Stomach", "Hip Bone", "Lower Back", "Ribcage", "Inner Thigh", "Back of Knee", "Inner Elbow", "Inner Wrist", "Palm", "Sole of Foot", "Ankle"
        ];

        const blindfoldPunishments = [
            "Blindfold stays ON for 10 more mins (Silent teasing only).",
            "Winner gets to BITE your neck (Mark required).",
            "Remove one piece of clothing immediately.",
            "Receive 5 hard spanks.",
            "No touching your partner for 15 mins (Only they touch you).",
            "Lick partner's inner thigh for 60 seconds.",
            "Winner spits in mouth or chooses a foot kiss.",
            "Deep throat practice / Oral worship for 2 mins.",
            "Hands tied for the next round.",
            "Ice cube down the underwear.",
            "Whisper your darkest secret right now.",
            "Hard nipple pinch for 10 seconds.",
            "Perform a sexy crawl to the winner.",
            "Winner picks a degrading nickname for 1 hour.",
            "Stand in corner naked for 2 mins.",
            "Foot massage with tongue.",
            "Winner checks your phone for 1 minute.",
            "Beg for forgiveness on knees.",
            "Hold ice in mouth and go down on partner.",
            "Winner writes a dirty word on your forehead."
        ];

        let bfTimer = null;
        let bfTimeLeft = 60;
        let bfGameMode = 'Random'; // Default mode

        // 1. INITIALIZE
        window.initBlindfold = () => {
            if (window.checkLicensingStatus && !window.checkLicensingStatus()) return;
            
            if(bfTimer) clearInterval(bfTimer);

            // Reset UI
            document.getElementById('blindfold-intro').classList.remove('hidden');
            document.getElementById('blindfold-game').classList.add('hidden');
            
            const overlay = document.getElementById('bf-punishment-overlay');
            if(overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
            
            window.showScreen('blindfold');
        };

        // 2. START GAME (With Mode Selection)
        window.startBlindfoldRound = (mode) => {
            // Set Mode: 'Him', 'Her', or 'Random'
            bfGameMode = mode; 

            document.getElementById('blindfold-intro').classList.add('hidden');
            document.getElementById('blindfold-game').classList.remove('hidden');
            document.getElementById('blindfold-game').classList.add('flex');
            
            window.nextBlindfoldRound();
        };

        // 3. NEXT ROUND (Follows Mode)
        window.nextBlindfoldRound = () => {
            // Close Punishment Overlay
            const overlay = document.getElementById('bf-punishment-overlay');
            if(overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }

            // A. DECIDE TURN BASED ON MODE
            let isHim;
            if (bfGameMode === 'Him') {
                isHim = true; // Hamesha Him
            } else if (bfGameMode === 'Her') {
                isHim = false; // Hamesha Her
            } else {
                isHim = Math.random() < 0.5; // Random
            }

            // Safe Name Fetching
            const p1 = (window.state && window.state.names && window.state.names.Him) ? window.state.names.Him : "Him";
            const p2 = (window.state && window.state.names && window.state.names.Her) ? window.state.names.Her : "Her";

            const blindfoldedName = isHim ? p1 : p2;
            const activeName = isHim ? p2 : p1;
            
            const turnEl = document.getElementById('bf-turn-name');
            if(turnEl) {
                turnEl.textContent = `${blindfoldedName} üôà`;
                // Colors
                if(isHim) {
                    turnEl.classList.remove('text-pink-300');
                    turnEl.classList.add('text-blue-300');
                } else {
                    turnEl.classList.remove('text-blue-300');
                    turnEl.classList.add('text-pink-300');
                }
            }

            // B. Pick Random Items
            const tool = blindfoldTools[Math.floor(Math.random() * blindfoldTools.length)];
            const spot = blindfoldSpots[Math.floor(Math.random() * blindfoldSpots.length)];
            
            // C. Update UI Text
            const toolEl = document.getElementById('bf-tool');
            const spotEl = document.getElementById('bf-spot');
            if(toolEl) toolEl.innerHTML = `${tool} <br><span class="text-xs opacity-50 font-normal">(${activeName} performs this)</span>`;
            if(spotEl) spotEl.textContent = spot;
            
            // D. Reset Timer
            if(bfTimer) clearInterval(bfTimer);
            bfTimeLeft = 60;
            
            const timerEl = document.getElementById('blindfold-timer');
            if(timerEl) {
                timerEl.textContent = bfTimeLeft;
                timerEl.classList.remove('text-red-500');
                timerEl.classList.add('text-indigo-400');
            }

            // E. Start Timer Loop
            bfTimer = setInterval(() => {
                bfTimeLeft--;
                if(timerEl) timerEl.textContent = bfTimeLeft;
                
                if(bfTimeLeft < 10 && timerEl) {
                    timerEl.classList.remove('text-indigo-400');
                    timerEl.classList.add('text-red-500');
                    if(bfTimeLeft === 5 && navigator.vibrate) navigator.vibrate(200);
                }

                if(bfTimeLeft <= 0) {
                    clearInterval(bfTimer);
                    window.triggerBlindfoldPunishment();
                }
            }, 1000);
        };

        window.triggerBlindfoldPunishment = () => {
            const p = blindfoldPunishments[Math.floor(Math.random() * blindfoldPunishments.length)];
            const pText = document.getElementById('bf-punishment-text');
            const overlay = document.getElementById('bf-punishment-overlay');
            
            if(pText) pText.textContent = p;
            if(overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]); 
        };

        window.closeBlindfoldPunishment = () => {
            const overlay = document.getElementById('bf-punishment-overlay');
            if(overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        };

        window.stopBlindfoldGame = () => {
            if(bfTimer) clearInterval(bfTimer);
            window.initBlindfold();
        };
// --- RISK IT ALL LOGIC (PRESS YOUR LUCK) ---

        const riskTasks = {
            safe: [ // Levels 1-3 (Sensual Tease)
                "Lick their earlobe slowly.",
                "Kiss the inner wrist and look deep in their eyes.",
                "Blow hot air on their neck (No touching).",
                "Trace a shape on their inner thigh (over clothes).",
                "Smell their neck deeply and moan.",
                "Bite your own lip while staring at their crotch.",
                "Run your fingers through their hair for 30 seconds.",
                "Rest your head on their chest/lap and close eyes.",
                "Trace their lips with your thumb.",
                "Give a 'Butterfly Kiss' (Eyelashes on cheek).",
                "Kiss the back of their hand 3 times.",
                "Whisper 'You look delicious' in their ear."
            ],
            spicy: [ // Levels 4-7 (Getting Naughty)
                "Squeeze their butt hard with both hands.",
                "Run your tongue along their jawline to the neck.",
                "Kiss their chest/cleavage wetly.",
                "Grind your body against them for 15 seconds.",
                "Rub their crotch firmly with your hand (clothes on).",
                "Lick/Bite their nipples through their shirt.",
                "Bite their shoulder (leave a mark if you want).",
                "Pull their hair gently while kissing.",
                "Slide your hand under their shirt and scratch their back.",
                "Lick the side of their neck upwards to the ear.",
                "Press your body fully against them and hold for 10s.",
                "Bite their bottom lip and pull it slightly.",
                "Whisper exactly what you want to do to them tonight."
            ],
            extreme: [ // Levels 8+ (Dirty, Risky & Private)
                "Give a HICKEY on Inner Thigh, Stomach, or Hip Bone (Hidden Spot).",
                "Hand inside underwear (Front or Back) for 45 seconds.",
                "Oral pleasure for 1 minute (Don't stop).",
                "Take off their underwear (keep pants on).",
                "Dry hump vigorously until one of you moans.",
                "Lick from their navel down to the waistband edge.",
                "Put your hand inside their shirt and pinch their nipple.",
                "Suck their finger while making eye contact.",
                "Bite their butt cheek (through clothes or skin).",
                "Let them touch you ANYWHERE for 1 minute.",
                "Sit on their face (or pull their face to your crotch) for 30s.",
                "Flash a private body part quickly.",
                "Guide their hand to your wet/hard spot."
            ]
        };

        const riskPenalties = [
            // --- CLOTHING (LOSS) ---
            "REMOVE YOUR UNDERWEAR IMMEDIATELY! (You can keep pants on, but no undies).",
            "REMOVE TWO ITEMS OF CLOTHING RIGHT NOW!",
            "STRIP DOWN TO YOUR UNDERWEAR! (Everything else goes off).",
            "Take off your partner's favorite piece of clothing from your body.",
            "Flash your private parts for 5 seconds, then cover up.",

            // --- PHYSICAL (PAIN/SENSATION) ---
            "Winner gets to SPANK you 10 times (Hard & Fast).",
            "Winner gets to BITE your inner thigh (Must leave a mark).",
            "Hold an Ice Cube in your mouth until it melts completely.",
            "Winner puts an Ice Cube down your underwear (Front or Back).",
            "Let the winner PINCH your nipples hard for 10 seconds.",
            "Winner can slap your face (lightly) or your butt (hard) - Their choice.",

            // --- SERVICE / SUBMISSION ---
            "Give ORAL pleasure for 2 minutes (Winner decides speed).",
            "Lick the winner's feet/toes for 1 minute.",
            "Become a 'Human Chair' - Winner sits on you for 2 minutes.",
            "You are BANNED from touching the winner for 15 minutes.",
            "You must ask for permission before speaking for the next 10 minutes.",
            "Beg for forgiveness on your knees while looking up.",
            "Drink a glass of water without using your hands (Winner feeds you like a pet).",

            // --- HUMILIATION / EXPOSURE ---
            "Winner gets to scroll your Phone Gallery/Chats for 60 seconds (Unlocked).",
            "Winner writes 'SLUT' or 'LOSER' on your forehead/chest with lipstick/pen.",
            "Stand in the corner NAKED for 3 minutes (Face the wall).",
            "Send a risky text to the winner (Winner dictates the text).",
            "Perform a sexy/embarrassing dance without music for 1 minute.",
            "Confess your most embarrassing sexual moment.",

            // --- EXTREME ---
            "69 Position for 2 minutes, but YOU cannot finish.",
            "Winner controls your hands (ties them) for the next round of any game.",
            "Let the winner blindfold you and do ANYTHING for 1 minute."
        ];

        let currentRiskLevel = 0;
        let riskActive = false;

        window.startRiskGame = () => {
            if (window.checkLicensingStatus && !window.checkLicensingStatus()) return;
            
            document.getElementById('risk-intro').classList.add('hidden');
            document.getElementById('risk-game').classList.remove('hidden');
            document.getElementById('risk-game').classList.add('flex');
            document.getElementById('risk-bust-overlay').classList.add('hidden');
            
            // Start at Level 0 state
            currentRiskLevel = 0;
            window.updateRiskUI("START", "Press the Red Button to begin...");
        };

        window.pressRedButton = () => {
            // Vibration feedback
            if(navigator.vibrate) navigator.vibrate(100);

            // 1. CALCULATE BUST CHANCE
            // Level 1-3: 5% chance
            // Level 4-6: 25% chance
            // Level 7-9: 50% chance
            // Level 10+: 70% chance
            let bustChance = 0;
            if (currentRiskLevel >= 1 && currentRiskLevel <= 3) bustChance = 0.05;
            else if (currentRiskLevel >= 4 && currentRiskLevel <= 6) bustChance = 0.25;
            else if (currentRiskLevel >= 7 && currentRiskLevel <= 9) bustChance = 0.50;
            else if (currentRiskLevel >= 10) bustChance = 0.70;

            // 2. ROLL THE DICE
            const roll = Math.random();

            if (currentRiskLevel > 0 && roll < bustChance) {
                // --- BUSTED! ---
                window.triggerRiskBust();
            } else {
                // --- SUCCESS! LEVEL UP ---
                currentRiskLevel++;
                
                // Pick Task Category
                let category = 'safe';
                let badgeText = "SAFE";
                let badgeColor = "text-green-400 bg-green-500/20 border-green-500/50";

                if (currentRiskLevel >= 4 && currentRiskLevel <= 7) {
                    category = 'spicy';
                    badgeText = "SPICY üî•";
                    badgeColor = "text-yellow-400 bg-yellow-500/20 border-yellow-500/50";
                } else if (currentRiskLevel >= 8) {
                    category = 'extreme';
                    badgeText = "DANGER ‚ò†Ô∏è";
                    badgeColor = "text-red-500 bg-red-600/20 border-red-500/50";
                }

                // Pick random task from category
                const tasks = riskTasks[category];
                const task = tasks[Math.floor(Math.random() * tasks.length)];

                window.updateRiskUI(currentRiskLevel, task, badgeText, badgeColor);
            }
        };

        window.updateRiskUI = (level, task, badgeText = "SAFE", badgeClass = "") => {
            document.getElementById('risk-level-display').textContent = level;
            document.getElementById('risk-current-task').textContent = task;
            
            const badge = document.getElementById('risk-badge');
            if (badgeClass) {
                badge.className = `text-sm font-bold px-2 py-1 rounded border ${badgeClass}`;
                badge.textContent = badgeText;
            }
        };

        window.triggerRiskBust = () => {
            if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]); // Long fail vibe
            
            const penalty = riskPenalties[Math.floor(Math.random() * riskPenalties.length)];
            document.getElementById('risk-penalty-text').textContent = penalty;
            
            document.getElementById('risk-bust-overlay').classList.remove('hidden');
            document.getElementById('risk-bust-overlay').classList.add('flex');
        };

       // --- UPDATED BANK LOGIC (FIXED) ---

        window.bankRisk = () => {
            // Level 0 pe bank nahi kar sakte (Start screen)
            if (currentRiskLevel === 0) {
                window.showFeedback("Press the Red Button first!", true);
                return;
            }
            
            // 1. Get the Task
            const task = document.getElementById('risk-current-task').textContent;
            
            // 2. Save to Vault (Contract Logic)
            // Winner decide karna mushkil hai single player mode mein, toh hum "Risk Taker" likh denge
            const deal = {
                id: Date.now(),
                title: "Risk It All Reward",
                desc: `Banked at Level ${currentRiskLevel}. Reward: ${task}`,
                winner: "Risk Taker",
                loser: "The House",
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: "Risk Reward"
            };
            
            savedVault.unshift(deal);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            // 3. Show Success Screen
            document.getElementById('risk-banked-text').textContent = task;
            document.getElementById('risk-banked-overlay').classList.remove('hidden');
            document.getElementById('risk-banked-overlay').classList.add('flex');
            
            // 4. Feedback
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]); 
            window.showFeedback("Saved to Vault! üí∞");
        };

        window.closeRiskBanked = () => {
            document.getElementById('risk-banked-overlay').classList.add('hidden');
            document.getElementById('risk-banked-overlay').classList.remove('flex');
            window.resetRiskGame();
        };

        window.resetRiskGame = () => {
            // Reset Overlays
            document.getElementById('risk-bust-overlay').classList.add('hidden');
            document.getElementById('risk-bust-overlay').classList.remove('flex');
            document.getElementById('risk-banked-overlay').classList.add('hidden');
            document.getElementById('risk-banked-overlay').classList.remove('flex');
            
            // Go back to Intro
            document.getElementById('risk-game').classList.add('hidden');
            document.getElementById('risk-intro').classList.remove('hidden');
            
            currentRiskLevel = 0;
        };

        // --- UPDATED GENDER-SPECIFIC DISTRACTION DATA ---

        const distractionTasks = {
            Him: [ // Tasks for HIM to distract HER (Active Player: Her)
                "Slide your hand inside her panties (back or front).",
                "Lick her neck deeply and leave a wet mark.",
                "Bite her earlobe and whisper 'I want you'.",
                "Squeeze her breasts from behind (hard).",
                "Grind your hardening crotch against her back.",
                "Slide a finger across her lips, then put it in your mouth.",
                "Unbutton/Unzip her pants slightly.",
                "Kiss her inner thigh (as high as you can go).",
                "Blow hot air directly on her sensitive spot.",
                "Pinch her nipples through her shirt.",
                "Whisper exactly what you want to do to her tonight.",
                "Pull her hair back gently and kiss her throat.",
                "Rub her crotch firmly with your palm.",
                "Lick your finger and circle her nipple.",
                "Press your body fully against hers and growl.",
                "Trace her spine with an ice cube (if available) or cold hand.",
                "Suck on her neck like you‚Äôre giving a hickey.",
                "Force her to look at your bulge."
            ],
            Her: [ // Tasks for HER to distract HIM (Active Player: Him)
                "Unzip his pants and touch him over his underwear.",
                "Lick his ear and moan softly.",
                "Sit on his lap (if possible) and grind your hips slow and hard.",
                "Put his hand on your chest and squeeze.",
                "Bite his neck/shoulder hard enough to feel.",
                "Whisper 'Fuck me' in his ear repeatedly.",
                "Reach into his pants and stroke him.",
                "Flash him (lift your top or skirt quickly).",
                "Lick his jawline from chin to ear.",
                "Rub your chest against his back.",
                "Kiss his neck while guiding his hand to your wet spot.",
                "Squeeze his bulge firmly.",
                "Take off your panties and put them in his pocket.",
                "Scratch his chest/abs with your nails.",
                "Suck his finger seductively while making eye contact.",
                "Kneel in front of him (like you‚Äôre about to start).",
                "Whisper a dirty secret you've never told him.",
                "Touch yourself while he watches (if hands free)."
            ]
        };

        // SEPARATE REWARDS (If Player SURVIVES 90s)
        const distractRewards = {
            Him: [ // Rewards for HIM (If He wins)
                "üèÜ Winner (Him) gets 10 minutes of ORAL pleasure (Finish allowed).",
                "üèÜ King for a Night: She must obey your commands for 1 hour.",
                "üèÜ Anal Access Pass (If consensual) or Dirty Anal Play.",
                "üèÜ She must strip and serve you drinks/food naked.",
                "üèÜ You choose the position tonight, and she does all the work.",
                "üèÜ Full Body Massage by Her (with Happy Ending).",
                "üèÜ She wears her sexiest lingerie just for you.",
                "üèÜ Face-Sitting: She sits on your face until you tap out.",
                "üèÜ Titty F*ck: You get to use her chest however you want.",
                "üèÜ Freedom: You get a pass from chores/arguments for 24 hours."
            ],
            Her: [ // Rewards for HER (If She wins)
                "üèÜ Winner (Her) gets 20 minutes of ORAL pleasure (He cannot stop).",
                "üèÜ Queen for a Night: He must obey your commands for 1 hour.",
                "üèÜ Shopping Treat: He buys you a gift (Limit decided by you).",
                "üèÜ He must strip and give you a sensual oil massage.",
                "üèÜ You choose the toy/position, and he does all the work.",
                "üèÜ Princess Treatment: He carries you to bed and serves you.",
                "üèÜ He has to go down on you until you shake.",
                "üèÜ He wears whatever you pick for him (or nothing at all).",
                "üèÜ Cuddle & Control: You sit on his face or chest for 5 mins.",
                "üèÜ Dirty Talk: He has to whisper his darkest desires to you."
            ]
        };

        // SEPARATE PUNISHMENTS (If Player FAILS/STOPS Tapping)
        const distractPunishments = {
            Him: [ // Punishments for HIM (If He fails)
                "‚ò†Ô∏è BLUE BALLS: You are denied release for tonight.",
                "‚ò†Ô∏è Lick her feet/toes for 5 minutes.",
                "‚ò†Ô∏è Wear her panties (or nothing) for the next hour.",
                "‚ò†Ô∏è Give her a 15-minute foot massage (No sexual touch).",
                "‚ò†Ô∏è You must clean the room/house while she watches.",
                "‚ò†Ô∏è Let her do your makeup (Lipstick/Eyeliner).",
                "‚ò†Ô∏è Handcuffed: She ties you up and teases you (No touching her).",
                "‚ò†Ô∏è Send a risky text to her (She dictates the words).",
                "‚ò†Ô∏è Ice Cube Torture: She puts ice in your underwear.",
                "‚ò†Ô∏è 50 Spanks on the ass (She uses a belt or hand)."
            ],
            Her: [ // Punishments for HER (If She fails)
                "‚ò†Ô∏è DEEP THROAT PRACTICE: 5 minutes, deep as possible.",
                "‚ò†Ô∏è Ass Play: He gets to play with your backdoor (Finger/Plug).",
                "‚ò†Ô∏è 20 Hard Spanks on the ass.",
                "‚ò†Ô∏è You must wear a gag (or keep mouth shut) for 30 mins.",
                "‚ò†Ô∏è Go Commando: Take off your panties and give them to him.",
                "‚ò†Ô∏è Perform a striptease for him (Music of his choice).",
                "‚ò†Ô∏è Face Down, Ass Up: Stay in position for 5 mins while he teases.",
                "‚ò†Ô∏è He controls your orgasm (Edging only, no finish).",
                "‚ò†Ô∏è Wear a blindfold and let him do ANYTHING for 10 mins.",
                "‚ò†Ô∏è Swallow: Next time you give oral, you must swallow."
            ]
        };

        let distractTimer = null;
        let distractCheckInterval = null;
        let lastTapTime = 0;
        let distractTimeLeft = 90;
        let distractActivePlayer = null; // 'Him' or 'Her'

        window.initDistraction = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('distraction');
            
            // Reset UI
            document.getElementById('distraction-intro').classList.remove('hidden');
            document.getElementById('distraction-game').classList.add('hidden');
            document.getElementById('distract-fail-overlay').classList.add('hidden');
            document.getElementById('distract-fail-overlay').classList.remove('flex');
            document.getElementById('distract-win-overlay').classList.add('hidden');
            document.getElementById('distract-win-overlay').classList.remove('flex');

            window.stopDistractionGame();
        };

        window.startDistractionGame = (activePlayer) => {
            // Active Player = Who is Tapping
            // Distractor = The other person
            distractActivePlayer = activePlayer;
            const distractor = activePlayer === 'Him' ? 'Her' : 'Him';

            document.getElementById('distraction-intro').classList.add('hidden');
            document.getElementById('distraction-game').classList.remove('hidden');
            document.getElementById('distraction-game').classList.add('flex');

            // Setup Game State
            distractTimeLeft = 90;
            lastTapTime = Date.now(); // Give initial buffer
            
            // Update UI
            document.getElementById('distract-timer').textContent = "90";
            document.getElementById('distract-progress').style.width = "100%";
            document.getElementById('distract-task').textContent = `Partner (${distractor}), Get Ready to Distract!`;

            // Start Main Timer (Countdown)
            if(distractTimer) clearInterval(distractTimer);
            distractTimer = setInterval(() => {
                distractTimeLeft--;
                document.getElementById('distract-timer').textContent = distractTimeLeft;
                const percent = (distractTimeLeft / 90) * 100;
                document.getElementById('distract-progress').style.width = `${percent}%`;

                // Change Distraction Task every 7 seconds
                if (distractTimeLeft % 7 === 0 && distractTimeLeft > 0) {
                    const tasks = distractionTasks[distractor];
                    const task = tasks[Math.floor(Math.random() * tasks.length)];
                    document.getElementById('distract-task').textContent = task;
                    
                    // Add animation effect to task box
                    const taskBox = document.getElementById('distract-task').parentElement;
                    taskBox.classList.remove('animate-pulse');
                    void taskBox.offsetWidth; // Trigger reflow
                    taskBox.classList.add('animate-pulse');
                    
                    if(navigator.vibrate) navigator.vibrate(200); // Vibrate on new task
                }

                if (distractTimeLeft <= 0) {
                    window.winDistractionGame();
                }
            }, 1000);

            // Start Tap Check Loop
            if(distractCheckInterval) clearInterval(distractCheckInterval);
            distractCheckInterval = setInterval(() => {
                const now = Date.now();
                // 3 second grace period at start
                if (90 - distractTimeLeft > 3) { 
                    if (now - lastTapTime > 800) { // 800ms gap allowed max
                        window.failDistractionGame();
                    }
                } else {
                    lastTapTime = Date.now();
                }
            }, 100);

            // Bind Tap Event
            const tapBtn = document.getElementById('btn-tap-zone');
            const newBtn = tapBtn.cloneNode(true);
            tapBtn.parentNode.replaceChild(newBtn, tapBtn);
            
            const handleTap = (e) => {
                e.preventDefault(); 
                lastTapTime = Date.now();
                newBtn.style.transform = "scale(0.95)";
                setTimeout(() => newBtn.style.transform = "scale(1)", 50);
            };

            newBtn.addEventListener('mousedown', handleTap);
            newBtn.addEventListener('touchstart', handleTap);
        };

        window.failDistractionGame = () => {
            window.stopDistractionGame();
            
            // LOGIC CHANGE: Pick punishment based on Active Player
            const punishmentsList = distractPunishments[distractActivePlayer];
            const p = punishmentsList[Math.floor(Math.random() * punishmentsList.length)];
            
            document.getElementById('distract-punishment').textContent = p;

            if(navigator.vibrate) navigator.vibrate([500, 200, 500]); 

            const overlay = document.getElementById('distract-fail-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        };

        window.winDistractionGame = () => {
            window.stopDistractionGame();

            // LOGIC CHANGE: Pick reward based on Active Player
            const rewardsList = distractRewards[distractActivePlayer];
            const r = rewardsList[Math.floor(Math.random() * rewardsList.length)];
            
            document.getElementById('distract-reward').textContent = r;

            const overlay = document.getElementById('distract-win-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        };

        window.stopDistractionGame = () => {
            if(distractTimer) clearInterval(distractTimer);
            if(distractCheckInterval) clearInterval(distractCheckInterval);
        };
        
        window.claimDistractReward = () => {
             const reward = document.getElementById('distract-reward').textContent;
             const winner = distractActivePlayer === 'Him' ? window.state.names.Him : window.state.names.Her;
             const loser = distractActivePlayer === 'Him' ? window.state.names.Her : window.state.names.Him;
             
             const deal = {
                id: Date.now(),
                title: "Endurance Champion",
                desc: `Survived 90s. Reward: ${reward}`,
                winner: winner,
                loser: loser,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: "Claimed"
            };
            
            savedVault.unshift(deal);
            localStorage.setItem('contractVault', JSON.stringify(savedVault));
            
            window.showFeedback("Reward Claimed & Vaulted! üèÜ");
            setTimeout(() => window.showVault(), 1000);
        };

// --- SENSORY TRIO (TURN-WISE LOGIC) ---

        const slsActions = [
            "LICK üëÖ", "SUCK üíã", "SQUEEZE ü§è", "BITE (Gently) üßõ", "KISS üòò", 
            "NIBBLE ü¶∑", "MASSAGE üëê", "BLOW (Hot Air) üå¨Ô∏è", "SCRATCH (Lightly) üíÖ", 
            "TEASE üòà", "DEVOUR ü¶Å", "GRIND ON üçë", "RUB ‚úã", "TRACE (Finger) üëÜ", 
            "HOVER (Don't Touch) üëª", "PINCH ü§è", "SLAP (Playful) üëã", "PULSE üíì"
        ];

        const slsBodyParts = [
            "Neck", "Earlobe", "Inner Thigh", "Nipples", "Fingertips", "Lips", "Abs/Stomach", 
            "Lower Back", "Butt Cheeks", "Inner Wrist", "Collarbone", "Toes", "Behind Knee", 
            "Chest", "Jawline", "Palm", "Navel", "Spine", "Groin (Over Clothes)",
            "Hip Bone", "Underarm", "Nape of Neck", "Inner Elbow", "Ankle", "Pubic Bone"
        ];

        const slsDurations = [
            "10 Seconds", "30 Seconds", "1 Minute", "Until they moan", "Slowly", "Aggressively", 
            "While making eye contact", "Using Ice", "Using Oil/Lotion", "Blindfolded", "Hands Tied",
            "Under the shirt", "Without hands (Mouth only)", "In Slow Motion", "Hard & Fast"
        ];

        // SPLIT JACKPOTS (Smart Logic)
        const slsJackpots = {
            Mutual: [
                "üî• JACKPOT: 69 Position (Unlimited Time).",
                "üî• JACKPOT: Simultaneous Oral (No one finishes yet).",
                "üî• JACKPOT: 'Free Use' Pass (Winner uses Loser for 10 mins).",
                "üî• JACKPOT: French Kiss Marathon (3 Minutes Non-Stop).",
                "üî• JACKPOT: Dry Humping (Grind until one person moans).",
                "üî• JACKPOT: Edging Game (Bring them close, stop, repeat).",
                "üî• JACKPOT: Sensory Deprivation (Both blindfolded, touch only)."
            ],
            Him: [ // Jackpots for HIM (He wins/receives)
                "üî• JACKPOT: Oral Pleasure (He receives until finish).",
                "üî• JACKPOT: Body Worship (She kisses every inch of him).",
                "üî• JACKPOT: The Viewer (She touches herself while he watches).",
                "üî• JACKPOT: Handjob with Lotion/Oil (Her grip, his pace).",
                "üî• JACKPOT: Face Sitting (She sits on his face for 2 mins).",
                "üî• JACKPOT: Titty F*ck (Use her chest).",
                "üî• JACKPOT: Massage King (Full body massage from her).",
                "üî• JACKPOT: Dirty Talk (She whispers her darkest fantasy).",
                "üî• JACKPOT: Lap Dance (She grinds on him, fully clothed or not)."
            ],
            Her: [ // Jackpots for HER (She wins/receives)
                "üî• JACKPOT: Oral Pleasure (She receives until finish).",
                "üî• JACKPOT: Striptease (He performs a sexy dance for her).",
                "üî• JACKPOT: Worship Her Feet & Legs (5 Mins).",
                "üî• JACKPOT: Magic Fingers (He uses hands only to make her finish).",
                "üî• JACKPOT: Princess Carry (He carries her to bed + Cuddles).",
                "üî• JACKPOT: Nipple Torture (He focuses only on her chest for 5 mins).",
                "üî• JACKPOT: The Throne (She sits on his face).",
                "üî• JACKPOT: Scratch & Bite (He marks her neck/shoulders).",
                "üî• JACKPOT: Command (She gives 3 orders, he MUST obey)."
            ]
        };

        let slsTurn = 'Him'; // Track current turn

        window.initSLSGame = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('sls');
            
            // Randomly start turn or keep sequence
            // slsTurn = Math.random() < 0.5 ? 'Him' : 'Her'; 
            
            window.updateSLSTurnUI();
            document.getElementById('sls-intro').classList.remove('hidden');
            document.getElementById('sls-result').classList.add('hidden');
            document.getElementById('sls-result').classList.remove('flex');
        };

        window.updateSLSTurnUI = () => {
            const name = window.state.names[slsTurn];
            const el = document.getElementById('sls-turn-text');
            el.textContent = name;
            
            // Color coding
            if (slsTurn === 'Him') {
                el.classList.remove('text-pink-400');
                el.classList.add('text-blue-400');
            } else {
                el.classList.remove('text-blue-400');
                el.classList.add('text-pink-400');
            }
        };

        window.spinSLS = () => {
            document.getElementById('sls-intro').classList.add('hidden');
            const resScreen = document.getElementById('sls-result');
            resScreen.classList.remove('hidden');
            resScreen.classList.add('flex');

            // Reset Styles
            window.resetSlotStyles();

            const actEl = document.getElementById('sls-action');
            const bodEl = document.getElementById('sls-body');
            const timEl = document.getElementById('sls-time');

            if(navigator.vibrate) navigator.vibrate(50);

            // Animation
            let counter = 0;
            const interval = setInterval(() => {
                actEl.textContent = slsActions[Math.floor(Math.random() * slsActions.length)];
                bodEl.textContent = slsBodyParts[Math.floor(Math.random() * slsBodyParts.length)];
                timEl.textContent = slsDurations[Math.floor(Math.random() * slsDurations.length)];
                
                counter++;
                if (counter > 20) { 
                    clearInterval(interval);
                    window.finalizeSLS();
                }
            }, 80);
        };

        window.finalizeSLS = () => {
            const actEl = document.getElementById('sls-action');
            const bodEl = document.getElementById('sls-body');
            const timEl = document.getElementById('sls-time');
            
            // 15% Jackpot Chance
            const isJackpot = Math.random() < 0.25; 

            if (isJackpot) {
                // --- SMART JACKPOT LOGIC ---
                // Pick from Mutual OR Specific Gender list
                const pool = [...slsJackpots.Mutual, ...slsJackpots[slsTurn]];
                const jackpotTask = pool[Math.floor(Math.random() * pool.length)];
                
                // Gold Style
                window.setSlotStyles(true);

                actEl.innerHTML = "üëë <span class='text-amber-400'>JACKPOT!</span> üëë";
                bodEl.innerHTML = `<span class='text-amber-300 text-xl leading-tight'>${jackpotTask}</span>`;
                timEl.innerHTML = `FOR ${window.state.names[slsTurn].toUpperCase()}!`;
                
                if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 500]);
                
            } else {
                // --- NORMAL LOGIC ---
                window.setSlotStyles(false);

                actEl.textContent = slsActions[Math.floor(Math.random() * slsActions.length)];
                bodEl.textContent = slsBodyParts[Math.floor(Math.random() * slsBodyParts.length)];
                timEl.textContent = slsDurations[Math.floor(Math.random() * slsDurations.length)];
                
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        };

        window.resetSLS = () => {
            // Switch Turn
            slsTurn = slsTurn === 'Him' ? 'Her' : 'Him';
            window.updateSLSTurnUI();
            
            document.getElementById('sls-result').classList.add('hidden');
            document.getElementById('sls-result').classList.remove('flex');
            document.getElementById('sls-intro').classList.remove('hidden');
        };

        window.setSlotStyles = (isGold) => {
            const slots = ['slot-box-1', 'slot-box-2', 'slot-box-3'];
            slots.forEach(id => {
                const el = document.getElementById(id);
                if (isGold) {
                    el.classList.replace('bg-black/40', 'bg-amber-500/20');
                    el.classList.replace('border-pink-500/30', 'border-amber-500');
                } else {
                    // Safe reset if class exists
                    if(el.classList.contains('bg-amber-500/20')) {
                        el.classList.replace('bg-amber-500/20', 'bg-black/40');
                        el.classList.replace('border-amber-500', 'border-pink-500/30');
                    }
                }
            });
        };
        
        window.resetSlotStyles = () => window.setSlotStyles(false);

// --- PANDORA'S BOX LOGIC (GENDER SPECIFIC & MASSIVE) ---

        const pandoraItems = [
            "devil", "devil", "devil", 
            "angel", "angel", "angel", 
            "empty", "empty", "empty"
        ];
        
        // --- PANDORA'S BOX LOGIC (NO ANAL/TOYS - PURE INTENSITY) ---

        const pandoraData = {
            Him: {
                // Punishment for Him (Endurance, Sensation, Denial)
                Devil: [
                    "üòà BLUE BALLS: She teases you for 10 mins, but you are DENIED release.",
                    "üòà THE PLANK: Hold a plank above her for 1 minute. If you drop, she bites you.",
                    "üòà ICE TORTURE: She rubs an ice cube on your inner thighs and neck until it melts.",
                    "üòà HANDCUFFED: Hands tied behind your back for 15 mins. She teases, you can't touch.",
                    "üòà KNEEL: Kneel by the bed while she relaxes. You must wait for permission to move.",
                    "üòà FOOT WORSHIP: Massage and kiss her feet for 5 minutes.",
                    "üòà SILENCE: You cannot speak for 20 mins. If you make a noise, she spanks you.",
                    "üòà PHONE UNLOCK: She gets to read your last 3 chats.",
                    "üòà COLD SHOWER: Go take a 2-minute cold shower right now to cool down.",
                    "üòà LICK: Lick her inner thighs for 3 minutes without moving higher.",
                    "üòà THE STATUE: Stand perfectly still while she traces your sensitive spots.",
                    "üòà NECK BITING: She gets to leave a love bite (Hickey) on your neck/chest.",
                    "üòà PUSHUPS: Do 20 pushups naked while she watches.",
                    "üòà SENSORY DEPRIVATION: Blindfold + Headphones on. She touches you unexpectedly.",
                    "üòà WALL SIT: Hold a wall sit for 90 seconds while she kisses your neck.",
                    "üòà SCRATCH MARKS: She scratches your back lightly (or hard) for 1 minute.",
                    "üòà BREATH CONTROL: She covers your mouth with her hand while you breathe deeply.",
                    "üòà BODY SHOT: She pours a drink on your chest and licks it off (Sticky punishment).",
                    "üòà NO HANDS: You must please her for 5 minutes using only your mouth.",
                    "üòà EYE CONTACT: Maintain eye contact for 2 minutes. If you blink, you lose a clothing item."
                ],
                // Reward for Him (Pleasure, Visuals, Dominance)
                Angel: [
                    "üòá BLOWJOB: She goes down on you until you finish.",
                    "üòá LAP DANCE: She gives you a slow, grinding lap dance.",
                    "üòá BODY WORSHIP: She kisses every inch of your body.",
                    "üòá SHOWER SERVICE: She joins you in the shower and washes you sensually.",
                    "üòá HANDJOB: With lotion/oil, her grip, your pace.",
                    "üòá FULL CONTROL: You control her body and actions for 20 minutes.",
                    "üòá FACE SITTING: She sits on your face for 3 minutes.",
                    "üòá DIRTY TALK: She whispers exactly what she wants you to do to her.",
                    "üòá 69 POSITION: Mutual pleasure until one of you taps out.",
                    "üòá MASSAGE: Full body oil massage from her (Happy ending optional).",
                    "üòá COMMAND: Give her 3 orders right now, she MUST obey.",
                    "üòá THIGH RIDE: She grinds on your thigh until you say stop.",
                    "üòá FREE USE: You can touch/kiss/grab her anywhere for the next 15 mins."
                ]
            },
            Her: {
                // Punishment for Her (Teasing, Sensation, Submission)
                Devil: [
                    "üòà DEEP THROAT: Take him as deep as possible for 2 mins (He controls pace).",
                    "üòà SPANKING: 15 Hard spanks on bare skin.",
                    "üòà NIPPLE TORTURE: He pinches, bites, or flicks your nipples for 3 mins.",
                    "üòà FACE DOWN: Ass up position for 5 mins while he teases (No touching back).",
                    "üòà GAGGED: Keep your mouth shut (or use a cloth) for 20 mins.",
                    "üòà WRISTS HELD: He pins your wrists above your head for 10 mins.",
                    "üòà EDGING: He brings you close to orgasm 3 times but denies the finish.",
                    "üòà ICE PLAY: He runs an ice cube over your nipples and inner thighs.",
                    "üòà NO PANTIES: Take them off and hand them to him for the rest of the game.",
                    "üòà BEGGING: On your knees, beg him to touch you (He might say no).",
                    "üòà FLASH: Flash him near a window or door (Risk getting caught).",
                    "üòà DIRTY WHISPER: Scream/Moan a dirty phrase he chooses.",
                    "üòà PINCH: He pinches your inner thighs or butt cheeks.",
                    "üòà WET SKIN: He drips cold water on your bare stomach/back.",
                    "üòà HAIR PULLING: He controls your head movement by your hair for 5 mins.",
                    "üòà DOMINATED: He chooses a position, you must stay in it until he says move.",
                    "üòà BITE MARK: He bites your shoulder/neck hard enough to mark.",
                    "üòà CLOTHESPIN: He puts a clip/clothespin on your nipple for 30 seconds.",
                    "üòà OPEN WIDE: Keep your mouth open and tongue out for 1 minute.",
                    "üòà THE VIEW: Wear only a white shirt/t-shirt and let him wet it with water(no bra)."
                ],
                // Reward for Her (Oral, Pampering, Worship)
                Angel: [
                    "üòá CUNNILINGUS: He goes down on you until you shake/finish.",
                    "üòá FULL BODY MASSAGE: 15 minutes of sensory oil massage.",
                    "üòá NECK WORSHIP: 5 minutes of just neck/ear kissing and biting.",
                    "üòá PRINCESS CARRY: He carries you to bed and cuddles you.",
                    "üòá FOOT RUB: 10 minutes of dedicated foot massage.",
                    "üòá NO CHORES: He does all the chores for the next 24 hours.",
                    "üòá CUDDLE SESSION: 10 minutes of pure holding and intimacy.",
                    "üòá BREAST MASSAGE: He gently massages your chest for 5 minutes.",
                    "üòá CONTROL: You ride him and control the depth/pace completely.",
                    "üòá FINGER PLAY: He uses his fingers to make you finish.",
                    "üòá AFTERCARE: He brings you water/snacks and holds you.",
                    "?? SHOPPING: He buys you a small treat/gift.",
                    "üòá SENSORY TOUCH: He traces your body with a feather or soft cloth."
                ]
            }
        };

        let pandoraTurn = 'Him';
        let pandoraGridState = [];
        let pandoraOpened = 0;
        let pScore = { devil: 0, angel: 0, empty: 0 };

        window.initPandora = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('pandora');
            
            // UI Reset
            document.getElementById('pandora-intro').classList.remove('hidden');
            document.getElementById('pandora-game').classList.add('hidden');
            document.getElementById('pandora-result').classList.add('hidden');
            document.getElementById('pandora-result').classList.remove('flex');
            document.getElementById('pandora-result').style.opacity = '0';
            
            document.getElementById('pandora-final-icon').classList.remove('scale-100');
            document.getElementById('pandora-final-icon').classList.add('scale-0');
            
            window.updatePandoraTurnUI();
        };

        window.updatePandoraTurnUI = () => {
            const name = window.state.names[pandoraTurn];
            const el = document.getElementById('pandora-turn-display');
            el.textContent = name;
            
            if (pandoraTurn === 'Him') {
                el.classList.remove('text-pink-400');
                el.classList.add('text-blue-400');
            } else {
                el.classList.remove('text-blue-400');
                el.classList.add('text-pink-400');
            }
        };

        window.startPandora = () => {
            document.getElementById('pandora-intro').classList.add('hidden');
            document.getElementById('pandora-game').classList.remove('hidden');
            document.getElementById('pandora-game').classList.add('flex');
            
            pandoraOpened = 0;
            pScore = { devil: 0, angel: 0, empty: 0 };
            document.getElementById('pandora-count').textContent = "0";
            document.getElementById('score-angel-disp').textContent = "0";
            document.getElementById('score-devil-disp').textContent = "0";
            document.getElementById('pandora-msg').textContent = `Choose 3 Boxes for ${window.state.names[pandoraTurn]}...`;
            
            // Shuffle
            pandoraGridState = [...pandoraItems].sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('pandora-grid');
            grid.innerHTML = '';
            
            pandoraGridState.forEach((item, index) => {
                const container = document.createElement('div');
                container.className = "perspective-1000 cursor-pointer h-full w-full";
                
                const card = document.createElement('div');
                card.className = "relative w-full h-full text-center transition-transform duration-700 transform-style-3d shadow-lg rounded-xl group";
                card.id = `pandora-box-${index}`;
                
                const front = document.createElement('div');
                front.className = "absolute w-full h-full backface-hidden bg-gradient-to-br from-purple-800 to-purple-900 border border-purple-500/30 rounded-xl flex items-center justify-center shadow-[inset_0_0_20px_rgba(0,0,0,0.5)] group-hover:border-purple-400 transition-colors";
                front.innerHTML = `<i data-lucide="package" class="w-8 h-8 text-purple-300 opacity-80"></i>`;
                
                const back = document.createElement('div');
                back.className = "absolute w-full h-full backface-hidden rotate-y-180 rounded-xl flex items-center justify-center border-2";
                back.id = `pandora-back-${index}`;
                
                card.appendChild(front);
                card.appendChild(back);
                container.appendChild(card);
                
                container.onclick = () => window.openPandoraBox(index, card, back, item);
                grid.appendChild(container);
            });
            if(window.lucide) lucide.createIcons();
        };

        // --- PANDORA FUNCTION (Paste at the bottom) ---

window.openPandoraBox = (index, cardEl, backEl, item, isRemote = false, remoteText = null) => {
    // Agar box pehle se khula hai ya 3 khul chuke hain toh kuch mat karo
    if (cardEl.classList.contains('opened') || pandoraOpened >= 3) return;

    // --- SENDER LOGIC (Jab main click karu) ---
    if (!isRemote) {
        // Multiplayer Turn Check
        if (window.state.isMultiplayer && window.state.names[pandoraTurn] !== window.state.names[window.state.myRole]) {
             window.showFeedback(`Not your turn! It's ${window.state.names[pandoraTurn]}'s turn.`, true);
             return;
        }

        // Text Decide Karo (Taaki dono ko same mile)
        let syncText = "";
        if (item === 'devil') {
            // Devil Tasks list se random pick
            const list = pandoraData[pandoraTurn].Devil; 
            syncText = list[Math.floor(Math.random() * list.length)];
        } else if (item === 'angel') {
            // Angel Tasks list se random pick
            const list = pandoraData[pandoraTurn].Angel;
            syncText = list[Math.floor(Math.random() * list.length)];
        }

        // Partner ko Bhejo
        if (window.state.isMultiplayer) {
            sendStateUpdate('PANDORA_OPEN', { 
                index: index, 
                item: item,
                text: syncText // Yeh text bhejna zaroori hai sync ke liye
            });
        }
        
        // Local variable mein save karo taaki display ho sake
        window.tempPandoraText = syncText;
    } 
    // --- RECEIVER LOGIC ---
    else {
        // Partner ne text bheja hai, usko use karo
        window.tempPandoraText = remoteText;
    }

    // --- ANIMATION START ---
    cardEl.classList.add('opened', 'rotate-y-180');
    pandoraOpened++;
    document.getElementById('pandora-count').textContent = pandoraOpened;
    
    setTimeout(() => {
        // Style update based on Item
        if (item === "devil") {
            backEl.className += " bg-red-900 border-red-500 shadow-[0_0_15px_red]";
            // Text Display logic (Icons + Text)
            backEl.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-2 text-center">
                    <i data-lucide="flame" class="w-8 h-8 text-red-400 animate-pulse mb-1"></i>
                    <p class="text-[10px] text-white/90 leading-tight font-medium">${window.tempPandoraText || "Devil's Luck"}</p>
                </div>`;
            
            pScore.devil++;
            document.getElementById('score-devil-disp').textContent = pScore.devil;

        } else if (item === "angel") {
            backEl.className += " bg-green-900 border-green-500 shadow-[0_0_15px_#4ade80]";
            backEl.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-2 text-center">
                    <i data-lucide="halo" class="w-8 h-8 text-green-400 animate-pulse mb-1"></i>
                    <p class="text-[10px] text-white/90 leading-tight font-medium">${window.tempPandoraText || "Angel's Kiss"}</p>
                </div>`;
            
            pScore.angel++;
            document.getElementById('score-angel-disp').textContent = pScore.angel;

        } else {
            // Empty Box
            backEl.className += " bg-gray-800 border-gray-600";
            backEl.innerHTML = `<span class="text-2xl opacity-30">‚ùå</span>`;
            pScore.empty++;
        }
        
        // Refresh Icons
        if(window.lucide) lucide.createIcons();
        
    }, 150);

    // Game Over Check (3 boxes opened)
    if (pandoraOpened === 3) {
        setTimeout(window.showPandoraResult, 1500);
    }
};


        window.showPandoraResult = () => {
            const resScreen = document.getElementById('pandora-result');
            resScreen.classList.remove('hidden');
            resScreen.classList.add('flex');
            
            setTimeout(() => {
                resScreen.style.opacity = '1';
                document.getElementById('pandora-final-icon').classList.remove('scale-0');
                document.getElementById('pandora-final-icon').classList.add('scale-100');
            }, 50);
            
            const title = document.getElementById('pandora-final-title');
            const desc = document.getElementById('pandora-final-desc');
            const icon = document.getElementById('pandora-final-icon');
            const pName = document.getElementById('pandora-result-name');
            
            pName.textContent = window.state.names[pandoraTurn];

            // LOGIC FOR PICKING TASK BASED ON GENDER
            if (pScore.devil > pScore.angel) {
                // DEVIL WINS -> PUNISHMENT FOR CURRENT PLAYER
                title.textContent = "HELL UNLEASHED üòà";
                title.className = "text-4xl font-black text-red-500 fancy-font mb-4 tracking-wide glitch-text";
                icon.innerHTML = `<div class="w-24 h-24 rounded-full bg-red-500/20 flex items-center justify-center border-4 border-red-500 shadow-[0_0_50px_red]"><i data-lucide="skull" class="w-12 h-12 text-red-500"></i></div>`;
                
                const list = pandoraData[pandoraTurn].Devil;
                const task = list[Math.floor(Math.random() * list.length)];
                desc.textContent = task;
                
                if(navigator.vibrate) navigator.vibrate([500, 200, 500]);

            } else if (pScore.angel > pScore.devil) {
                // ANGEL WINS -> REWARD FOR CURRENT PLAYER
                title.textContent = "PURE BLISS üòá";
                title.className = "text-4xl font-black text-green-400 fancy-font mb-4 tracking-wide";
                icon.innerHTML = `<div class="w-24 h-24 rounded-full bg-green-500/20 flex items-center justify-center border-4 border-green-500 shadow-[0_0_50px_#4ade80]"><i data-lucide="gift" class="w-12 h-12 text-green-400"></i></div>`;
                
                const list = pandoraData[pandoraTurn].Angel;
                const task = list[Math.floor(Math.random() * list.length)];
                desc.textContent = task;
                
                if(navigator.vibrate) navigator.vibrate([100, 100, 100]);

            } else {
                // DRAW
                title.textContent = "SAFE... FOR NOW";
                title.className = "text-3xl font-black text-gray-400 fancy-font mb-4";
                icon.innerHTML = `<div class="w-24 h-24 rounded-full bg-gray-500/20 flex items-center justify-center border-4 border-gray-500"><i data-lucide="shield" class="w-12 h-12 text-gray-400"></i></div>`;
                desc.textContent = "You survived with no reward and no punishment. Just a passionate kiss required.";
            }
            if(window.lucide) lucide.createIcons();
        };

        window.rotatePandoraTurn = () => {
            pandoraTurn = pandoraTurn === 'Him' ? 'Her' : 'Him';
            window.initPandora();
        };

// --- LIP LUST LOGIC (EXPANDED 50+ ITEMS) ---

        const lipPhrases = [
            "I want you inside me.", "Take off my pants.", "Kiss my neck softly.",
            "You are my master.", "I am not wearing underwear.", "Touch me right now.",
            "Make me scream.", "Your hands feel good.", "Bite my lip hard.",
            "I want to taste you.", "Let's go to the bedroom.", "Don't stop, don't stop.",
            "You look so tasty.", "Use your tongue.", "Beg for it.",
            "Spank me hard.", "I need you now.", "You own my body.",
            "Look at my eyes.", "Open your mouth.", "Good boy/girl.",
            "Harder, faster, deeper.", "Wet and ready.", "Play with me.",
            "Your zipper is open.", "Come closer to me.", "Touch yourself for me.",
            "I had a wet dream.", "Make me sweat.", "Pull my hair.",
            "Rub my back.", "I want a massage.", "Taste my skin.",
            "Be rough with me.", "Be gentle with me.", "Use your fingers.",
            "Show me what you got.", "Daddy is home.", "Mummy is waiting.",
            "Do what you want.", "I surrender to you.", "My legs are shaking.",
            "Kiss me down there.", "Lick me all over.", "I am so horny."
        ];

        const lipPunishments = {
            Him: [ // If HE fails to guess (Punishment for Him)
                "‚ò†Ô∏è REMOVE SHIRT: Take it off slowly.",
                "‚ò†Ô∏è 10 PUSHUPS: Do them right now while she watches.",
                "‚ò†Ô∏è LICK HER NECK: For 2 minutes continuously.",
                "‚ò†Ô∏è SPANKED: She gets to spank you 10 times (Hard).",
                "‚ò†Ô∏è NO TOUCHING: You cannot touch her for 15 mins (She teases).",
                "‚ò†Ô∏è SHOW HISTORY: Open your browser history for her.",
                "‚ò†Ô∏è ICE CUBE: Hold ice in your mouth for 1 minute.",
                "‚ò†Ô∏è FOOT WORSHIP: Massage and kiss her feet for 5 mins.",
                "‚ò†Ô∏è BLINDFOLD: Wear it for 10 mins. She does whatever she wants.",
                "‚ò†Ô∏è BEG: On your knees, beg her to forgive you.",
                "‚ò†Ô∏è PHONE UNLOCK: Hand over your phone for 2 minutes.",
                "‚ò†Ô∏è LICK EAR: Lick her earlobe wetly for 3 mins.",
                "‚ò†Ô∏è STATUE: Stand still for 5 mins. She touches you, you can't move.",
                "‚ò†Ô∏è INNER THIGH: Kiss her inner thighs for 5 mins (No higher).",
                "‚ò†Ô∏è HANDCUFFED: Hands behind back for 10 mins.",
                "‚ò†Ô∏è SENSORY: She runs a feather/comb over your bare chest.",
                "‚ò†Ô∏è BITE MARK: She gives you a hickey on your neck/shoulder.",
                "‚ò†Ô∏è SLAVE: You must obey her next 3 commands instantly.",
                "‚ò†Ô∏è NO SPEAKING: Keep quiet for 10 mins. Moaning allowed.",
                "‚ò†Ô∏è LAP PILLOW: Let her rest her head on your lap while you massage her.",
                "‚ò†Ô∏è BLUE BALLS: She teases you but denies finish for tonight."
            ],
            Her: [ // If SHE fails to guess (Punishment for Her)
                "‚ò†Ô∏è REMOVE BRA: Or one item of clothing (Winner's choice).",
                "‚ò†Ô∏è KISS HIS INNER THIGH: Stay there for 2 mins.",
                "‚ò†Ô∏è SUCK HIS FINGER: Make it look sexy for 1 min.",
                "‚ò†Ô∏è SPANKED: He spanks you 10 times (Hand or Belt).",
                "‚ò†Ô∏è ON KNEES: Stay on your knees for 5 mins He can do anything with youand you can't deny.",
                "‚ò†Ô∏è FLASH: Show him what you're hiding (Boobs/Butt).",
                "‚ò†Ô∏è DEEP THROAT: Practice depth for 2 mins (He controls).",
                "‚ò†Ô∏è FACE DOWN: Ass up position for 5 mins.",
                "‚ò†Ô∏è GAGGED: Keep mouth shut (or use cloth) for 10 mins.",
                "‚ò†Ô∏è NIPPLE PINCH: He pinches/plays with nipples for 2 mins.",
                "‚ò†Ô∏è NO PANTIES: Take them off and give them to him.",
                "‚ò†Ô∏è WET T-SHIRT: Let him pour water on your white shirt.",
                "‚ò†Ô∏è ICE PLAY: Ice cube down your back or front.",
                "‚ò†Ô∏è DOMINATED: He holds your wrists down for 5 mins.",
                "‚ò†Ô∏è THE WATCHER: Watch him touch himself. You can't touch.",
                "‚ò†Ô∏è OPEN WIDE: Keep tongue out for 1 minute.",
                "‚ò†Ô∏è HAIR PULL: He controls your head by your hair.",
                "‚ò†Ô∏è SHOW HISTORY: Show your last 5 google searches.",
                "‚ò†Ô∏è MASSAGE HIM: Give him a full back massage (Topless).",
                "‚ò†Ô∏è GRIND: Sit on his lap and grind for 2 mins.",
                "‚ò†Ô∏è POLE DANCE: Use a doorway/wall to dance for him.",
                "‚ò†Ô∏è BITE: He bites your lip/neck softly.",
                "‚ò†Ô∏è CONFESS: Tell him a secret you've never told."
            ]
        };

        const lipRewards = {
            Him: [ // If HE guesses right (Reward for Him)
                "üèÜ REWARD: She kisses you deeply for 2 mins (French).",
                "üèÜ REWARD: She flashes you immediately.",
                "üèÜ REWARD: You get to squeeze her butt for 1 min.",
                "üèÜ REWARD: She whispers something dirty in your ear.",
                "üèÜ REWARD: 5 Minutes of neck/shoulder massage.",
                "üèÜ REWARD: She grinds on your lap for 2 mins.",
                "üèÜ REWARD: Oral Pleasure (She goes down on you).",
                "üèÜ REWARD: Handjob (With lotion, 5 mins).",
                "üèÜ REWARD: She sits on your face for 2 mins.",
                "üèÜ REWARD: She wears your favorite outfit.",
                "üèÜ REWARD: You pick the position tonight.",
                "üèÜ REWARD: She cooks your favorite meal.",
                "üèÜ REWARD: Full body oil massage from her.",
                "üèÜ REWARD: She calls you 'Daddy/Master' for 1 hour.",
                "üèÜ REWARD: 69 Position for 5 mins.",
                "üèÜ REWARD: She sends a nude photo right now.",
                "üèÜ REWARD: You get to spank her (Playful).",
                "üèÜ REWARD: She lets you bite her neck.",
                "üèÜ REWARD: She scratches your back/head.",
                "üèÜ REWARD: Cuddle session (She holds you).",
                "üèÜ REWARD: No chores for 24 hours.",
                "üèÜ REWARD: She licks your earlobe.",
                "üèÜ REWARD: Free Use Pass (10 Mins).",
                "üèÜ REWARD: She performs a striptease."
            ],
            Her: [ // If SHE guesses right (Reward for Her)
                "üèÜ REWARD: He kisses your neck for 2 mins.",
                "üèÜ REWARD: He gives you a 10-min foot massage.",
                "üèÜ REWARD: You get to bite his lip.",
                "üèÜ REWARD: He whispers 'I love you' sensually.",
                "üèÜ REWARD: He takes off his shirt.",
                "üèÜ REWARD: Oral Pleasure (He goes down on you).",
                "üèÜ REWARD: Full body sensory massage.",
                "üèÜ REWARD: Princess Carry (He carries you to bed).",
                "üèÜ REWARD: He buys you a gift/treat.",
                "üèÜ REWARD: He cooks dinner/orders food.",
                "üèÜ REWARD: He performs a striptease.",
                "üèÜ REWARD: You control the pace in bed.",
                "üèÜ REWARD: Cuddle session (He holds you).",
                "üèÜ REWARD: Neck worship (Kiss/Bite/Lick).",
                "üèÜ REWARD: He plays with your hair for 10 mins.",
                "üèÜ REWARD: Shower together (He washes you).",
                "üèÜ REWARD: Finger play (He uses his hands).",
                "üèÜ REWARD: He licks your inner thigh.",
                "üèÜ REWARD: No chores for 24 hours.",
                "üèÜ REWARD: He calls you 'Queen/Goddess'.",
                "üèÜ REWARD: 69 Position for 5 mins.",
                "üèÜ REWARD: He traces your body with a feather.",
                "üèÜ REWARD: He kisses every inch of your body.",
                "üèÜ REWARD: He lets you check his phone.",
                "üèÜ REWARD: Morning head/coffee in bed."
            ]
        };

        let lipActiveGuesser = 'Him';

        window.initLipGame = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('lip');
            document.getElementById('lip-intro').classList.remove('hidden');
            document.getElementById('lip-game').classList.add('hidden');
            document.getElementById('lip-overlay').classList.add('hidden');
            document.getElementById('lip-overlay').classList.remove('flex');
        };

        window.startLipGame = (guesser) => {
            lipActiveGuesser = guesser;
            document.getElementById('lip-intro').classList.add('hidden');
            document.getElementById('lip-game').classList.remove('hidden');
            document.getElementById('lip-game').classList.add('flex');
            
            window.nextLipPhrase();
        };

        window.nextLipPhrase = () => {
            const phrase = lipPhrases[Math.floor(Math.random() * lipPhrases.length)];
            document.getElementById('lip-phrase').textContent = `"${phrase}"`;
            
            // Animation reset
            const card = document.getElementById('lip-phrase').parentElement;
            card.classList.remove('animate-pulse');
            void card.offsetWidth;
            card.classList.add('animate-pulse');
        };

        window.lipResult = (correct) => {
            const overlay = document.getElementById('lip-overlay');
            const icon = document.getElementById('lip-icon-area');
            const title = document.getElementById('lip-title');
            const typeLabel = document.getElementById('lip-type-label');
            const desc = document.getElementById('lip-desc');
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            if (correct) {
                // WIN
                const list = lipRewards[lipActiveGuesser];
                const r = list[Math.floor(Math.random() * list.length)];
                
                title.textContent = "CORRECT! üéâ";
                title.className = "text-4xl font-black text-green-400 fancy-font mb-4";
                icon.innerHTML = `<i data-lucide="check-circle" class="w-16 h-16 text-green-400"></i>`;
                typeLabel.textContent = "INSTANT REWARD:";
                typeLabel.className = "text-[10px] font-bold uppercase mb-2 text-green-300";
                desc.textContent = r;
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);

            } else {
                // LOSE
                const list = lipPunishments[lipActiveGuesser];
                const p = list[Math.floor(Math.random() * list.length)];
                
                title.textContent = "WRONG! üòà";
                title.className = "text-4xl font-black text-red-500 fancy-font mb-4";
                icon.innerHTML = `<i data-lucide="x-circle" class="w-16 h-16 text-red-500"></i>`;
                typeLabel.textContent = "PUNISHMENT TIME:";
                typeLabel.className = "text-[10px] font-bold uppercase mb-2 text-red-400";
                desc.textContent = p;
                if(navigator.vibrate) navigator.vibrate([500, 100, 500]);
            }
            if(window.lucide) lucide.createIcons();
        };

        // --- RUSSIAN ROULETTE LOGIC (FIXED & EXPANDED) ---

        const roulettePleasures = {
            Him: [ // If HIM survives (Mild/Sexy Tasks)
                "Kiss her neck softly for 10 seconds.",
                "Squeeze her butt once firmly.",
                "Ask her to flash you quickly (Lift shirt/skirt).",
                "Trace her lips with your thumb.",
                "Whisper 'You're safe... for now' in her ear.",
                "Rub her thigh slowly upwards.",
                "Lick her earlobe gently.",
                "Put your hand in her back pocket for 1 minute.",
                "Kiss her hand like a gentleman.",
                "Blow air on her neck to give her chills.",
                "Pull her close by the waist and hold for 10s.",
                "Give her a slow, dry kiss on the lips.",
                "Massage her shoulders for 30 seconds.",
                "Look into her eyes and say 'I own you'.",
                "Bite your lip while looking at her body.",
                "Trace her spine with your fingertips.",
                "Kiss her forehead tenderly.",
                "Rest your hand on her knee for the rest of the round.",
                "Tell her one thing you want to do to her later.",
                "Nip her shoulder gently (No mark)."
            ],
            Her: [ // If HER survives
                "Kiss his jawline.",
                "Run your hand over his bulge (clothes on).",
                "Bite his earlobe gently.",
                "Sit on his lap for 10 seconds.",
                "Whisper a dirty word in his ear.",
                "Trace his abs/chest with your nail.",
                "Lick your lips while looking at him.",
                "Give him a quick peck on the neck.",
                "Play with his hair for 30 seconds.",
                "Grind against him once (standing or sitting).",
                "Put your hand on his chest and feel his heartbeat.",
                "Moan softly in his ear.",
                "Kiss his inner wrist.",
                "Scratch his back lightly.",
                "Wink at him seductively.",
                "Squeeze his bicep.",
                " Whisper 'Daddy' in his ear.",
                "Touch his thigh and move up slightly.",
                "Rest your head on his shoulder.",
                "Kiss the corner of his mouth."
            ]
        };

                // --- UPDATED RUSSIAN ROULETTE DEATHS (DIRTY, SEDUCTIVE & RESPECTFUL) ---

        const rouletteDeaths = {
            Him: [ // 40 Punishments for HIM (Focus: Worship, Stamina, Giving)
                "‚ò†Ô∏è DEAD: Total Worship. Kiss every inch of her body for 5 minutes (No rushing).",
                "‚ò†Ô∏è DEAD: The Carrier. Pick her up and carry her to the bed/couch without breaking the kiss.",
                "‚ò†Ô∏è DEAD: Edging Master. Bring her close to the edge, stop, and do it again (3 times).",
                "‚ò†Ô∏è DEAD: Eye Contact Oral. Go down on her while maintaining intense eye contact.",
                "‚ò†Ô∏è DEAD: Massage King. Give her a sensual oil massage (Shoulders to lower back).",
                "‚ò†Ô∏è DEAD: The Statue. She touches you wherever she wants. You cannot move or touch back.",
                "‚ò†Ô∏è DEAD: Undress Her. Slowly take off her clothes using only your teeth/mouth.",
                "‚ò†Ô∏è DEAD: Whispering Seduction. Spend 2 minutes whispering exactly how much you love her body.",
                "‚ò†Ô∏è DEAD: Ice Play. Trace an ice cube down her spine and neck.",
                "‚ò†Ô∏è DEAD: Blindfolded Service. You wear a blindfold and pleasure her however she guides you.",
                "‚ò†Ô∏è DEAD: Foot Caress. Massage and kiss her feet/ankles lovingly.",
                "‚ò†Ô∏è DEAD: Hair Play. Gently pull her hair back while kissing her neck from behind.",
                "‚ò†Ô∏è DEAD: The Viewer. She touches herself. You must watch but cannot touch.",
                "‚ò†Ô∏è DEAD: Cold Hands. Hold cold water/ice, then run your hands over her warm skin.",
                "‚ò†Ô∏è DEAD: Slow Motion. You must move/thrust in extreme slow motion for 2 minutes.",
                "‚ò†Ô∏è DEAD: Handcuffed (Fake). Put your hands behind your back; she teases you.",
                "‚ò†Ô∏è DEAD: Lap Pillow. Rest your head in her lap while she plays with your hair/face.",
                "‚ò†Ô∏è DEAD: Shirtless. Take off your shirt and let her scratch/trace your back.",
                "‚ò†Ô∏è DEAD: The Pillar. Stand against the wall. She grinds on you. You hold her waist only.",
                "‚ò†Ô∏è DEAD: 100 Kisses. You must plant 100 kisses all over her face and neck.",
                "‚ò†Ô∏è DEAD: Pulse Check. Kiss her inner wrist and hold her hand tight.",
                "‚ò†Ô∏è DEAD: Ear Tease. Nibble and lick her ear until she shivers.",
                "‚ò†Ô∏è DEAD: Leg Worship. Kiss from her ankle up to her thigh slowly.",
                "‚ò†Ô∏è DEAD: Breath Play. Hover your lips over hers/body parts without touching. Just breathe.",
                "‚ò†Ô∏è DEAD: The Grip. Hold her hips firmly and pull her into you.",
                "‚ò†Ô∏è DEAD: Finger Sucking. Sensually suck her fingers one by one.",
                "‚ò†Ô∏è DEAD: Strong Hold. Pin her wrists gently above her head and kiss her.",
                "‚ò†Ô∏è DEAD: Neck Mark. Leave a love bite (hickey) on a spot only you will see.",
                "‚ò†Ô∏è DEAD: Trace the Alphabet. Use your tongue to write 'I WANT YOU' on her stomach.",
                "‚ò†Ô∏è DEAD: The Gentleman. Help her remove her shoes/jewelry slowly and sexy.",
                "‚ò†Ô∏è DEAD: No Hands Kissing. Kiss her deeply with your hands behind your back.",
                "‚ò†Ô∏è DEAD: Aftercare Preview. Cuddle her tight and just hold her for 2 minutes.",
                "‚ò†Ô∏è DEAD: The Throne. She sits on a chair; you kneel and pleasure her.",
                "‚ò†Ô∏è DEAD: Chest Kiss. Kiss her chest/cleavage repeatedly.",
                "‚ò†Ô∏è DEAD: Scent. Bury your face in her neck/hair and inhale deeply.",
                "‚ò†Ô∏è DEAD: The Lift. Lift her against the wall and hold her there while kissing.",
                "‚ò†Ô∏è DEAD: Compliment Shower. Tell her 5 dirty/sexy things you love about her body.",
                "‚ò†Ô∏è DEAD: Tantalizing Touch. Run your fingertips barely touching her skin (Feather touch).",
                "‚ò†Ô∏è DEAD: Inner Thigh. Bury your face in her inner thighs.",
                "‚ò†Ô∏è DEAD: Submission. Let her tie your hands with a tie/scarf."
            ],
            Her: [ // 40 Punishments for HER (Focus: Teasing, Sensation, Allure)
                "‚ò†Ô∏è DEAD: Seductive Dance. Give him a private lap dance (Slow and intense).",
                "‚ò†Ô∏è DEAD: The Empress. Sit on his face/chest (Clothed or not) and grind.",
                "‚ò†Ô∏è DEAD: Body Slide. Use your body to massage his (Nuru style, with or without oil).",
                "‚ò†Ô∏è DEAD: Oral Tease. Kiss around his area but don't touch the main spot for 2 mins.",
                "‚ò†Ô∏è DEAD: Scratch Marks. Lightly scratch his back/chest with your nails.",
                "‚ò†Ô∏è DEAD: Dirty Whisper. Whisper your darkest fantasy in his ear.",
                "‚ò†Ô∏è DEAD: Visual Treat. Pose for him in a position he chooses.",
                "‚ò†Ô∏è DEAD: The Glare. Maintain eye contact while you go down on him.",
                "‚ò†Ô∏è DEAD: Hair Control. Let him grab your hair while you pleasure him.",
                "‚ò†Ô∏è DEAD: Ice Queen. Put an ice cube in your mouth and run it over his body.",
                "‚ò†Ô∏è DEAD: Hands Free. Pleasure him using only your mouth/body (No hands).",
                "‚ò†Ô∏è DEAD: The Ride. Straddle him and grind your hips (No penetration yet).",
                "‚ò†Ô∏è DEAD: Blindfold Him. Tease him while he can't see anything.",
                "‚ò†Ô∏è DEAD: Chest Worship. Lick/Kiss his chest and abs slowly.",
                "‚ò†Ô∏è DEAD: Shower Show. Let him watch you shower (or join you).",
                "‚ò†Ô∏è DEAD: Lingerie Parade. Put on your sexiest outfit/underwear for him.",
                "‚ò†Ô∏è DEAD: Bedside Service. He lies down; you do everything for 5 minutes.",
                "‚ò†Ô∏è DEAD: Kiss Attack. Pin him down and kiss him aggressively.",
                "‚ò†Ô∏è DEAD: Thigh Trap. Squeeze his head/hand between your thighs.",
                "‚ò†Ô∏è DEAD: Ear Licking. Trace his ear with your tongue and moan.",
                "‚ò†Ô∏è DEAD: Nipple Play. Tease his nipples with your tongue/fingers.",
                "‚ò†Ô∏è DEAD: The Crawl. Crawl across the bed towards him like a predator.",
                "‚ò†Ô∏è DEAD: Mirror Play. Watch yourselves in the mirror while you touch him.",
                "‚ò†Ô∏è DEAD: Wet Look. Get your shirt wet (or take it off) and press against him.",
                "‚ò†Ô∏è DEAD: Lip Biting. Bite his lower lip gently while kissing.",
                "‚ò†Ô∏è DEAD: Good Girl. Ask him 'Am I being a good girl?' while pleasuring him.",
                "‚ò†Ô∏è DEAD: Secret Spot. Let him touch you anywhere he wants for 2 mins.",
                "‚ò†Ô∏è DEAD: Panty Tease. Slowly remove your panties and hand them to him.",
                "‚ò†Ô∏è DEAD: Hot Breath. Breathe heavily on his neck without touching.",
                "‚ò†Ô∏è DEAD: The Snake. Wrap your legs around him tight.",
                "‚ò†Ô∏è DEAD: Show & Tell. Touch yourself while explaining what it feels like.",
                "‚ò†Ô∏è DEAD: Hand Guide. Guide his hand to exactly where you want it.",
                "‚ò†Ô∏è DEAD: Vocalize. Moan loud and clear in his ear.",
                "‚ò†Ô∏è DEAD: Back Arch. Arch your back and let him admire your curves.",
                "‚ò†Ô∏è DEAD: Power Switch. Push him onto the bed and climb on top.",
                "‚ò†Ô∏è DEAD: Finger Sucking. Suck his fingers suggestively.",
                "‚ò†Ô∏è DEAD: T-Shirt Takeover. Wear only his T-shirt (and nothing else).",
                "‚ò†Ô∏è DEAD: Skin on Skin. Maximum body contact. No space between you.",
                "‚ò†Ô∏è DEAD: The View. Bend over in front of him (Fully clothed or not).",
                "‚ò†Ô∏è DEAD: Locked In. Wrap your arms and legs around him and don't let go."
            ]
        };


        let bulletChamber = 0;
        let currentChamber = 0;
        let rouletteTurn = 'Him';

        window.initRoulette = () => {
            if (!window.checkLicensingStatus()) return;
            window.showScreen('roulette');
            
            // UI Reset Logic
            document.getElementById('roulette-intro').classList.remove('hidden');
            document.getElementById('roulette-game').classList.add('hidden');
            
            // Hide Overlays
            const safeOverlay = document.getElementById('roulette-safe-overlay');
            const deadOverlay = document.getElementById('roulette-dead-overlay');
            
            safeOverlay.classList.add('hidden');
            safeOverlay.classList.remove('flex');
            
            deadOverlay.classList.add('hidden');
            deadOverlay.classList.remove('flex');

            // Reset Cylinder Rotation for next game
            const cylinder = document.getElementById('cylinder-visual');
            cylinder.style.transition = 'none';
            cylinder.style.transform = 'rotate(0deg)';
            
            // Re-enable trigger just in case
            document.getElementById('btn-trigger').disabled = false;
            document.getElementById('roulette-status').textContent = "Ready to start...";
        };

        window.startRouletteGame = (starter) => {
    rouletteTurn = starter;
    currentChamber = 1;
    
    // UI Reset
    document.getElementById('roulette-intro').classList.add('hidden');
    document.getElementById('roulette-game').classList.remove('hidden');
    document.getElementById('roulette-game').classList.add('flex');
    document.getElementById('btn-trigger').disabled = false;
    document.getElementById('btn-trigger').classList.remove('opacity-50', 'cursor-not-allowed');

    // Visual Reset
    const cylinder = document.getElementById('cylinder-visual');
    cylinder.style.transition = "none";
    cylinder.style.transform = "rotate(0deg)";

    // --- LOGIC SYNC ---
    // Agar Multiplayer hai, toh Host bullet decide karega aur Partner ko bhejega
    if (window.state.isMultiplayer) {
        bulletChamber = Math.floor(Math.random() * 6) + 1;
        sendStateUpdate('ROULETTE_INIT', { 
            starter: starter,
            bullet: bulletChamber 
        });
    } else {
        // Agar Local khel rahe ho (bina internet)
        bulletChamber = Math.floor(Math.random() * 6) + 1;
    }

    window.updateRouletteUI("Ready. Pull the trigger.");
    
    // Intro Animation
    setTimeout(() => {
        cylinder.style.transition = "transform 0.8s cubic-bezier(0.25, 1, 0.5, 1)";
        cylinder.style.transform = "rotate(720deg)";
        setTimeout(() => {
            cylinder.style.transition = "none";
            cylinder.style.transform = "rotate(0deg)";
        }, 800);
    }, 100);
};

// Isko window.startRouletteGame ke neeche paste kar de

window.pullTrigger = () => {
    const btn = document.getElementById('btn-trigger');
    if(btn.disabled) return;

    // Multiplayer Turn Check
    if (window.state.isMultiplayer && window.state.names[rouletteTurn] !== window.state.names[window.state.myRole]) {
         window.showFeedback(`Wait! It's ${window.state.names[rouletteTurn]}'s turn!`, true);
         return;
    }

    btn.disabled = true;
    document.getElementById('roulette-status').textContent = "Click...";
    
    // Animation
    const cylinder = document.getElementById('cylinder-visual');
    const rotation = currentChamber * 60; 
    cylinder.style.transition = "transform 0.2s ease-out";
    cylinder.style.transform = `rotate(${rotation}deg)`;
    
    if(navigator.vibrate) navigator.vibrate(50);

    setTimeout(() => {
        // Result Logic
        let result = 'SAFE';
        let task = '';

        if (currentChamber === bulletChamber) {
            // --- BANG ---
            result = 'BANG';
            const list = rouletteDeaths[rouletteTurn];
            task = list[Math.floor(Math.random() * list.length)];
            
            // Vault Logic (Only Trigger Puller Saves)
            const winner = rouletteTurn === 'Him' ? window.state.names.Her : window.state.names.Him;
            const loser = window.state.names[rouletteTurn];
            const deal = {
                id: Date.now(), title: "Fatal Gunshot", desc: `Lost at Roulette: ${task}`,
                winner: winner, loser: loser, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), status: "Enforced"
            };
            if(window.savedVault) {
                savedVault.unshift(deal);
                localStorage.setItem('contractVault', JSON.stringify(savedVault));
            }

        } else {
            // --- SAFE ---
            const list = roulettePleasures[rouletteTurn];
            task = list[Math.floor(Math.random() * list.length)];
        }

        // Increment Chamber
        currentChamber++;

        // Send to Partner
        if (window.state.isMultiplayer) {
            sendStateUpdate('ROULETTE_TRIGGER', { 
                result: result, 
                task: task, 
                chamber: currentChamber 
            });
        }

        // Local UI Show
        if (result === 'BANG') window.handleRouletteDeath(task);
        else window.handleRouletteSafe(task);

    }, 600);
};

// Isko window.pullTrigger ke khatam hone ke baad paste karna

window.nextRouletteTurn = (isRemote = false) => {
    // Agar maine button dabaya (Remote nahi hai)
    if (!isRemote) {
        // Logic: Turn badlo
        rouletteTurn = rouletteTurn === 'Him' ? 'Her' : 'Him';
        
        // Partner ko batao ki turn change ho gayi aur count kya hai
        if (window.state.isMultiplayer) {
            sendStateUpdate('ROULETTE_NEXT', { 
                turn: rouletteTurn, 
                nextChamber: currentChamber 
            });
        }
    }
    
    // UI Reset (Dono ke liye)
    const overlay = document.getElementById('roulette-safe-overlay');
    overlay.classList.add('hidden');
    overlay.classList.remove('flex');
    
    // Button wapas enable karo
    document.getElementById('btn-trigger').disabled = false;
    
    // UI Update karo
    window.updateRouletteUI("Turn passed. Next player ready.");
};



        window.updateRouletteUI = (status) => {
            const name = rouletteTurn === 'Him' ? window.state.names.Him : window.state.names.Her;
            const color = rouletteTurn === 'Him' ? 'text-blue-400' : 'text-pink-400';
            
            const turnText = document.getElementById('roulette-turn');
            turnText.textContent = name;
            turnText.className = `text-3xl font-black fancy-font ${color}`;
            
            document.getElementById('shots-left').textContent = `${7 - currentChamber} Left`;
            if(status) document.getElementById('roulette-status').textContent = status;
        };

        // --- MISSING FUNCTIONS START (Paste this at the bottom of script) ---

window.handleRouletteSafe = (taskText) => {
    document.getElementById('roulette-safe-task').textContent = taskText;
    const overlay = document.getElementById('roulette-safe-overlay');
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    if(navigator.vibrate) navigator.vibrate([50, 50]);
};

window.handleRouletteDeath = (taskText) => {
    document.getElementById('roulette-death-task').textContent = taskText;
    const overlay = document.getElementById('roulette-dead-overlay');
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    if(navigator.vibrate) navigator.vibrate([1000]);
};

// --- MISSING FUNCTIONS END ---

// --- CHAT & STATUS FUNCTIONS ---

// 1. CHAT TOGGLE (Open/Close)
window.toggleChat = () => {
    const chatBox = document.getElementById('game-chat-box');
    const badge = document.getElementById('chat-badge');
    
    if (chatBox.classList.contains('hidden')) {
        chatBox.classList.remove('hidden');
        // Animation
        setTimeout(() => {
            chatBox.classList.remove('opacity-0', 'scale-95');
        }, 10);
        badge.classList.add('hidden'); // Message padh liya, badge hatao
        
        // Auto focus input
        document.getElementById('chat-input').focus();
    } else {
        chatBox.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            chatBox.classList.add('hidden');
        }, 300);
    }
};

// 2. SEND MESSAGE
window.sendChatMessage = () => {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;

    // Local Display (Right side)
    appendMessage(text, 'me');

    // Send to Partner
    if (window.state.isMultiplayer) {
        sendStateUpdate('CHAT_MSG', { text: text });
    }

    input.value = '';
};

// Enter key se send karo
document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') window.sendChatMessage();
});

// 3. DISPLAY MESSAGE HELPER
function appendMessage(text, sender) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    
    if (sender === 'me') {
        div.className = "flex justify-end";
        div.innerHTML = `<div class="bg-pink-600 text-white px-3 py-2 rounded-l-lg rounded-tr-lg max-w-[80%]">${text}</div>`;
    } else {
        div.className = "flex justify-start";
        div.innerHTML = `<div class="bg-white/20 text-white px-3 py-2 rounded-r-lg rounded-tl-lg max-w-[80%]">${text}</div>`;
    }
    
    container.appendChild(div);
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// ==========================================
// üõ†Ô∏è FINAL WORKING CODE (Paste at Bottom)
// ==========================================

// 1. TERI IMAGES KI LIST
const imageFilenames = [
    "Satyr", "Niagara falls", "Rocket", "Tight pussy", "Relaxation",
    "Gimlet", "Pinwheel", "Loop", "Slope", "Funny joke",
    "Harp", "Tea bag", "Exciting game", "Ladies' man", "Juicy ass",
    "New 69 on the chair", "Stickman", "Catapult", "Licking master", "Descent",
    "Bounce", "Apex", "Chill", "Hot carl", "Snake charmer",
    "Twerk on dick", "Ghetto", "Doggy on the edge - 2", "Tantra chair", "Crazy doggy",
    "Pearl", "Aura", "Curiosity", "Khaleesi", "Insatiable clitoris",
    "Breeze", "Weird fantasy", "Crazy monkey", "Buffet", "Houdini",
    "Tea bag - 2", "Dream", "Donkey punch", "Venus flytrap", "Wheelbarrow - 3", 
    "Special fallatio", "Crazy train", "Pussy licking", "Woven root", "Fireman"
];

// 2. MAIN FUNCTION (Working)
window.initScratch = () => {
    // Error Proofing
    try {
        if (window.checkLicensingStatus && !window.checkLicensingStatus()) return;

        // Image select karo
        const randomName = imageFilenames[Math.floor(Math.random() * imageFilenames.length)];
        
        // Simple file path banana (No confusion)
        const imagePath = randomName + ".jpg"; 

        console.log("Loading Image:", imagePath);

        // HTML Elements dhoondho
        const resultLayer = document.getElementById('scratch-result-layer');
        const titleEl = document.getElementById('scratch-title');
        const descEl = document.getElementById('scratch-desc');
        const canvas = document.getElementById('scratch-canvas');

        // Loading text dikhao taaki pata chale process chal raha hai
        if(titleEl) titleEl.textContent = "Loading: " + randomName + "...";

        // Image Load karo
        const imgLoader = new Image();
        imgLoader.src = imagePath;

        imgLoader.onload = () => {
            window.showScreen('scratch'); // Screen dikhao
            
            // Text Set karo
            if(titleEl) titleEl.textContent = randomName;
            if(descEl) descEl.textContent = "Scratch to reveal the position...";

            // Background Image Set karo
            if(resultLayer) {
                resultLayer.style.backgroundImage = "url('" + imagePath + "')";
                resultLayer.style.backgroundSize = "contain";
                resultLayer.style.backgroundRepeat = "no-repeat";
                resultLayer.style.backgroundPosition = "center";
            }

            // Canvas (Silver Layer) wapis banao
            if(typeof setupCanvas === 'function') {
                setupCanvas(canvas);
            }
        };

        imgLoader.onerror = () => {
            console.error("Image Fail:", imagePath);
            alert("‚ùå ERROR: Photo nahi mili!\n\nCode dhoondh raha hai: " + imagePath + "\n\n1. Check kar GitHub pe photo ka naam same hai?\n2. Kya extension .jpg hi hai? (.png toh nahi?)");
            window.showScreen('scratch');
        };

    } catch(e) {
        alert("Code mein error aa gaya: " + e.message);
    }
};

// Canvas Setup (Zaroori hai)
function setupCanvas(canvas) {
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    // Silver Paint
    ctx.fillStyle = '#C0C0C0'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Text
    ctx.fillStyle = '#333';
    ctx.font = 'bold 20px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText("Scratch Me!", canvas.width/2, canvas.height/2);

    // Scratch Logic
    let isDrawing = false;
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - r.left, y: clientY - r.top };
    };
    const scratch = (e) => {
        if (!isDrawing) return;
        if(e.type === 'touchmove') e.preventDefault();
        const pos = getPos(e);
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 25, 0, Math.PI * 2);
        ctx.fill();
    };
    
    // Touch & Mouse Events
    canvas.onmousedown = (e) => { isDrawing = true; scratch(e); };
    canvas.onmousemove = scratch;
    canvas.onmouseup = () => { isDrawing = false; };
    canvas.ontouchstart = (e) => { isDrawing = true; scratch(e); };
    canvas.ontouchmove = scratch;
    canvas.ontouchend = () => { isDrawing = false; };
}

    </script>
<div id="partner-status" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-black/80 border border-pink-500/50 text-white px-4 py-2 rounded-full text-xs font-bold shadow-[0_0_15px_rgba(236,72,153,0.3)] hidden z-50 flex items-center gap-2">
    <span class="relative flex h-2 w-2">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
    </span>
    <span id="partner-status-text">Partner Connected</span>
</div>

<button id="chat-toggle-btn" onclick="toggleChat()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-pink-600 to-purple-700 rounded-full shadow-[0_0_20px_rgba(236,72,153,0.6)] flex items-center justify-center z-50 hidden transition-transform active:scale-95">
    <i data-lucide="message-circle" class="text-white w-7 h-7"></i>
    <span id="chat-badge" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-[#1a0505] hidden"></span>
</button>

<div id="game-chat-box" class="fixed bottom-24 right-6 w-72 h-80 bg-black/90 border border-white/20 backdrop-blur-md rounded-2xl flex flex-col shadow-2xl z-50 hidden transform transition-all duration-300 origin-bottom-right scale-95 opacity-0">
    <div class="p-3 border-b border-white/10 flex justify-between items-center bg-white/5 rounded-t-2xl">
        <h4 class="text-white font-bold text-sm flex items-center gap-2">
            <i data-lucide="message-square" class="w-4 h-4 text-pink-400"></i> Game Chat
        </h4>
        <button onclick="toggleChat()" class="text-white/50 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
    
    <div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 text-xs scrollbar-hide">
        <div class="text-center text-white/30 italic">Start chatting...</div>
    </div>

    <div class="p-2 border-t border-white/10 flex gap-2">
        <input type="text" id="chat-input" placeholder="Type here..." class="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-xs focus:outline-none focus:border-pink-500">
        <button onclick="sendChatMessage()" class="bg-pink-600 p-2 rounded-lg text-white hover:bg-pink-700 transition">
            <i data-lucide="send" class="w-4 h-4"></i>
        </button>
    </div>
</div>

<style>
    /* Chat Scrollbar Hide */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>

</body>

</html>


